<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - KPU Monasmuda Institute</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/database_integration.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Top Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-2">
                    <img src="kandidat/kpulogo.jpg" alt="KPU Monasmuda Institute" class="w-8 h-8 rounded-lg object-cover border border-red-200" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="w-8 h-8 bg-red-600 rounded-lg flex items-center justify-center" style="display: none;">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <span class="text-xl font-semibold text-gray-900">Admin Panel - KPU Monasmuda Institute</span>
                    <div id="realtimeIndicator" class="flex items-center space-x-1 ml-4">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-xs text-green-600 font-medium">REALTIME</span>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <p class="text-sm font-medium text-gray-900">Administrator</p>
                        <p class="text-xs text-gray-500">Super Admin</p>
                    </div>
                    <button onclick="adminLogout()" class="text-red-600 hover:text-red-700 font-medium transition-colors">Keluar</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Dashboard Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Pemilih</p>
                        <p id="total-voters" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Suara Masuk</p>
                        <p id="total-votes" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Partisipasi</p>
                        <p id="participation-rate" class="text-2xl font-bold text-gray-900">0%</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Kandidat</p>
                        <p id="total-candidates" class="text-2xl font-bold text-gray-900">8</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-time Results -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-900">Hasil Pemilihan Real-time</h2>
                    <div id="realtimeIndicator" class="flex items-center space-x-2 px-3 py-1 bg-gray-100 rounded-full">
                        <div class="w-2 h-2 bg-orange-500 rounded-full"></div>
                        <span class="text-xs text-orange-600 font-medium">LOADING...</span>
                    </div>
                </div>
            </div>
            <div class="p-6">
                <!-- Presiden & Wakil Presiden -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Presiden & Wakil Presiden</h3>
                        <div class="flex gap-2">
                            <button onclick="manageCandidatePhotos('presiden')" class="text-blue-600 hover:text-blue-800 text-sm">üì∑ Kelola Foto</button>
                            <button onclick="manageCandidateNames('presiden')" class="text-green-600 hover:text-green-800 text-sm">‚úèÔ∏è Edit Nama</button>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <img id="presiden1-photo" src="kandidat/kpulogo.jpg" alt="Ahmad Rizki" class="w-12 h-12 rounded-full object-cover border-2 border-red-200" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center" style="display: none;">
                                        <span class="text-red-600 font-semibold">01</span>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900" id="presiden1-name">NENENG & INAYAH</h4>
                                    <p class="text-sm text-gray-500">Pasangan 01</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <div class="w-48 bg-gray-200 rounded-full h-3">
                                    <div id="presiden1-bar" class="bg-red-600 h-3 rounded-full" style="width: 0%"></div>
                                </div>
                                <div class="text-right">
                                    <p id="presiden1-votes" class="font-semibold text-gray-900">0 suara</p>
                                    <p id="presiden1-percentage" class="text-sm text-gray-500">0%</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <img id="presiden2-photo" src="kandidat/kpulogo.jpg" alt="Budi Santoso" class="w-12 h-12 rounded-full object-cover border-2 border-blue-200" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center" style="display: none;">
                                        <span class="text-blue-600 font-semibold">02</span>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900" id="presiden2-name">AISYAH & EVI</h4>
                                    <p class="text-sm text-gray-500">Pasangan 02</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <div class="w-48 bg-gray-200 rounded-full h-3">
                                    <div id="presiden2-bar" class="bg-blue-600 h-3 rounded-full" style="width: 0%"></div>
                                </div>
                                <div class="text-right">
                                    <p id="presiden2-votes" class="font-semibold text-gray-900">0 suara</p>
                                    <p id="presiden2-percentage" class="text-sm text-gray-500">0%</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Perdana Menteri -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Perdana Menteri</h3>
                        <div class="flex gap-2">
                            <button onclick="manageCandidatePhotos('pm')" class="text-blue-600 hover:text-blue-800 text-sm">üì∑ Kelola Foto</button>
                            <button onclick="manageCandidateNames('pm')" class="text-green-600 hover:text-green-800 text-sm">‚úèÔ∏è Edit Nama</button>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <img id="pm1-photo" src="kandidat/kpulogo.jpg" alt="Dr. Andi Wijaya" class="w-12 h-12 rounded-full object-cover border-2 border-green-200" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center" style="display: none;">
                                        <span class="text-green-600 font-semibold">AW</span>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900" id="pm1-name">KUKUH</h4>
                                    <p class="text-sm text-gray-500">Kandidat PM 01</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <div class="w-48 bg-gray-200 rounded-full h-3">
                                    <div id="pm1-bar" class="bg-green-600 h-3 rounded-full" style="width: 0%"></div>
                                </div>
                                <div class="text-right">
                                    <p id="pm1-votes" class="font-semibold text-gray-900">0 suara</p>
                                    <p id="pm1-percentage" class="text-sm text-gray-500">0%</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <img id="pm2-photo" src="kandidat/kpulogo.jpg" alt="Prof. Lisa Sari" class="w-12 h-12 rounded-full object-cover border-2 border-teal-200" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="w-12 h-12 bg-teal-100 rounded-full flex items-center justify-center" style="display: none;">
                                        <span class="text-teal-600 font-semibold">LS</span>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900" id="pm2-name">SAYYIDAH</h4>
                                    <p class="text-sm text-gray-500">Kandidat PM 02</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <div class="w-48 bg-gray-200 rounded-full h-3">
                                    <div id="pm2-bar" class="bg-teal-600 h-3 rounded-full" style="width: 0%"></div>
                                </div>
                                <div class="text-right">
                                    <p id="pm2-votes" class="font-semibold text-gray-900">0 suara</p>
                                    <p id="pm2-percentage" class="text-sm text-gray-500">0%</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ketua Parlemen -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Ketua Parlemen</h3>
                        <div class="flex gap-2">
                            <button onclick="manageCandidatePhotos('parlemen')" class="text-blue-600 hover:text-blue-800 text-sm">üì∑ Kelola Foto</button>
                            <button onclick="manageCandidateNames('parlemen')" class="text-green-600 hover:text-green-800 text-sm">‚úèÔ∏è Edit Nama</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="relative">
                                    <img id="parlemen1-photo" src="kandidat/kpulogo.jpg" alt="Rudi Hartono" class="w-10 h-10 rounded-full object-cover border-2 border-purple-200" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center" style="display: none;">
                                        <span class="text-purple-600 font-semibold text-sm">RH</span>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900 text-sm" id="parlemen1-name">ADINUR KHOLIFAH</h4>
                                    <p class="text-xs text-gray-500">KP 01</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p id="parlemen1-votes" class="font-semibold text-gray-900 text-sm">0 suara</p>
                                <p id="parlemen1-percentage" class="text-xs text-gray-500">0%</p>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="relative">
                                    <img id="parlemen2-photo" src="kandidat/kpulogo.jpg" alt="Nina Kusuma" class="w-10 h-10 rounded-full object-cover border-2 border-indigo-200" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center" style="display: none;">
                                        <span class="text-indigo-600 font-semibold text-sm">NK</span>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900 text-sm" id="parlemen2-name">ENI FATMAWATI</h4>
                                    <p class="text-xs text-gray-500">KP 02</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p id="parlemen2-votes" class="font-semibold text-gray-900 text-sm">0 suara</p>
                                <p id="parlemen2-percentage" class="text-xs text-gray-500">0%</p>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="relative">
                                    <img id="parlemen3-photo" src="kandidat/kpulogo.jpg" alt="Dedi Prasetyo" class="w-10 h-10 rounded-full object-cover border-2 border-pink-200" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center" style="display: none;">
                                        <span class="text-pink-600 font-semibold text-sm">DP</span>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900 text-sm" id="parlemen3-name">FAIZAH MAULIDA</h4>
                                    <p class="text-xs text-gray-500">KP 03</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p id="parlemen3-votes" class="font-semibold text-gray-900 text-sm">0 suara</p>
                                <p id="parlemen3-percentage" class="text-xs text-gray-500">0%</p>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="relative">
                                    <img id="parlemen4-photo" src="kandidat/kpulogo.jpg" alt="Sinta Dewi" class="w-10 h-10 rounded-full object-cover border-2 border-orange-200" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center" style="display: none;">
                                        <span class="text-orange-600 font-semibold text-sm">SD</span>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900 text-sm" id="parlemen4-name">AHMAD NASHUKA</h4>
                                    <p class="text-xs text-gray-500">KP 04</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p id="parlemen4-votes" class="font-semibold text-gray-900 text-sm">0 suara</p>
                                <p id="parlemen4-percentage" class="text-xs text-gray-500">0%</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Controls -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Election Management -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900">Manajemen Pemilihan</h2>
                </div>
                <div class="p-6 space-y-4">
                    <button onclick="startElection()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path>
                        </svg>
                        Mulai Pemilihan
                    </button>
                    <button onclick="stopElection()" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-3 px-4 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"></path>
                        </svg>
                        Reset ke Belum Dimulai
                    </button>
                    <button onclick="endElection()" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"></path>
                        </svg>
                        Akhiri Pemilihan
                    </button>
                    <button onclick="exportResults()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Export Hasil
                    </button>
                </div>
            </div>

            <!-- User Management -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900">Manajemen Pengguna</h2>
                </div>
                <div class="p-6 space-y-4">
                    <button onclick="showVotersList()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Lihat Daftar Pemilih
                    </button>
                    <button onclick="verifyUsers()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 px-4 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        Verifikasi Pengguna
                    </button>
                    <button onclick="resetPasswords()" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-3 px-4 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                        </svg>
                        Reset Password
                    </button>
                    <button onclick="showAuditLog()" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-3 px-4 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        Audit Log
                    </button>
                </div>
            </div>
        </div>

        <!-- User Management Table -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-8">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-900">Manajemen User & Password</h2>
                <button onclick="addNewUser()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                    + Tambah User
                </button>
            </div>
            <div class="p-6">
                <!-- Enhanced Add User Form -->
                <div id="addUserForm" class="hidden mb-6 p-6 bg-gradient-to-r from-blue-50 to-green-50 rounded-lg border-2 border-blue-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">‚ûï Tambah User Baru</h3>
                    <form id="newUserForm" onsubmit="saveNewUser(event)">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ID User</label>
                                <input type="text" id="newUserId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Auto-generate jika kosong">
                                <p class="text-xs text-gray-500 mt-1">Format: 3 digit angka (001, 002, dst)</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap *</label>
                                <input type="text" id="newUserName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="John Doe" required>
                                <p class="text-xs text-gray-500 mt-1">Nama lengkap pemilih</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Username *</label>
                                <input type="text" id="newUsername" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="john.doe" required>
                                <p class="text-xs text-gray-500 mt-1">Harus unik, format: nama.belakang</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Password *</label>
                                <div class="relative">
                                    <input type="text" id="newPassword" class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="password123" required>
                                    <button type="button" onclick="generatePassword()" class="absolute right-2 top-2 text-blue-600 hover:text-blue-800 text-sm font-bold" title="Generate Random Password">üé≤</button>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Password tidak di-mask untuk kemudahan admin</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Suara</label>
                                <input type="number" id="newVoteCount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="20" min="1" max="100" value="20">
                                <p class="text-xs text-gray-500 mt-1">Default: 20 suara per kategori</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status Verifikasi</label>
                                <select id="newUserVerified" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="false">‚ùå Belum Diverifikasi</option>
                                    <option value="true">‚úÖ Sudah Diverifikasi</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Status verifikasi awal</p>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex flex-wrap gap-3 mt-6 pt-4 border-t border-gray-200">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center">
                                ‚ûï Simpan User
                            </button>
                            <button type="button" onclick="clearAddUserForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200">
                                üîÑ Reset Form
                            </button>
                            <button type="button" onclick="generateSampleUser()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200">
                                üé≤ Generate Sample
                            </button>
                            <button type="button" onclick="cancelAddUser()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200">
                                ‚ùå Batal
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Users Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Lengkap</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Password</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah Suara</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status Voting</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status Verifikasi</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be loaded dynamically -->
                        </tbody>
                    </table>
                </div>

                <!-- Bulk Input Table -->
                <div class="mt-6 p-6 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg border-2 border-green-200">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">üìä Input Bulk Users (Copy-Paste dari Excel)</h4>

                    <!-- Instructions -->
                    <div class="mb-4 p-4 bg-blue-100 rounded-lg border border-blue-300">
                        <h5 class="font-medium text-blue-900 mb-2">üìã Cara Penggunaan:</h5>
                        <ol class="text-sm text-blue-800 space-y-1">
                            <li>1. Siapkan data di Excel dengan kolom: <strong>Nama | Username | Password | Jumlah Suara</strong></li>
                            <li>2. Copy data dari Excel (tanpa header) - Select cells lalu Ctrl+C</li>
                            <li>3. Klik tombol "üìã Paste dari Excel" atau klik cell pertama lalu Ctrl+V</li>
                            <li>4. Data akan otomatis muncul per baris di tabel</li>
                            <li>5. Edit data jika diperlukan</li>
                            <li>6. Klik "üíæ Simpan Semua Users" untuk menyimpan ke database</li>
                        </ol>
                        <div class="mt-2 p-2 bg-yellow-100 rounded text-xs text-yellow-800">
                            üí° <strong>Tips:</strong> Jika paste tidak bekerja, gunakan tombol "üìã Paste dari Excel" atau coba "üé≤ Generate Sample Data" untuk test.
                        </div>
                    </div>

                    <!-- Editable Table -->
                    <div class="overflow-x-auto mb-4">
                        <table id="bulkInputTable" class="min-w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-300 px-3 py-2 text-left font-medium text-gray-700">No</th>
                                    <th class="border border-gray-300 px-3 py-2 text-left font-medium text-gray-700">Nama Lengkap *</th>
                                    <th class="border border-gray-300 px-3 py-2 text-left font-medium text-gray-700">Username *</th>
                                    <th class="border border-gray-300 px-3 py-2 text-left font-medium text-gray-700">Password *</th>
                                    <th class="border border-gray-300 px-3 py-2 text-left font-medium text-gray-700">Jumlah Suara</th>
                                    <th class="border border-gray-300 px-3 py-2 text-left font-medium text-gray-700">Verified</th>
                                    <th class="border border-gray-300 px-3 py-2 text-left font-medium text-gray-700">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="bulkInputTableBody">
                                <!-- Rows will be generated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Table Controls -->
                    <div class="flex flex-wrap gap-3 mb-4">
                        <button onclick="addBulkInputRow()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                            ‚ûï Tambah Baris
                        </button>
                        <button onclick="pasteFromClipboard()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                            üìã Paste dari Excel
                        </button>
                        <button onclick="clearBulkInputTable()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                            üóëÔ∏è Clear Tabel
                        </button>
                        <button onclick="generateSampleBulkData()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                            üé≤ Generate Sample Data
                        </button>
                        <button onclick="saveBulkUsers()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200">
                            üíæ Simpan Semua Users
                        </button>
                    </div>

                    <!-- Status Display -->
                    <div id="bulkInputStatus" class="text-sm text-gray-600 p-3 bg-gray-50 rounded-lg border">
                        Ready untuk input data. Gunakan tombol "üìã Paste dari Excel" atau klik cell pertama lalu Ctrl+V.
                    </div>

                    <!-- Sample Data Display -->
                    <div class="mt-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                        <h6 class="font-medium text-yellow-900 mb-2">üìã Contoh Format Excel:</h6>
                        <div class="text-xs text-yellow-800 font-mono bg-white p-2 rounded border">
                            Andi Wijaya&nbsp;&nbsp;&nbsp;&nbsp;andi.wijaya&nbsp;&nbsp;&nbsp;&nbsp;pass123&nbsp;&nbsp;&nbsp;&nbsp;25<br>
                            Sari Dewi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sari.dewi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass456&nbsp;&nbsp;&nbsp;&nbsp;20<br>
                            Budi Santoso&nbsp;&nbsp;&nbsp;budi.santoso&nbsp;&nbsp;&nbsp;pass789&nbsp;&nbsp;&nbsp;&nbsp;30
                        </div>
                        <p class="text-xs text-yellow-700 mt-1">Copy format di atas ke Excel, lalu copy-paste ke tabel admin.</p>
                    </div>
                </div>

                <!-- Bulk Actions -->
                <div class="mt-6 flex flex-wrap gap-4">
                    <button onclick="downloadTemplate()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        üì• Download Template
                    </button>
                    <button onclick="exportUsers()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        üì§ Export ke Excel
                    </button>
                    <button onclick="importUsers()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        üì• Import dari Excel
                    </button>
                    <button onclick="resetAllPasswords()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        üîë Reset Semua Password
                    </button>
                    <button onclick="clearAllVotes()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        üó≥Ô∏è Reset Semua Suara
                    </button>
                    <button onclick="deleteAllUsers()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        üóëÔ∏è Hapus Semua User
                    </button>
                    <button onclick="showSyncDataModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        üîÑ Sync Data Manual
                    </button>
                    <button onclick="resetAllData()" class="bg-red-800 hover:bg-red-900 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 border-2 border-red-600">
                        üîÑ RESET SEMUA DATA (DEBUG)
                    </button>
                </div>
            </div>
        </div>

        <!-- Detailed Voting Data -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 mt-8">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-900">Data Suara Detail</h2>
                <button onclick="refreshVotingData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                    üîÑ Refresh Data
                </button>
            </div>
            <div class="p-6">
                <div id="votingDataContainer">
                    <!-- Voting data will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 mt-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">Aktivitas Terbaru</h2>
            </div>
            <div class="p-6">
                <div id="recentActivityContainer" class="space-y-4">
                    <!-- Recent activity will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Sync Data Modal -->
    <div id="syncDataModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">üîÑ Manual Data Sync</h3>
                    <button onclick="closeSyncDataModal()" class="text-gray-400 hover:text-gray-600">
                        <span class="sr-only">Close</span>
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="mb-6">
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <h4 class="text-sm font-medium text-yellow-800 mb-2">‚ö†Ô∏è Penting: Pilih Arah Sync</h4>
                        <p class="text-sm text-yellow-700">
                            Auto-sync dapat menyebabkan kebingungan data. Pilih manual sync untuk kontrol penuh:
                        </p>
                    </div>

                    <div id="syncDataInfo" class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h5 class="font-medium text-blue-800 mb-2">üì± Data Lokal (localStorage)</h5>
                            <div id="localDataInfo" class="text-sm text-blue-700">
                                <div>Users: <span id="localUsersCount">-</span></div>
                                <div>Votes: <span id="localVotesCount">-</span></div>
                                <div>Status: <span id="localStatus">-</span></div>
                            </div>
                        </div>

                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h5 class="font-medium text-green-800 mb-2">üåê Data Cloud (Database)</h5>
                            <div id="cloudDataInfo" class="text-sm text-green-700">
                                <div>Users: <span id="cloudUsersCount">-</span></div>
                                <div>Votes: <span id="cloudVotesCount">-</span></div>
                                <div>Status: <span id="cloudStatus">-</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col gap-3">
                    <button onclick="syncLocalToCloud()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center">
                        <span class="mr-2">üì§</span>
                        Sync Local ‚Üí Cloud (FORCE OVERWRITE - Hapus Cloud, Upload Local)
                    </button>

                    <button onclick="syncCloudToLocal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center">
                        <span class="mr-2">üì•</span>
                        Sync Cloud ‚Üí Local (FORCE OVERWRITE - Hapus Local, Download Cloud)
                    </button>

                    <button onclick="closeSyncDataModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        Batal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DEPRECATED: Old DOMContentLoaded - replaced by enhanced version below
        // This is kept for compatibility but not used

        // Session management
        const SESSION_KEY = 'admin_session';

        function checkAdminSession() {
            const session = localStorage.getItem(SESSION_KEY);
            if (!session) return false;

            try {
                const sessionData = JSON.parse(session);
                const now = new Date().getTime();

                if (now >= sessionData.expiresAt) {
                    // Session expired
                    localStorage.removeItem(SESSION_KEY);
                    return false;
                }

                // Update admin info in UI
                updateAdminInfo(sessionData);
                return true;
            } catch (error) {
                localStorage.removeItem(SESSION_KEY);
                return false;
            }
        }

        function updateAdminInfo(sessionData) {
            // Update admin name and role in header
            const adminNameElement = document.querySelector('.text-sm.font-medium.text-gray-900');
            const adminRoleElement = document.querySelector('.text-xs.text-gray-500');

            if (adminNameElement) adminNameElement.textContent = sessionData.name;
            if (adminRoleElement) adminRoleElement.textContent = sessionData.role;
        }

        function adminLogout() {
            if (confirm('Apakah Anda yakin ingin keluar dari admin panel?')) {
                localStorage.removeItem(SESSION_KEY);
                alert('Logout berhasil!');
                window.location.href = 'admin-login.html';
            }
        }

        // Data Storage System
        const STORAGE_KEYS = {
            USERS: 'kpu_users',
            VOTES: 'kpu_votes',
            STATS: 'kpu_stats'
        };

        // Initialize data storage
        function initializeStorage() {
            // üîí ENSURE ELECTION STATUS IS PROPERLY SET
            if (!localStorage.getItem('election_status')) {
                localStorage.setItem('election_status', 'stopped');
                console.log('üîÑ Election status initialized to: stopped');
            }

            if (!localStorage.getItem(STORAGE_KEYS.USERS)) {
                const defaultUsers = [
                    {
                        id: '001',
                        name: 'John Doe',
                        username: 'john.doe',
                        password: 'password123',
                        voteCount: 15,
                        status: 'Belum Voting',
                        verified: false, // üîí Default unverified
                        registeredAt: new Date().toISOString(),
                        lastLogin: null
                    },
                    {
                        id: '002',
                        name: 'Jane Smith',
                        username: 'jane.smith',
                        password: 'mypass456',
                        voteCount: 25,
                        status: 'Belum Voting',
                        verified: false, // üîí Default unverified
                        registeredAt: new Date().toISOString(),
                        lastLogin: null
                    },
                    {
                        id: '003',
                        name: 'Ahmad Rahman',
                        username: 'ahmad.rahman',
                        password: 'secure789',
                        voteCount: 10,
                        status: 'Belum Voting',
                        verified: false, // üîí Default unverified
                        registeredAt: new Date().toISOString(),
                        lastLogin: null
                    }
                ];
                localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(defaultUsers));
            }

            if (!localStorage.getItem(STORAGE_KEYS.VOTES)) {
                localStorage.setItem(STORAGE_KEYS.VOTES, JSON.stringify([]));
            }

            if (!localStorage.getItem(STORAGE_KEYS.STATS)) {
                const defaultStats = {
                    totalVoters: 0,
                    votesReceived: 0,
                    participation: 0,
                    candidates: 3,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEYS.STATS, JSON.stringify(defaultStats));
            }
        }

        // Get data from storage
        function getUsers() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS) || '[]');
        }

        function getVotes() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.VOTES) || '[]');
        }

        function getStats() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.STATS) || '{}');
        }

        // Save data to storage and sync to database
        async function saveUsers(users) {
            localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));

            // Sync to database using proper integration
            if (isAdminOnline && window.kpuDB) {
                try {
                    console.log('üîÑ Syncing users to database...');
                    for (const user of users) {
                        try {
                            await window.kpuDB.updateUser(user.id, {
                                name: user.name,
                                username: user.username,
                                password: user.password,
                                vote_count: user.vote_count || user.voteCount || 20,
                                verified: user.verified || false
                            });
                            console.log(`‚úÖ User ${user.username} synced to database`);
                        } catch (error) {
                            console.error(`‚ùå Failed to sync user ${user.username}:`, error);
                        }
                    }
                    console.log('‚úÖ All users synced to database');
                } catch (error) {
                    console.error('‚ùå Error syncing users to database:', error);
                }
            } else {
                console.log('üì± Users saved to localStorage (database offline)');
            }

            updateStatistics();
        }

        function saveVotes(votes) {
            localStorage.setItem(STORAGE_KEYS.VOTES, JSON.stringify(votes));
            updateStatistics();
        }

        // Update statistics
        function updateStatistics() {
            const users = getUsers();
            const votes = getVotes();

            const totalVoters = users.length;
            const verifiedUsers = users.filter(user => user.verified === true).length;
            const votesReceived = users.filter(user => user.status === 'Sudah Voting').length;
            const participation = totalVoters > 0 ? (votesReceived / totalVoters * 100).toFixed(1) : 0;

            const stats = {
                totalVoters,
                verifiedUsers,
                votesReceived,
                participation,
                candidates: 3,
                lastUpdated: new Date().toISOString()
            };

            localStorage.setItem(STORAGE_KEYS.STATS, JSON.stringify(stats));
            updateDashboardStats(stats);
        }

        // Update dashboard statistics display
        function updateDashboardStats(stats) {
            // Update the stats cards with more specific selectors
            try {
                // Total Pemilih
                const totalVotersElement = document.querySelector('.bg-blue-100').closest('.bg-white').querySelector('.text-2xl');
                if (totalVotersElement) {
                    totalVotersElement.textContent = stats.totalVoters.toLocaleString();
                }

                // Suara Masuk
                const votesReceivedElement = document.querySelector('.bg-green-100').closest('.bg-white').querySelector('.text-2xl');
                if (votesReceivedElement) {
                    votesReceivedElement.textContent = stats.votesReceived.toLocaleString();
                }

                // Partisipasi
                const participationElement = document.querySelector('.bg-yellow-100').closest('.bg-white').querySelector('.text-2xl');
                if (participationElement) {
                    participationElement.textContent = stats.participation + '%';
                }

                // Kandidat
                const candidatesElement = document.querySelector('.bg-purple-100').closest('.bg-white').querySelector('.text-2xl');
                if (candidatesElement) {
                    candidatesElement.textContent = stats.candidates;
                }

                console.log('üìä Dashboard stats updated:', stats);
            } catch (error) {
                console.error('Error updating dashboard stats:', error);
            }
        }

        // Sistem Realtime Update
        function startRealtimeUpdates() {
            // Update setiap 5 detik untuk demo realtime
            setInterval(() => {
                updateStatistics();
                loadUsersTable();
                loadVotingData();
                loadRecentActivity();
                updateRealTimeResults();
                console.log('üîÑ Data diperbarui secara realtime:', new Date().toLocaleString());
            }, 5000);

            // Update setiap 1 detik untuk statistik cepat
            setInterval(() => {
                updateQuickStats();
            }, 1000);
        }

        // Update statistik cepat
        function updateQuickStats() {
            const users = getUsers();
            const votes = getVotes();

            // Update timestamp terakhir
            const lastUpdateElement = document.querySelector('.text-xs.text-gray-500');
            if (lastUpdateElement && lastUpdateElement.textContent.includes('Terakhir update:')) {
                lastUpdateElement.textContent = `Terakhir update: ${new Date().toLocaleString()}`;
            }
        }

        // Update hasil realtime di dashboard (DATABASE ONLY - NO LOCALSTORAGE FALLBACK)
        async function updateRealTimeResults() {
            console.log('üîÑ Updating real-time results from database...');

            try {
                // Check if API is available
                if (!isAdminOnline || !window.kpuDB) {
                    console.error('‚ùå Database API not available for real-time results');
                    return;
                }

                console.log('üåê Loading real-time results from database API...');
                const apiResults = await window.kpuDB.getVoteResults();

                if (apiResults && apiResults.length > 0) {
                    console.log('‚úÖ Database results loaded:', apiResults);
                    updateResultsFromAPI(apiResults);
                } else {
                    console.log('üìä No vote data found in database (database is empty)');
                    // Initialize with zero values
                    updateResultsFromAPI([]);
                }

            } catch (error) {
                console.error('‚ùå Error updating real-time results from database:', error);
            }
        }

        // Update results from API data
        function updateResultsFromAPI(apiResults) {
            console.log('üîÑ Processing API results:', apiResults);

            // Convert API results to display format
            const results = {
                presiden: {},
                pm: {},
                parlemen: {}
            };

            // Process API results
            apiResults.forEach(result => {
                const category = result.category;
                const candidateName = result.candidate_name || result.candidate_id;
                const votes = parseInt(result.total_votes) || 0;

                if (results[category]) {
                    results[category][candidateName] = votes;
                    console.log(`‚úÖ API result: ${category} - ${candidateName}: ${votes} votes`);
                }
            });

            // Update display with API results
            updateResultsDisplay(results);
        }

        // Update results display in UI
        function updateResultsDisplay(results) {
            console.log('üé® Updating results display:', results);

            try {
                // Update Presiden results
                if (results.presiden) {
                    Object.entries(results.presiden).forEach(([candidateName, votes]) => {
                        const elementId = getCandidateElementId(candidateName, 'presiden');
                        const element = document.getElementById(elementId);
                        if (element) {
                            element.textContent = votes;
                            console.log(`‚úÖ Updated ${candidateName}: ${votes} votes`);
                        } else {
                            console.warn(`‚ö†Ô∏è Element not found for ${candidateName} (${elementId})`);
                        }
                    });
                }

                // Update PM results
                if (results.pm) {
                    Object.entries(results.pm).forEach(([candidateName, votes]) => {
                        const elementId = getCandidateElementId(candidateName, 'pm');
                        const element = document.getElementById(elementId);
                        if (element) {
                            element.textContent = votes;
                            console.log(`‚úÖ Updated ${candidateName}: ${votes} votes`);
                        } else {
                            console.warn(`‚ö†Ô∏è Element not found for ${candidateName} (${elementId})`);
                        }
                    });
                }

                // Update Parlemen results
                if (results.parlemen) {
                    Object.entries(results.parlemen).forEach(([candidateName, votes]) => {
                        const elementId = getCandidateElementId(candidateName, 'parlemen');
                        const element = document.getElementById(elementId);
                        if (element) {
                            element.textContent = votes;
                            console.log(`‚úÖ Updated ${candidateName}: ${votes} votes`);
                        } else {
                            console.warn(`‚ö†Ô∏è Element not found for ${candidateName} (${elementId})`);
                        }
                    });
                }

                // Update last update time
                const lastUpdateElement = document.getElementById('last-update-time');
                if (lastUpdateElement) {
                    lastUpdateElement.textContent = `Terakhir update: ${new Date().toLocaleString()}`;
                }

                console.log('‚úÖ Results display updated successfully');
            } catch (error) {
                console.error('‚ùå Error updating results display:', error);
            }
        }

        // Helper function to get element ID for candidate
        function getCandidateElementId(candidateName, category) {
            // Map candidate names to element IDs
            const elementMapping = {
                'presiden': {
                    'Ahmad Rizki & Sari Indah': 'presiden1-votes',
                    'Budi Santoso & Maya Putri': 'presiden2-votes'
                },
                'pm': {
                    'Dr. Andi Wijaya': 'pm1-votes',
                    'Prof. Lisa Sari': 'pm2-votes'
                },
                'parlemen': {
                    'Rudi Hartono': 'parlemen1-votes',
                    'Nina Kusuma': 'parlemen2-votes',
                    'Dedi Prasetyo': 'parlemen3-votes',
                    'Sinta Dewi': 'parlemen4-votes'
                }
            };

            if (elementMapping[category] && elementMapping[category][candidateName]) {
                return elementMapping[category][candidateName];
            }

            // Fallback: try to generate element ID
            if (candidateName.includes('Kandidat')) {
                const match = candidateName.match(/Kandidat\s+\w+\s+(\d+)/);
                if (match) {
                    return `${category}${match[1]}-votes`;
                }
            }

            // Last resort: use candidate_id if available
            return `${category}-votes-${candidateName.toLowerCase().replace(/\s+/g, '-')}`;
        }

        // REMOVED: updateResultsFromLocalStorage - DATABASE ONLY SYSTEM

        // Update tampilan hasil
        function updateResultsDisplay(results) {
            // Update hasil Presiden
            const presidenSection = document.querySelector('.mb-8 h3').parentElement;
            if (presidenSection) {
                const presidenItems = presidenSection.querySelectorAll('.flex.items-center.justify-between');

                presidenItems.forEach(item => {
                    const nameElement = item.querySelector('h4');
                    if (nameElement) {
                        const name = nameElement.textContent;
                        const voteElement = item.querySelector('.text-right p');
                        const percentElement = item.querySelector('.text-right p:last-child');

                        if (results.presiden[name] !== undefined) {
                            const votes = results.presiden[name];
                            const totalVotes = Object.values(results.presiden).reduce((a, b) => a + b, 0);
                            const percentage = totalVotes > 0 ? Math.round((votes / totalVotes) * 100) : 0;

                            if (voteElement) voteElement.textContent = `${votes} suara`;
                            if (percentElement) percentElement.textContent = `${percentage}%`;

                            // Update progress bar
                            const progressBar = item.querySelector('.bg-red-600, .bg-blue-600');
                            if (progressBar) {
                                progressBar.style.width = `${percentage}%`;
                            }
                        }
                    }
                });
            }
        }

        // User Management Functions
        function addNewUser() {
            document.getElementById('addUserForm').classList.remove('hidden');
        }

        function cancelAddUser() {
            document.getElementById('addUserForm').classList.add('hidden');
            clearAddUserForm();
        }

        // Clear add user form
        function clearAddUserForm() {
            document.getElementById('newUserId').value = '';
            document.getElementById('newUserName').value = '';
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newVoteCount').value = '20';
            document.getElementById('newUserVerified').value = 'false';
        }

        // Generate random password
        function generatePassword() {
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('newPassword').value = password;
        }

        // Generate sample user data
        function generateSampleUser() {
            const sampleNames = [
                'Andi Wijaya', 'Sari Dewi', 'Budi Santoso', 'Maya Sari', 'Rudi Hartono',
                'Lina Kusuma', 'Dedi Prasetyo', 'Nina Anggraini', 'Toni Setiawan', 'Rina Marlina'
            ];

            const users = getUsers();
            const randomName = sampleNames[Math.floor(Math.random() * sampleNames.length)];
            const nameParts = randomName.toLowerCase().split(' ');
            const username = nameParts.join('.');
            const randomId = String(users.length + 1).padStart(3, '0');

            // Check if username already exists
            if (users.some(user => user.username === username)) {
                alert('‚ö†Ô∏è Sample username sudah ada, silakan generate ulang atau edit manual.');
                return;
            }

            document.getElementById('newUserId').value = randomId;
            document.getElementById('newUserName').value = randomName;
            document.getElementById('newUsername').value = username;
            generatePassword(); // Auto-generate password
            document.getElementById('newVoteCount').value = Math.floor(Math.random() * 30) + 15; // 15-45 votes
            document.getElementById('newUserVerified').value = Math.random() > 0.5 ? 'true' : 'false';

            alert(`üé≤ Sample user generated!\n\nüìã Data:\n‚Ä¢ Nama: ${randomName}\n‚Ä¢ Username: ${username}\n‚Ä¢ ID: ${randomId}\n\nSilakan review dan edit jika diperlukan sebelum menyimpan.`);
        }

        // Enhanced save new user function
        async function saveNewUser(event) {
            if (event) {
                event.preventDefault(); // Prevent form submission
            }

            const userId = document.getElementById('newUserId').value.trim();
            const name = document.getElementById('newUserName').value.trim();
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value.trim();
            const voteCount = document.getElementById('newVoteCount').value;
            const verified = document.getElementById('newUserVerified').value === 'true';

            // Validation
            if (!name || !username || !password) {
                alert('‚ùå Field yang wajib diisi: Nama Lengkap, Username, dan Password!');
                return;
            }

            const users = getUsers();

            // Check if username already exists
            if (users.some(user => user.username === username)) {
                alert('‚ùå Username sudah ada! Gunakan username yang berbeda.');
                document.getElementById('newUsername').focus();
                return;
            }

            // Generate or validate ID
            let newId = userId;
            if (!newId) {
                // Auto-generate ID
                newId = String(users.length + 1).padStart(3, '0');
            } else {
                // Validate custom ID format
                if (!/^\d{3}$/.test(newId)) {
                    alert('‚ùå Format ID tidak valid! Gunakan 3 digit angka (001, 002, dst)');
                    document.getElementById('newUserId').focus();
                    return;
                }

                // Check if ID already exists
                if (users.some(user => user.id === newId)) {
                    alert('‚ùå ID sudah ada! Gunakan ID yang berbeda atau kosongkan untuk auto-generate.');
                    document.getElementById('newUserId').focus();
                    return;
                }
            }

            // Create new user object
            const newUser = {
                id: newId,
                name: name,
                username: username,
                password: password,
                voteCount: parseInt(voteCount) || 20,
                status: 'Belum Voting',
                verified: verified,
                registeredAt: new Date().toISOString(),
                lastLogin: null
            };

            try {
                // Create user in MySQL database first
                const response = await fetch('/kpu-monasmuda/api/users.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'create',
                        user: newUser
                    })
                });

                if (response.ok) {
                    // Add to localStorage after successful database creation
                    users.push(newUser);
                    localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));

                    // Refresh the table
                    loadUsersTable();
                    clearAddUserForm();

                    // Log activity
                    logActivity('ADMIN', `Menambah user baru: ${newUser.name} (${newUser.username})`, 'create');

                    alert(`‚úÖ User ${newUser.name} berhasil ditambahkan ke database!\n\nüìã Detail:\n‚Ä¢ ID: ${newUser.id}\n‚Ä¢ Username: ${newUser.username}\n‚Ä¢ Password: ${newUser.password}\n‚Ä¢ Verified: ${verified ? 'Ya' : 'Tidak'}`);
                    console.log(`‚ûï User created in MySQL: ${newUser.name} (${newUser.username})`);
                } else {
                    const error = await response.json();
                    alert(`‚ùå Gagal menambah user ke database: ${error.error}`);
                }

            } catch (error) {
                console.error('‚ùå Error creating user:', error);
                alert(`‚ùå Error menambah user: ${error.message}`);
            }
        }

        // üî• ENHANCED: Determine voting status based on actual vote data with detailed tracking
        async function determineVotingStatus(user, localVotes = []) {
            try {
                let hasVotedInAPI = false;
                let voteCategories = [];
                let voteDetails = {};

                // Check API votes if available
                if (isAdminOnline && window.kpuDB) {
                    try {
                        const apiVotes = await window.kpuDB.getUserVotes(user.id);
                        if (apiVotes && apiVotes.length > 0) {
                            hasVotedInAPI = true;
                            voteCategories = [...new Set(apiVotes.map(v => v.category))];

                            // Store detailed vote information for debugging and display
                            voteDetails.apiVotes = apiVotes;
                            voteDetails.source = 'database';
                            voteDetails.totalVotes = apiVotes.reduce((sum, vote) => sum + parseInt(vote.vote_count || 0), 0);
                            voteDetails.votesByCategory = {};

                            // Group votes by category for detailed analysis
                            apiVotes.forEach(vote => {
                                if (!voteDetails.votesByCategory[vote.category]) {
                                    voteDetails.votesByCategory[vote.category] = [];
                                }
                                voteDetails.votesByCategory[vote.category].push({
                                    candidate_id: vote.candidate_id,
                                    candidate_name: vote.candidate_name,
                                    vote_count: vote.vote_count,
                                    voted_at: vote.voted_at
                                });
                            });

                            console.log(`üó≥Ô∏è API votes found for ${user.username}:`, {
                                categories: voteCategories,
                                totalVotes: voteDetails.totalVotes,
                                votesByCategory: voteDetails.votesByCategory
                            });
                        }
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è Could not check API votes for ${user.username}:`, error.message);
                        voteDetails.apiError = error.message;
                    }
                }

                // Check local votes if no API votes found
                if (!hasVotedInAPI) {
                    const localUserVote = localVotes.find(vote =>
                        vote.username === user.username || vote.user_id === user.id
                    );
                    if (localUserVote) {
                        // Count categories with votes > 0 and store detailed information
                        const localCategories = [];
                        voteDetails.localVotes = localUserVote;
                        voteDetails.source = 'localStorage';
                        voteDetails.votesByCategory = {};
                        voteDetails.totalVotes = 0;

                        // Process presiden votes
                        if (localUserVote.presidenVotes && Object.values(localUserVote.presidenVotes).some(v => v > 0)) {
                            localCategories.push('presiden');
                            voteDetails.votesByCategory.presiden = [];
                            Object.entries(localUserVote.presidenVotes).forEach(([name, count]) => {
                                if (count > 0) {
                                    voteDetails.votesByCategory.presiden.push({
                                        candidate_name: name,
                                        vote_count: count
                                    });
                                    voteDetails.totalVotes += count;
                                }
                            });
                        }

                        // Process PM votes
                        if (localUserVote.pmVotes && Object.values(localUserVote.pmVotes).some(v => v > 0)) {
                            localCategories.push('pm');
                            voteDetails.votesByCategory.pm = [];
                            Object.entries(localUserVote.pmVotes).forEach(([name, count]) => {
                                if (count > 0) {
                                    voteDetails.votesByCategory.pm.push({
                                        candidate_name: name,
                                        vote_count: count
                                    });
                                    voteDetails.totalVotes += count;
                                }
                            });
                        }

                        // Process parlemen votes
                        if (localUserVote.parlemenVotes && Object.values(localUserVote.parlemenVotes).some(v => v > 0)) {
                            localCategories.push('parlemen');
                            voteDetails.votesByCategory.parlemen = [];
                            Object.entries(localUserVote.parlemenVotes).forEach(([name, count]) => {
                                if (count > 0) {
                                    voteDetails.votesByCategory.parlemen.push({
                                        candidate_name: name,
                                        vote_count: count
                                    });
                                    voteDetails.totalVotes += count;
                                }
                            });
                        }

                        voteCategories = localCategories;
                        console.log(`üó≥Ô∏è Local votes found for ${user.username}:`, {
                            categories: localCategories,
                            totalVotes: voteDetails.totalVotes,
                            votesByCategory: voteDetails.votesByCategory
                        });
                    } else {
                        voteDetails.source = 'none';
                    }
                }

                // Determine status based on vote completeness
                const totalCategories = 3; // presiden, pm, parlemen
                const votedCategories = voteCategories.length;

                // üî• ENHANCED: Detailed status determination with vote information
                const result = {
                    categories: voteCategories,
                    voteDetails: voteDetails,
                    debugInfo: {
                        userId: user.id,
                        username: user.username,
                        hasVotedInAPI: hasVotedInAPI,
                        votedCategories: votedCategories,
                        totalCategories: totalCategories,
                        source: voteDetails.source,
                        totalVotes: voteDetails.totalVotes || 0
                    }
                };

                if (votedCategories === 0) {
                    return {
                        ...result,
                        status: 'Belum Voting',
                        class: 'bg-gray-100 text-gray-800',
                        detail: 'Belum memberikan suara'
                    };
                } else if (votedCategories === totalCategories) {
                    return {
                        ...result,
                        status: 'Sudah Voting',
                        class: 'bg-green-100 text-green-800',
                        detail: `Lengkap (${votedCategories}/${totalCategories}) - ${voteDetails.totalVotes || 0} suara - ${voteDetails.source}`
                    };
                } else {
                    // Show which categories are missing
                    const allCategories = ['presiden', 'pm', 'parlemen'];
                    const missingCategories = allCategories.filter(cat => !voteCategories.includes(cat));
                    const categoryNames = {
                        'presiden': 'Presiden',
                        'pm': 'PM',
                        'parlemen': 'Parlemen'
                    };
                    const missingNames = missingCategories.map(cat => categoryNames[cat]).join(', ');

                    return {
                        ...result,
                        status: 'Voting Bermasalah',
                        class: 'bg-red-100 text-red-800',
                        detail: `Tidak lengkap (${votedCategories}/${totalCategories}) - Kurang: ${missingNames} - ${voteDetails.totalVotes || 0} suara`,
                        missing: missingCategories
                    };
                }

            } catch (error) {
                console.error(`‚ùå Error determining voting status for ${user.username}:`, error);
                return {
                    status: user.status || 'Belum Voting',
                    class: 'bg-yellow-100 text-yellow-800',
                    detail: 'Status tidak dapat ditentukan'
                };
            }
        }

        // üî• ENHANCED: Load users table with immediate voting data integration
        async function loadUsersTable() {
            try {
                console.log('üë• Loading users table with voting data...');
                let users = [];
                let votes = [];

                // üî• ENHANCED: Load both users and votes data simultaneously
                if (isAdminOnline && window.kpuDB) {
                    console.log('üåê Loading users and votes from database...');

                    // Load users from database
                    users = await window.kpuDB.getUsers();
                    console.log('‚úÖ Users loaded from database:', users.length, 'users');

                    // üî• NEW: Also load all vote data from database for accurate status detection
                    try {
                        const allVoteResults = await window.kpuDB.getVoteResults();
                        console.log('üó≥Ô∏è Vote results loaded from database:', allVoteResults.length, 'vote records');

                        // Convert vote results to user-specific vote data for status detection
                        votes = [];
                        for (const user of users) {
                            try {
                                const userVotes = await window.kpuDB.getUserVotes(user.id);
                                if (userVotes && userVotes.length > 0) {
                                    votes.push({
                                        user_id: user.id,
                                        username: user.username,
                                        votes: userVotes,
                                        timestamp: userVotes[0]?.voted_at || new Date().toISOString()
                                    });
                                }
                            } catch (error) {
                                console.warn(`‚ö†Ô∏è Could not load votes for user ${user.username}:`, error.message);
                            }
                        }
                        console.log('‚úÖ User-specific votes loaded:', votes.length, 'users with votes');
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Could not load vote data from database:', error.message);
                        votes = getVotes(); // Fallback to localStorage
                    }

                    // Debug: Log first few users to check data integrity
                    if (users.length > 0) {
                        console.log('üîç Sample user data from database:', users.slice(0, 3));
                    }
                } else {
                    console.log('üíæ Loading users and votes from localStorage...');
                    users = getUsers();
                    votes = getVotes();
                    console.log('üì± Users loaded from localStorage:', users.length, 'users');
                    console.log('üì± Votes loaded from localStorage:', votes.length, 'vote records');

                    // Debug: Log first few users to check data integrity
                    if (users.length > 0) {
                        console.log('üîç Sample user data from localStorage:', users.slice(0, 3));
                    }
                }

                const tableBody = document.getElementById('usersTableBody');

                if (!tableBody) return;

                tableBody.innerHTML = '';

                // üî• ENHANCED: Process users with async status detection
                for (const user of users) {
                    // Auto-detect voting status based on actual vote data
                    const votingStatus = await determineVotingStatus(user, votes);

                    // üîç ENHANCED DETAILED LOGGING: Show comprehensive status analysis
                    console.log(`üìä Status Analysis for ${user.username}:`, {
                        databaseStatus: user.status,
                        calculatedStatus: votingStatus.status,
                        categories: votingStatus.categories,
                        detail: votingStatus.detail,
                        missing: votingStatus.missing || 'none',
                        debugInfo: votingStatus.debugInfo,
                        voteSource: votingStatus.voteDetails?.source,
                        totalVotes: votingStatus.voteDetails?.totalVotes || 0,
                        votesByCategory: votingStatus.voteDetails?.votesByCategory
                    });

                    // üî• ENHANCED: Update user status if it differs from detected status
                    if (user.status !== votingStatus.status) {
                        console.log(`üîÑ STATUS MISMATCH for ${user.username}:`);
                        console.log(`   Database Status: "${user.status}"`);
                        console.log(`   Calculated Status: "${votingStatus.status}"`);
                        console.log(`   Reason: ${votingStatus.detail}`);
                        console.log(`   Vote Source: ${votingStatus.voteDetails?.source}`);
                        console.log(`   Total Votes: ${votingStatus.voteDetails?.totalVotes || 0}`);

                        // Update local user object
                        user.status = votingStatus.status;

                        // üî• ENHANCED: Queue status update for database sync
                        if (isAdminOnline && window.kpuDB) {
                            // Update user status in database asynchronously
                            window.kpuDB.updateUser(user.id, { status: votingStatus.status })
                                .then(() => {
                                    console.log(`‚úÖ User status updated in database: ${user.username} -> ${votingStatus.status}`);
                                })
                                .catch(error => {
                                    console.warn(`‚ö†Ô∏è Failed to update user status in database for ${user.username}:`, error);
                                });
                        }
                    }

                    const statusClass = votingStatus.class;

                    // üîí Verification status styling
                    const verificationStatus = user.verified ? 'Terverifikasi' : 'Belum Verifikasi';
                    const verificationClass = user.verified
                        ? 'bg-green-100 text-green-800'
                        : 'bg-red-100 text-red-800';

                const row = `
                    <tr data-user-id="${user.id}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.username}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">${user.password}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.vote_count || user.voteCount || 20}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                                ${user.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${verificationClass}">
                                ${verificationStatus}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editUser('${user.id}')" class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                            <button onclick="viewUserVotes('${user.id}')" class="text-green-600 hover:text-green-900 mr-2">Lihat Suara</button>
                            <button onclick="resetUserPassword('${user.id}')" class="text-orange-600 hover:text-orange-900 mr-2">Reset</button>
                            <button onclick="resetUserVotes('${user.id}')" class="text-purple-600 hover:text-purple-900 mr-2">üó≥Ô∏è Reset Suara</button>
                            <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-900">üóëÔ∏è Hapus</button>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
                }

            console.log(`üìä Loaded ${users.length} users into table`);
            } catch (error) {
                console.error('‚ùå Error loading users table:', error);
                // Fallback to localStorage
                const users = getUsers();
                const tableBody = document.getElementById('usersTableBody');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-red-600 py-4">‚ùå Error loading users. Using local data.</td></tr>';

                    // Try to load local data after error message
                    setTimeout(async () => {
                        tableBody.innerHTML = '';
                        const localVotes = getVotes();

                        for (const user of users) {
                            // Use the same status detection logic
                            const votingStatus = await determineVotingStatus(user, localVotes);
                            const statusClass = votingStatus.class;

                            const verificationStatus = user.verified ? 'Terverifikasi' : 'Belum Verifikasi';
                            const verificationClass = user.verified
                                ? 'bg-green-100 text-green-800'
                                : 'bg-red-100 text-red-800';

                            const row = `
                                <tr data-user-id="${user.id}">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.id}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.name}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.username}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.password}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.voteCount || user.vote_count || 20}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                                            ${votingStatus.status}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${verificationClass}">
                                            ${verificationStatus}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button onclick="editUser('${user.id}')" class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                                        <button onclick="viewUserVotes('${user.id}')" class="text-green-600 hover:text-green-900 mr-2">Lihat Suara</button>
                                        <button onclick="resetUserPassword('${user.id}')" class="text-orange-600 hover:text-orange-900 mr-2">Reset</button>
                                        <button onclick="resetUserVotes('${user.id}')" class="text-purple-600 hover:text-purple-900 mr-2">üó≥Ô∏è Reset Suara</button>
                                        <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-900">üóëÔ∏è Hapus</button>
                                    </td>
                                </tr>
                            `;
                            tableBody.insertAdjacentHTML('beforeend', row);
                        }
                    }, 2000);
                }
            }
        }

        // Edit user function
        function editUser(userId) {
            const users = getUsers();
            const user = users.find(u => u.id === userId);
            if (!user) return;

            const newName = prompt('Nama Lengkap:', user.name);
            if (newName === null) return;

            const newUsername = prompt('Username:', user.username);
            if (newUsername === null) return;

            const newPassword = prompt('Password:', user.password);
            if (newPassword === null) return;

            const newVoteCount = prompt('Jumlah Suara:', user.vote_count || user.voteCount || 20);
            if (newVoteCount === null) return;

            // Update user data
            user.name = newName;
            user.username = newUsername;
            user.password = newPassword;
            user.vote_count = parseInt(newVoteCount) || 20;
            user.voteCount = parseInt(newVoteCount) || 20; // Keep both for compatibility

            saveUsers(users);
            loadUsersTable();
            alert('Data user berhasil diperbarui!');
        }

        // View user votes - UPDATED FUNCTION
        async function viewUserVotes(userId) {
            try {
                console.log(`üîç Loading vote details for user: ${userId}`);
                let users = [];
                let user = null;

                // Get user data from appropriate source
                if (isAdminOnline && window.kpuDB) {
                    users = await window.kpuDB.getUsers();
                    user = users.find(u => u.id === userId);
                } else {
                    users = getUsers();
                    user = users.find(u => u.id === userId);
                }

                if (!user) {
                    alert('‚ùå User tidak ditemukan!');
                    return;
                }

                // üî• FIXED: Check actual voting data instead of just user.status
                console.log(`üîç Checking actual voting data for ${user.username}...`);
                let hasActualVotes = false;
                let userVotes = [];

                // Check for actual vote data first
                if (isAdminOnline && window.kpuDB) {
                    try {
                        userVotes = await window.kpuDB.getUserVotes(userId);
                        hasActualVotes = userVotes && userVotes.length > 0;
                        console.log(`üó≥Ô∏è API votes found for ${user.username}:`, userVotes.length);
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è Could not check API votes for ${user.username}:`, error.message);
                    }
                }

                // Fallback to localStorage if no API votes found
                if (!hasActualVotes) {
                    const votes = getVotes();
                    const userVote = votes.find(vote => vote.username === user.username);
                    hasActualVotes = !!userVote;
                    console.log(`üì± Local votes found for ${user.username}:`, hasActualVotes);
                }

                // üö® CRITICAL: Check actual vote data, not just status
                if (!hasActualVotes) {
                    alert(`${user.name} belum memberikan suara atau data vote tidak ditemukan.\n\nStatus di database: ${user.status || 'Tidak diketahui'}\nData voting aktual: Tidak ada`);
                    return;
                }

                let voteDetails = `Detail Suara - ${user.name} (${user.username})\n\n`;

                if (isAdminOnline && window.kpuDB) {
                    // Get vote details from API
                    console.log('üåê Getting vote details from API...');
                    try {
                        // üî• FIXED: Use the correct getUserVotes method instead of apiCall
                        const userVotes = await window.kpuDB.getUserVotes(userId);
                        console.log('üìä User vote details from API:', userVotes);

                        if (!userVotes || userVotes.length === 0) {
                            // üî• ENHANCED: Show more detailed debug info
                            console.log(`‚ö†Ô∏è No votes found for user ${userId} (${user.username})`);
                            console.log(`üîç User status in database: ${user.status}`);

                            // Check if there are any votes in the system at all
                            try {
                                const allVotes = await window.kpuDB.getVoteResults();
                                console.log(`üìä Total votes in system: ${allVotes.length}`);

                                // Check if this user has votes under different format
                                const userVotesInResults = allVotes.filter(vote =>
                                    vote.user_id === userId || vote.user_id === user.username
                                );
                                console.log(`üîç User votes found in results: ${userVotesInResults.length}`);

                                if (userVotesInResults.length > 0) {
                                    console.log(`üó≥Ô∏è Found votes for user in results table:`, userVotesInResults);
                                    alert(`${user.name} memiliki ${userVotesInResults.length} suara dalam sistem, tetapi tidak dapat diakses melalui getUserVotes.\n\nData mungkin tersimpan dengan format berbeda.\n\nSilakan check console untuk detail.`);
                                } else {
                                    alert(`${user.name} belum memberikan suara atau data vote tidak ditemukan.\n\nStatus: ${user.status}\nTotal votes in system: ${allVotes.length}`);
                                }
                            } catch (error) {
                                console.error('‚ùå Error checking vote results:', error);
                                alert(`${user.name} belum memberikan suara atau data vote tidak ditemukan.`);
                            }
                            return;
                        }

                        // Group votes by category
                        const votesByCategory = {
                            presiden: [],
                            pm: [],
                            parlemen: []
                        };

                        userVotes.forEach(vote => {
                            if (votesByCategory[vote.category]) {
                                votesByCategory[vote.category].push(vote);
                            }
                        });

                        // Add voting time if available
                        if (userVotes[0] && userVotes[0].voted_at) {
                            voteDetails += `Waktu Voting: ${new Date(userVotes[0].voted_at).toLocaleString()}\n\n`;
                        } else if (user.lastLogin) {
                            voteDetails += `Waktu Login Terakhir: ${new Date(user.lastLogin).toLocaleString()}\n\n`;
                        }

                        // Display votes by category
                        if (votesByCategory.presiden.length > 0) {
                            voteDetails += `PRESIDEN & WAKIL PRESIDEN:\n`;
                            votesByCategory.presiden.forEach(vote => {
                                voteDetails += `‚Ä¢ ${vote.candidate_name || vote.candidate_id}: ${vote.vote_count} suara\n`;
                            });
                            voteDetails += `\n`;
                        }

                        if (votesByCategory.pm.length > 0) {
                            voteDetails += `PERDANA MENTERI:\n`;
                            votesByCategory.pm.forEach(vote => {
                                voteDetails += `‚Ä¢ ${vote.candidate_name || vote.candidate_id}: ${vote.vote_count} suara\n`;
                            });
                            voteDetails += `\n`;
                        }

                        if (votesByCategory.parlemen.length > 0) {
                            voteDetails += `KETUA PARLEMEN:\n`;
                            votesByCategory.parlemen.forEach(vote => {
                                voteDetails += `‚Ä¢ ${vote.candidate_name || vote.candidate_id}: ${vote.vote_count} suara\n`;
                            });
                            voteDetails += `\n`;
                        }

                        // Calculate total votes
                        const totalVotes = userVotes.reduce((sum, vote) => sum + parseInt(vote.vote_count), 0);
                        voteDetails += `Total Suara Diberikan: ${totalVotes}`;

                    } catch (error) {
                        console.error('‚ùå Error getting vote details from API:', error);
                        console.log('üì± Falling back to localStorage...');

                        // Fallback to localStorage
                        const votes = getVotes();
                        const userVote = votes.find(vote => vote.username === user.username);

                        if (!userVote) {
                            alert(`${user.name} belum memberikan suara.`);
                            return;
                        }

                        voteDetails += `Waktu Voting: ${new Date(userVote.timestamp).toLocaleString()}\n\n`;

                        voteDetails += `PRESIDEN & WAKIL PRESIDEN:\n`;
                        Object.entries(userVote.presidenVotes || {}).forEach(([name, votes]) => {
                            if (votes > 0) voteDetails += `‚Ä¢ ${name}: ${votes} suara\n`;
                        });

                        voteDetails += `\nPERDANA MENTERI:\n`;
                        Object.entries(userVote.pmVotes || {}).forEach(([name, votes]) => {
                            if (votes > 0) voteDetails += `‚Ä¢ ${name}: ${votes} suara\n`;
                        });

                        voteDetails += `\nKETUA PARLEMEN:\n`;
                        Object.entries(userVote.parlemenVotes || {}).forEach(([name, votes]) => {
                            if (votes > 0) voteDetails += `‚Ä¢ ${name}: ${votes} suara\n`;
                        });
                    }
                } else {
                    // Use localStorage data
                    console.log('üì± Getting vote details from localStorage...');
                    const votes = getVotes();
                    const userVote = votes.find(vote => vote.username === user.username);

                    if (!userVote) {
                        alert(`${user.name} belum memberikan suara.`);
                        return;
                    }

                    voteDetails += `Waktu Voting: ${new Date(userVote.timestamp).toLocaleString()}\n\n`;

                    voteDetails += `PRESIDEN & WAKIL PRESIDEN:\n`;
                    Object.entries(userVote.presidenVotes || {}).forEach(([name, votes]) => {
                        if (votes > 0) voteDetails += `‚Ä¢ ${name}: ${votes} suara\n`;
                    });

                    voteDetails += `\nPERDANA MENTERI:\n`;
                    Object.entries(userVote.pmVotes || {}).forEach(([name, votes]) => {
                        if (votes > 0) voteDetails += `‚Ä¢ ${name}: ${votes} suara\n`;
                    });

                    voteDetails += `\nKETUA PARLEMEN:\n`;
                    Object.entries(userVote.parlemenVotes || {}).forEach(([name, votes]) => {
                        if (votes > 0) voteDetails += `‚Ä¢ ${name}: ${votes} suara\n`;
                    });
                }

                alert(voteDetails);
                console.log(`‚úÖ Vote details displayed for user: ${user.name}`);

            } catch (error) {
                console.error('‚ùå Error viewing user votes:', error);
                alert(`‚ùå Error menampilkan detail suara: ${error.message}`);
            }
        }

        // Reset user password
        function resetUserPassword(userId) {
            const users = getUsers();
            const user = users.find(u => u.id === userId);
            if (!user) return;

            if (confirm(`Reset password untuk ${user.name}?`)) {
                const newPassword = 'password123';
                user.password = newPassword;
                saveUsers(users);
                loadUsersTable();
                alert(`Password ${user.name} telah direset ke: ${newPassword}`);
            }
        }

        // Reset user votes - SIMPLIFIED FUNCTION
        async function resetUserVotes(userId) {
            try {
                console.log(`üó≥Ô∏è Resetting votes for user: ${userId}`);

                // Get user data
                const users = getUsers();
                const user = users.find(u => u.id === userId);

                if (!user) {
                    alert('‚ùå User tidak ditemukan!');
                    return;
                }

                if (confirm(`üó≥Ô∏è RESET SUARA: ${user.name} (${user.username})\n\n‚ö†Ô∏è Tindakan ini akan:\n‚Ä¢ Menghapus semua suara yang telah diberikan user ini\n‚Ä¢ Mengubah status menjadi "Belum Voting"\n‚Ä¢ User dapat voting ulang\n\nTindakan ini tidak dapat dibatalkan!\n\nLanjutkan?`)) {

                    // Try API first, then fallback to localStorage
                    let resetSuccess = false;
                    let deletedVotes = 0;

                    try {
                        // Try API reset if available
                        if (window.kpuDB && typeof window.kpuDB.resetUserVotes === 'function') {
                            console.log('üåê Attempting API reset...');
                            const apiResult = await window.kpuDB.resetUserVotes(userId);
                            console.log('üîÑ API reset result:', apiResult);

                            if (apiResult && (apiResult.success || apiResult.user)) {
                                resetSuccess = true;
                                deletedVotes = apiResult.deleted_votes || 0;
                                console.log(`‚úÖ User ${user.username} votes reset via API`);
                            }
                        }
                    } catch (apiError) {
                        console.warn('üîÑ API reset failed, using localStorage fallback:', apiError);
                    }

                    // Fallback to localStorage if API failed or unavailable
                    if (!resetSuccess) {
                        console.log('üì± Using localStorage fallback...');
                        const votes = getVotes();
                        const originalCount = votes.length;
                        const filteredVotes = votes.filter(vote => vote.username !== user.username);
                        saveVotes(filteredVotes);
                        deletedVotes = originalCount - filteredVotes.length;
                        resetSuccess = true;
                        console.log(`‚úÖ User ${user.username} votes reset in localStorage`);
                    }

                    // Reset user status locally (always do this for UI consistency)
                    user.status = 'Belum Voting';
                    user.lastLogin = null;
                    saveUsers(users);

                    // Refresh displays
                    console.log('üîÑ Refreshing displays...');
                    await loadUsersTable();
                    loadVotingData();
                    updateRealTimeResults();
                    updateStatistics();

                    // Log activity
                    logActivity('ADMIN', `Reset suara user: ${user.name} (${user.username})`, 'reset_votes');

                    // Show success message
                    let successMessage = `‚úÖ Suara ${user.name} berhasil direset!`;
                    if (deletedVotes > 0) {
                        successMessage += `\nüó≥Ô∏è ${deletedVotes} suara telah dihapus.`;
                    }
                    successMessage += `\n\n${user.name} sekarang dapat melakukan voting ulang.`;

                    alert(successMessage);
                    console.log(`üó≥Ô∏è User votes reset successfully: ${user.name} (${user.username})`);
                }
            } catch (error) {
                console.error('‚ùå Error resetting user votes:', error);
                alert(`‚ùå Error reset suara user: ${error.message}`);
            }
        }

        // Delete single user
        async function deleteUser(userId) {
            try {
                console.log(`üóëÔ∏è Deleting user: ${userId}`);
                let users = [];
                let user = null;

                // Get user data from appropriate source
                if (isAdminOnline && window.kpuDB) {
                    users = await window.kpuDB.getUsers();
                    user = users.find(u => u.id === userId);
                } else {
                    users = getUsers();
                    user = users.find(u => u.id === userId);
                }

                if (!user) {
                    alert('‚ùå User tidak ditemukan!');
                    return;
                }

                if (confirm(`‚ö†Ô∏è HAPUS USER: ${user.name} (${user.username})\n\nTindakan ini tidak dapat dibatalkan!\nSemua data voting user ini akan hilang.\n\nLanjutkan?`)) {
                    let deleteResult = null;

                    if (isAdminOnline && window.kpuDB) {
                        // Delete from database using proper integration
                        deleteResult = await window.kpuDB.deleteUser(userId);
                        console.log(`üîÑ Delete result:`, deleteResult);

                        if (deleteResult.success) {
                            console.log(`‚úÖ User ${user.username} deleted from database`);
                            if (deleteResult.deleted_votes > 0) {
                                console.log(`üó≥Ô∏è Also deleted ${deleteResult.deleted_votes} votes`);
                            }
                            if (deleteResult.deleted_logs > 0) {
                                console.log(`üìù Also deleted ${deleteResult.deleted_logs} activity logs`);
                            }
                        } else {
                            throw new Error(deleteResult.error || 'Delete failed');
                        }
                    } else {
                        // Delete from localStorage
                        const updatedUsers = users.filter(u => u.id !== userId);
                        localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(updatedUsers));
                        console.log(`‚úÖ User ${user.username} deleted from localStorage`);
                        deleteResult = { success: true, deleted_user: user };
                    }

                    // Remove user's votes from localStorage (for consistency)
                    const votes = getVotes();
                    const updatedVotes = votes.filter(vote => vote.username !== user.username);
                    saveVotes(updatedVotes);

                    // Refresh table to verify deletion
                    console.log('üîÑ Refreshing users table to verify deletion...');
                    await loadUsersTable();

                    // Log activity
                    logActivity('ADMIN', `Menghapus user: ${user.name} (${user.username})`, 'delete');

                    // Show detailed success message
                    let successMessage = `‚úÖ User ${user.name} berhasil dihapus!`;
                    if (deleteResult.deleted_votes > 0) {
                        successMessage += `\nüó≥Ô∏è ${deleteResult.deleted_votes} suara juga dihapus.`;
                    }
                    if (deleteResult.deleted_logs > 0) {
                        successMessage += `\nüìù ${deleteResult.deleted_logs} log aktivitas juga dihapus.`;
                    }

                    alert(successMessage);
                    console.log(`üóëÔ∏è User deleted successfully: ${user.name} (${user.username})`);
                }
            } catch (error) {
                console.error('‚ùå Error deleting user:', error);
                alert(`‚ùå Error menghapus user: ${error.message}`);
            }
        }

        function exportUsers() {
            const users = getUsers();
            const votes = getVotes();

            let csvContent = "ID,Nama,Username,Password,Jumlah Suara,Status,Tanggal Daftar,Terakhir Login\n";

            users.forEach(user => {
                const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'Belum pernah';
                const registeredAt = new Date(user.registeredAt).toLocaleString();

                csvContent += `${user.id},"${user.name}","${user.username}","${user.password}",${user.voteCount},"${user.status}","${registeredAt}","${lastLogin}"\n`;
            });

            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kpu_users_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            alert('Data user berhasil diexport ke file CSV!');
        }

        function importUsers() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const csv = e.target.result;
                            const lines = csv.split('\n');
                            const users = getUsers();
                            let importCount = 0;

                            // Skip header line
                            for (let i = 1; i < lines.length; i++) {
                                const line = lines[i].trim();
                                if (!line) continue;

                                const [id, name, username, password, voteCount, status, registeredAt, lastLogin] = line.split(',');

                                // Check if user already exists
                                if (users.find(u => u.username === username.replace(/"/g, ''))) {
                                    continue;
                                }

                                const newUser = {
                                    id: id || String(users.length + importCount + 1).padStart(3, '0'),
                                    name: name.replace(/"/g, ''),
                                    username: username.replace(/"/g, ''),
                                    password: password.replace(/"/g, ''),
                                    voteCount: parseInt(voteCount) || 1,
                                    status: status.replace(/"/g, '') || 'Belum Voting',
                                    registeredAt: registeredAt.replace(/"/g, '') || new Date().toISOString(),
                                    lastLogin: lastLogin.replace(/"/g, '') === 'Belum pernah' ? null : lastLogin.replace(/"/g, '')
                                };

                                users.push(newUser);
                                importCount++;
                            }

                            saveUsers(users);
                            loadUsersTable();
                            alert(`Berhasil import ${importCount} user dari file CSV!`);
                        } catch (error) {
                            alert('Error saat import file. Pastikan format CSV benar.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function resetAllPasswords() {
            if (confirm('Apakah Anda yakin ingin mereset semua password ke "password123"? Tindakan ini tidak dapat dibatalkan.')) {
                const users = getUsers();
                users.forEach(user => {
                    user.password = 'password123';
                });
                saveUsers(users);
                loadUsersTable();
                alert('Semua password telah direset ke "password123".');
            }
        }

        // Clear all votes using API (sesuai dengan API yang sudah ada)
        async function clearAllVotes() {
            if (confirm('Apakah Anda yakin ingin menghapus semua data suara? Tindakan ini tidak dapat dibatalkan.')) {
                try {
                    console.log('üóëÔ∏è Clearing all votes...');

                    // Try API first (same as clearAllTestVotes function)
                    if (isAdminOnline && window.kpuDB) {
                        console.log('üåê Clearing votes from database using API...');
                        try {
                            const result = await window.kpuDB.resetAllVotes();
                            console.log('‚úÖ All votes cleared from database:', result);

                            // Also clear localStorage to sync
                            localStorage.removeItem('kpu_votes');
                            localStorage.setItem(STORAGE_KEYS.VOTES, JSON.stringify([]));

                            // Reset users status in localStorage
                            const users = getUsers();
                            users.forEach(user => {
                                user.status = 'Belum Voting';
                                user.lastLogin = null;
                            });
                            saveUsers(users);

                            console.log('‚úÖ Local data synced with API reset');
                        } catch (error) {
                            console.error('‚ùå Failed to clear votes from database:', error);
                            console.log('üì± Falling back to localStorage only...');

                            // Fallback to localStorage only
                            clearVotesLocalStorageOnly();
                        }
                    } else {
                        console.log('üì± API offline, clearing votes from localStorage only...');
                        clearVotesLocalStorageOnly();
                    }

                    // Update display
                    loadUsersTable();
                    loadVotingData();
                    updateRealTimeResults();
                    updateStatistics();

                    console.log('üóëÔ∏è All votes cleared successfully');
                    alert('‚úÖ Semua data suara telah dihapus. Pemilihan dapat dimulai ulang.');

                    // Log activity
                    logActivity('ADMIN', 'Cleared all votes', 'reset');

                } catch (error) {
                    console.error('‚ùå Error clearing votes:', error);
                    alert('‚ùå Error clearing votes. Check console for details.');
                }
            }
        }

        // Helper function for localStorage-only vote clearing
        function clearVotesLocalStorageOnly() {
            const users = getUsers();
            users.forEach(user => {
                user.status = 'Belum Voting';
                user.lastLogin = null;
            });

            // Clear all votes
            localStorage.removeItem('kpu_votes');
            localStorage.setItem(STORAGE_KEYS.VOTES, JSON.stringify([]));

            saveUsers(users);
            console.log('‚úÖ Votes cleared from localStorage');
        }

        // Delete all users
        async function deleteAllUsers() {
            let allUsers = [];

            try {
                console.log('üóëÔ∏è Checking users in both localStorage and database...');

                // Get users from both sources
                const localUsers = getUsers();
                let dbUsers = [];

                if (isAdminOnline && window.kpuDB) {
                    try {
                        dbUsers = await window.kpuDB.getUsers();
                        console.log(`üåê Database users: ${dbUsers.length}`);
                    } catch (error) {
                        console.error('‚ùå Failed to get database users:', error);
                        dbUsers = [];
                    }
                }

                console.log(`üì± Local users: ${localUsers.length}`);
                console.log(`üåê Database users: ${dbUsers.length}`);

                // Combine unique users from both sources
                allUsers = [...localUsers];
                dbUsers.forEach(dbUser => {
                    if (!allUsers.some(localUser => localUser.id === dbUser.id)) {
                        allUsers.push(dbUser);
                    }
                });

                if (allUsers.length === 0) {
                    alert('‚ö†Ô∏è Tidak ada user untuk dihapus di localStorage maupun database!');
                    return;
                }

                console.log(`üîç Total unique users found: ${allUsers.length}`);

            } catch (error) {
                console.error('‚ùå Error checking users:', error);
                alert('‚ùå Error checking users. Check console for details.');
                return;
            }

            if (confirm(`üö® HAPUS SEMUA USER (${allUsers.length} orang)\n\n‚ö†Ô∏è PERINGATAN KERAS:\n‚Ä¢ Semua user akan dihapus permanen\n‚Ä¢ Semua data voting akan hilang\n‚Ä¢ Tindakan ini TIDAK DAPAT DIBATALKAN\n\nApakah Anda YAKIN ingin melanjutkan?`)) {
                if (confirm(`üî¥ KONFIRMASI TERAKHIR:\n\nAnda akan menghapus ${allUsers.length} user:\n${allUsers.slice(0, 10).map(u => `‚Ä¢ ${u.name} (${u.username})`).join('\n')}${allUsers.length > 10 ? `\n... dan ${allUsers.length - 10} user lainnya` : ''}\n\nSemua data akan HILANG PERMANEN!\n\nKetik "HAPUS SEMUA" untuk konfirmasi:`)) {
                    const confirmation = prompt('Ketik "HAPUS SEMUA" untuk konfirmasi:');

                    if (confirmation === 'HAPUS SEMUA') {
                        try {
                            let totalDeletedVotes = 0;
                            let totalDeletedLogs = 0;
                            let successCount = 0;
                            let failCount = 0;

                            if (isAdminOnline && window.kpuDB) {
                                console.log(`üóëÔ∏è Deleting ${allUsers.length} users from database...`);

                                // Delete all users from database using proper integration
                                for (const user of allUsers) {
                                    try {
                                        const deleteResult = await window.kpuDB.deleteUser(user.id);
                                        console.log(`üîÑ Delete result for ${user.username}:`, deleteResult);

                                        if (deleteResult.success) {
                                            console.log(`‚úÖ User ${user.username} deleted from database`);
                                            successCount++;
                                            totalDeletedVotes += deleteResult.deleted_votes || 0;
                                            totalDeletedLogs += deleteResult.deleted_logs || 0;
                                        } else {
                                            console.error(`‚ùå Failed to delete user ${user.username}: ${deleteResult.error}`);
                                            failCount++;
                                        }
                                    } catch (error) {
                                        console.error(`‚ùå Failed to delete user ${user.username}:`, error);
                                        failCount++;
                                    }
                                }
                                console.log(`‚úÖ Database deletion complete: ${successCount} success, ${failCount} failed`);
                            }

                            // Clear localStorage regardless of database results
                            localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify([]));
                            saveVotes([]);

                            // Refresh table to verify deletion
                            console.log('üîÑ Refreshing users table to verify all deletions...');
                            await loadUsersTable();

                            // Log activity
                            logActivity('ADMIN', `Menghapus semua user (${allUsers.length} orang)`, 'delete_all');

                            // Show detailed success message
                            let successMessage = `‚úÖ Semua ${allUsers.length} user berhasil dihapus!\n\nSistem telah direset ke kondisi kosong.`;
                            if (totalDeletedVotes > 0) {
                                successMessage += `\nüó≥Ô∏è ${totalDeletedVotes} suara juga dihapus.`;
                            }
                            if (totalDeletedLogs > 0) {
                                successMessage += `\nüìù ${totalDeletedLogs} log aktivitas juga dihapus.`;
                            }
                            if (failCount > 0) {
                                successMessage += `\n‚ö†Ô∏è ${failCount} user gagal dihapus dari database (tapi sudah dihapus dari localStorage).`;
                            }

                            alert(successMessage);
                            console.log(`üóëÔ∏è All users deletion completed: ${allUsers.length} users processed`);
                        } catch (error) {
                            console.error('‚ùå Error deleting all users:', error);
                            alert(`‚ùå Error menghapus semua user: ${error.message}`);
                        }
                    } else {
                        alert('‚ùå Konfirmasi tidak sesuai. Penghapusan dibatalkan.');
                    }
                }
            }
        }

        // Download template for user import
        function downloadTemplate() {
            const templateData = [
                ['ID', 'Nama Lengkap', 'Username', 'Password', 'Jumlah Suara', 'Status', 'Verified', 'Keterangan'],
                ['001', 'John Doe', 'john.doe', 'password123', '20', 'Belum Voting', 'false', 'Contoh user 1'],
                ['002', 'Jane Smith', 'jane.smith', 'mypass456', '25', 'Belum Voting', 'false', 'Contoh user 2'],
                ['003', 'Ahmad Rahman', 'ahmad.rahman', 'secure789', '15', 'Belum Voting', 'false', 'Contoh user 3'],
                ['004', 'Siti Nurhaliza', 'siti.nur', 'siti2024', '30', 'Belum Voting', 'false', 'Template - hapus baris ini'],
                ['005', 'Budi Santoso', 'budi.santoso', 'budi123', '20', 'Belum Voting', 'false', 'Template - hapus baris ini']
            ];

            // Convert to CSV
            let csvContent = '';
            templateData.forEach(row => {
                csvContent += row.map(field => `"${field}"`).join(',') + '\n';
            });

            // Add instructions at the top
            const instructions = `# TEMPLATE IMPORT USER KPU MONASMUDA INSTITUTE
#
# INSTRUKSI PENGGUNAAN:
# 1. Isi data user sesuai kolom yang tersedia
# 2. Jangan ubah header (baris pertama)
# 3. ID harus unik (001, 002, 003, dst)
# 4. Username harus unik
# 5. Jumlah Suara: angka 1-100
# 6. Status: "Belum Voting" atau "Sudah Voting"
# 7. Verified: "true" atau "false"
# 8. Hapus baris contoh sebelum import
# 9. Save sebagai file .csv
# 10. Import melalui tombol "Import dari Excel"
#
# CONTOH DATA:
`;

            const finalContent = instructions + csvContent;

            // Create and download file
            const blob = new Blob([finalContent], { type: 'text/csv;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `template_users_kpu_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            alert(`üì• Template berhasil didownload!\n\nüìã INSTRUKSI:\n1. Buka file CSV yang didownload\n2. Isi data user sesuai format\n3. Hapus baris contoh\n4. Save file\n5. Import kembali ke sistem\n\nüí° Tips: Gunakan Excel atau Google Sheets untuk edit yang mudah!`);

            // Log activity
            logActivity('ADMIN', 'Download template import user', 'download');
        }

        // üîÑ DEBUG: Reset All Data Function
        function resetAllData() {
            if (confirm('‚ö†Ô∏è PERINGATAN: Ini akan menghapus SEMUA data (users, votes, election status, dll). Lanjutkan?')) {
                if (confirm('üö® KONFIRMASI TERAKHIR: Semua data akan hilang dan sistem akan reset ke kondisi awal. Yakin?')) {
                    // Clear all localStorage data
                    localStorage.clear();

                    alert('üîÑ Semua data telah dihapus! Halaman akan di-refresh untuk inisialisasi ulang.');

                    // Refresh page to reinitialize
                    window.location.reload();
                }
            }
        }

        // üöÄ Quick Actions Functions
        function refreshData() {
            console.log('üîÑ Refreshing all data...');
            updateStatistics();
            loadUsersTable();
            loadVotingData();
            loadRecentActivity();
            updateRealTimeResults();

            // Show notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = '‚úÖ Data berhasil direfresh!';
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);

            logActivity('ADMIN', 'Manual data refresh', 'system');
        }

        function exportSystemInfo() {
            const users = getUsers();
            const votes = getVotes();
            const electionStatus = localStorage.getItem('election_status') || 'stopped';

            const systemInfo = {
                timestamp: new Date().toISOString(),
                system: {
                    version: 'KPU v2.0',
                    database: 'MySQL',
                    sync: 'Active',
                    admin: 'admin'
                },
                election: {
                    status: electionStatus,
                    totalUsers: users.length,
                    verifiedUsers: users.filter(u => u.verified).length,
                    votedUsers: users.filter(u => u.status === 'Sudah Voting').length,
                    totalVotes: votes.length
                },
                users: users.map(u => ({
                    id: u.id,
                    name: u.name,
                    username: u.username,
                    verified: u.verified,
                    status: u.status,
                    lastLogin: u.lastLogin
                })),
                statistics: {
                    participation: users.length > 0 ? ((users.filter(u => u.status === 'Sudah Voting').length / users.length) * 100).toFixed(1) + '%' : '0%',
                    verificationRate: users.length > 0 ? ((users.filter(u => u.verified).length / users.length) * 100).toFixed(1) + '%' : '0%'
                }
            };

            const blob = new Blob([JSON.stringify(systemInfo, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `system_info_kpu_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);

            alert('üìã System info berhasil diexport!');
            logActivity('ADMIN', 'Export system information', 'export');
        }

        // Initialize vote totals with dynamic candidate names
        function initializeVoteTotals() {
            const voteTotals = {
                presiden: {},
                pm: {},
                parlemen: {}
            };

            // Use dynamic candidate names if available
            if (window.candidateNames) {
                Object.keys(window.candidateNames).forEach(key => {
                    const name = window.candidateNames[key];
                    if (key.startsWith('presiden')) voteTotals.presiden[name] = 0;
                    else if (key.startsWith('pm')) voteTotals.pm[name] = 0;
                    else if (key.startsWith('parlemen')) voteTotals.parlemen[name] = 0;
                });
            } else {
                // Fallback to CORRECT names (UPDATED TO MATCH DATABASE)
                voteTotals.presiden = {
                    'NENENG & INAYAH': 0,
                    'AISYAH & EVI': 0
                };
                voteTotals.pm = {
                    'KUKUH': 0,
                    'SAYYIDAH': 0
                };
                voteTotals.parlemen = {
                    'ADINUR KHOLIFAH': 0,
                    'ENI FATMAWATI': 0,
                    'FAIZAH MAULIDA': 0,
                    'AHMAD NASHUKA': 0
                };

                console.log('‚úÖ Initialized vote totals with dashboard-compatible names');
            }

            return voteTotals;
        }

        // Process API format vote: {user_id, category, votes: [{candidate_id, count}]}
        function processApiFormatVote(vote, voteTotals) {
            console.log('üîÑ Processing API format vote:', vote);

            if (vote.votes && Array.isArray(vote.votes)) {
                vote.votes.forEach(voteEntry => {
                    const candidateId = voteEntry.candidate_id;
                    const count = parseInt(voteEntry.count) || 0;

                    // Map candidate_id to candidate name
                    const candidateName = getCandidateNameFromId(candidateId, vote.category);

                    if (candidateName && voteTotals[vote.category] && voteTotals[vote.category][candidateName] !== undefined) {
                        voteTotals[vote.category][candidateName] += count;
                        console.log(`‚úÖ Added ${count} votes for ${candidateName} in ${vote.category}`);
                    } else {
                        console.warn(`‚ö†Ô∏è Could not map candidate_id ${candidateId} to name in category ${vote.category}`);
                    }
                });
            }
        }

        // Process dashboard format vote: {presidenVotes: {}, pmVotes: {}, parlemenVotes: {}}
        function processDashboardFormatVote(vote, voteTotals) {
            console.log('üîÑ Processing dashboard format vote:', vote);
            console.log('üîÑ Current voteTotals structure:', voteTotals);

            // Count presiden votes
            if (vote.presidenVotes) {
                console.log('üìä Processing presidenVotes:', vote.presidenVotes);
                Object.entries(vote.presidenVotes).forEach(([name, count]) => {
                    console.log(`üìä Checking presiden candidate: "${name}" with ${count} votes`);
                    console.log(`üìä Available presiden candidates:`, Object.keys(voteTotals.presiden));
                    console.log(`üìä Candidate exists in totals:`, voteTotals.presiden[name] !== undefined);

                    if (voteTotals.presiden[name] !== undefined) {
                        const oldTotal = voteTotals.presiden[name];
                        voteTotals.presiden[name] += parseInt(count) || 0;
                        console.log(`‚úÖ Added ${count} presiden votes for "${name}" (${oldTotal} ‚Üí ${voteTotals.presiden[name]})`);
                    } else {
                        console.warn(`‚ö†Ô∏è Presiden candidate "${name}" not found in voteTotals. Available: ${Object.keys(voteTotals.presiden).join(', ')}`);
                    }
                });
            } else {
                console.log('‚ö†Ô∏è No presidenVotes found in vote data');
            }

            // Count PM votes
            if (vote.pmVotes) {
                console.log('üìä Processing pmVotes:', vote.pmVotes);
                Object.entries(vote.pmVotes).forEach(([name, count]) => {
                    console.log(`üìä Checking PM candidate: "${name}" with ${count} votes`);
                    console.log(`üìä Available PM candidates:`, Object.keys(voteTotals.pm));
                    console.log(`üìä Candidate exists in totals:`, voteTotals.pm[name] !== undefined);

                    if (voteTotals.pm[name] !== undefined) {
                        const oldTotal = voteTotals.pm[name];
                        voteTotals.pm[name] += parseInt(count) || 0;
                        console.log(`‚úÖ Added ${count} PM votes for "${name}" (${oldTotal} ‚Üí ${voteTotals.pm[name]})`);
                    } else {
                        console.warn(`‚ö†Ô∏è PM candidate "${name}" not found in voteTotals. Available: ${Object.keys(voteTotals.pm).join(', ')}`);
                    }
                });
            } else {
                console.log('‚ö†Ô∏è No pmVotes found in vote data');
            }

            // Count parlemen votes
            if (vote.parlemenVotes) {
                console.log('üìä Processing parlemenVotes:', vote.parlemenVotes);
                Object.entries(vote.parlemenVotes).forEach(([name, count]) => {
                    console.log(`üìä Checking parlemen candidate: "${name}" with ${count} votes`);
                    console.log(`üìä Available parlemen candidates:`, Object.keys(voteTotals.parlemen));
                    console.log(`üìä Candidate exists in totals:`, voteTotals.parlemen[name] !== undefined);

                    if (voteTotals.parlemen[name] !== undefined) {
                        const oldTotal = voteTotals.parlemen[name];
                        voteTotals.parlemen[name] += parseInt(count) || 0;
                        console.log(`‚úÖ Added ${count} parlemen votes for "${name}" (${oldTotal} ‚Üí ${voteTotals.parlemen[name]})`);
                    } else {
                        console.warn(`‚ö†Ô∏è Parlemen candidate "${name}" not found in voteTotals. Available: ${Object.keys(voteTotals.parlemen).join(', ')}`);
                    }
                });
            } else {
                console.log('‚ö†Ô∏è No parlemenVotes found in vote data');
            }

            console.log('üîÑ Dashboard vote processing complete. Updated totals:', voteTotals);
        }

        // Display vote data from API
        async function displayVoteDataFromAPI(apiVotes, container) {
            console.log('üîÑ Processing API vote data for display...');

            try {
                // Get users data for vote history
                const users = await window.kpuDB.getUsers();
                console.log('üë• Users data from API:', users);

                // Calculate vote totals from API data
                const voteTotals = initializeVoteTotals();

                // Process API vote results
                apiVotes.forEach(result => {
                    const category = result.category;
                    const candidateName = result.candidate_name;
                    const votes = parseInt(result.total_votes) || 0;

                    if (voteTotals[category] && candidateName) {
                        if (voteTotals[category][candidateName] !== undefined) {
                            voteTotals[category][candidateName] = votes;
                            console.log(`‚úÖ API result: ${category} - ${candidateName}: ${votes} votes`);
                        } else {
                            // Add new candidate if not in initialized totals
                            voteTotals[category][candidateName] = votes;
                            console.log(`‚úÖ Added new candidate from API: ${category} - ${candidateName}: ${votes} votes`);
                        }
                    }
                });

                console.log('üìä Final vote totals from API:', voteTotals);

                // Display vote totals
                displayVoteTotals(voteTotals, container);

                // Display vote history from users who have voted
                const votedUsers = users.filter(user => user.status === 'Sudah Voting');
                console.log(`üë• Found ${votedUsers.length} users who have voted`);

                displayVoteHistory(votedUsers, container);

            } catch (error) {
                console.error('‚ùå Error displaying API vote data:', error);
                container.innerHTML = '<p class="text-red-500 text-center py-8">Error loading vote data from API.</p>';
            }
        }

        // Display vote totals in the container
        function displayVoteTotals(voteTotals, container) {
            let html = '<div class="space-y-6">';

            // Presiden section
            html += '<div class="bg-white rounded-lg shadow p-6">';
            html += '<h3 class="text-lg font-semibold mb-4 text-blue-600">Presiden & Wakil Presiden</h3>';
            html += '<div class="space-y-2">';
            Object.entries(voteTotals.presiden).forEach(([name, count]) => {
                html += `<div class="flex justify-between items-center p-2 bg-gray-50 rounded">`;
                html += `<span class="font-medium">${name}</span>`;
                html += `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">${count} suara</span>`;
                html += `</div>`;
            });
            html += '</div></div>';

            // PM section
            html += '<div class="bg-white rounded-lg shadow p-6">';
            html += '<h3 class="text-lg font-semibold mb-4 text-green-600">Perdana Menteri</h3>';
            html += '<div class="space-y-2">';
            Object.entries(voteTotals.pm).forEach(([name, count]) => {
                html += `<div class="flex justify-between items-center p-2 bg-gray-50 rounded">`;
                html += `<span class="font-medium">${name}</span>`;
                html += `<span class="bg-green-100 text-green-800 px-2 py-1 rounded">${count} suara</span>`;
                html += `</div>`;
            });
            html += '</div></div>';

            // Parlemen section
            html += '<div class="bg-white rounded-lg shadow p-6">';
            html += '<h3 class="text-lg font-semibold mb-4 text-purple-600">Ketua Parlemen</h3>';
            html += '<div class="space-y-2">';
            Object.entries(voteTotals.parlemen).forEach(([name, count]) => {
                html += `<div class="flex justify-between items-center p-2 bg-gray-50 rounded">`;
                html += `<span class="font-medium">${name}</span>`;
                html += `<span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">${count} suara</span>`;
                html += `</div>`;
            });
            html += '</div></div>';

            html += '</div>';

            container.innerHTML = html;
        }

        // Display vote history from users
        function displayVoteHistory(votedUsers, container) {
            if (votedUsers.length === 0) {
                container.innerHTML += '<div class="mt-6 bg-white rounded-lg shadow p-6"><p class="text-gray-500 text-center">Belum ada riwayat voting.</p></div>';
                return;
            }

            let historyHtml = '<div class="mt-6 bg-white rounded-lg shadow p-6">';
            historyHtml += `<h3 class="text-lg font-semibold mb-4">Riwayat Voting (${votedUsers.length} suara)</h3>`;
            historyHtml += '<div class="overflow-x-auto">';
            historyHtml += '<table class="min-w-full table-auto">';
            historyHtml += '<thead class="bg-gray-50">';
            historyHtml += '<tr><th class="px-4 py-2 text-left">Nama</th><th class="px-4 py-2 text-left">Username</th><th class="px-4 py-2 text-left">Waktu</th><th class="px-4 py-2 text-left">Aksi</th></tr>';
            historyHtml += '</thead><tbody>';

            votedUsers.forEach((user, index) => {
                const lastLogin = user.last_login ? new Date(user.last_login).toLocaleString() : 'N/A';
                historyHtml += '<tr class="border-b">';
                historyHtml += `<td class="px-4 py-2">${user.name}</td>`;
                historyHtml += `<td class="px-4 py-2">${user.username}</td>`;
                historyHtml += `<td class="px-4 py-2">${lastLogin}</td>`;
                historyHtml += `<td class="px-4 py-2"><button onclick="showUserVoteDetail('${user.id}')" class="bg-blue-500 text-white px-2 py-1 rounded text-sm hover:bg-blue-600">Detail</button></td>`;
                historyHtml += '</tr>';
            });

            historyHtml += '</tbody></table></div></div>';

            container.innerHTML += historyHtml;
        }

        // Show user vote detail from API
        async function showUserVoteDetail(userId) {
            try {
                console.log(`üîç Loading vote detail for user: ${userId}`);

                if (!window.kpuDB || !isAdminOnline) {
                    alert('‚ùå API tidak tersedia. Tidak dapat menampilkan detail vote.');
                    return;
                }

                // Get user vote details from API
                const userVotes = await window.kpuDB.apiCall('get_user_votes', 'GET', { user_id: userId });
                console.log('üìä User vote details from API:', userVotes);

                if (!userVotes || userVotes.length === 0) {
                    alert('‚ö†Ô∏è Tidak ada data vote untuk user ini.');
                    return;
                }

                // Get user info
                const users = await window.kpuDB.getUsers();
                const user = users.find(u => u.id === userId);
                const userName = user ? user.name : 'Unknown';
                const username = user ? user.username : 'Unknown';

                let details = `Detail Suara - ${userName} (${username})\n\n`;

                // Group votes by category
                const votesByCategory = {
                    presiden: [],
                    pm: [],
                    parlemen: []
                };

                userVotes.forEach(vote => {
                    if (votesByCategory[vote.category]) {
                        votesByCategory[vote.category].push(vote);
                    }
                });

                // Display votes by category
                if (votesByCategory.presiden.length > 0) {
                    details += `PRESIDEN & WAKIL PRESIDEN:\n`;
                    votesByCategory.presiden.forEach(vote => {
                        details += `‚Ä¢ ${vote.candidate_name || vote.candidate_id}: ${vote.vote_count} suara\n`;
                    });
                    details += `\n`;
                }

                if (votesByCategory.pm.length > 0) {
                    details += `PERDANA MENTERI:\n`;
                    votesByCategory.pm.forEach(vote => {
                        details += `‚Ä¢ ${vote.candidate_name || vote.candidate_id}: ${vote.vote_count} suara\n`;
                    });
                    details += `\n`;
                }

                if (votesByCategory.parlemen.length > 0) {
                    details += `KETUA PARLEMEN:\n`;
                    votesByCategory.parlemen.forEach(vote => {
                        details += `‚Ä¢ ${vote.candidate_name || vote.candidate_id}: ${vote.vote_count} suara\n`;
                    });
                }

                alert(details);

            } catch (error) {
                console.error('‚ùå Error loading user vote detail:', error);
                alert('‚ùå Error loading vote detail. Check console for details.');
            }
        }

        // Helper function to map candidate_id to candidate name (DATABASE COMPATIBLE)
        function getCandidateNameFromId(candidateId, category) {
            // Map candidate IDs to CORRECT names (UPDATED TO MATCH DATABASE)
            const candidateMapping = {
                'presiden': {
                    'presiden1': 'NENENG & INAYAH',
                    'presiden2': 'AISYAH & EVI'
                },
                'pm': {
                    'pm1': 'KUKUH',
                    'pm2': 'SAYYIDAH'
                },
                'parlemen': {
                    'parlemen1': 'ADINUR KHOLIFAH',
                    'parlemen2': 'ENI FATMAWATI',
                    'parlemen3': 'FAIZAH MAULIDA',
                    'parlemen4': 'AHMAD NASHUKA'
                }
            };

            if (candidateMapping[category] && candidateMapping[category][candidateId]) {
                console.log(`‚úÖ Mapped ${candidateId} to "${candidateMapping[category][candidateId]}"`);
                return candidateMapping[category][candidateId];
            }

            // Try to get from dynamic candidate names if available
            if (window.candidateNames) {
                const nameKey = `${candidateId}-name`;
                if (window.candidateNames[nameKey]) {
                    console.log(`‚úÖ Mapped ${candidateId} to "${window.candidateNames[nameKey]}" from dynamic names`);
                    return window.candidateNames[nameKey];
                }
            }

            console.warn(`‚ö†Ô∏è Could not map candidate_id "${candidateId}" to name for category "${category}"`);
            return candidateId; // Fallback to ID itself
        }

        // Load voting data display (DATABASE ONLY - NO LOCALSTORAGE FALLBACK)
        async function loadVotingData() {
            console.log('üìä Loading voting data from database...');

            const container = document.getElementById('votingDataContainer');

            try {
                // Check if API is available
                if (!isAdminOnline || !window.kpuDB) {
                    console.error('‚ùå Database API not available');
                    container.innerHTML = '<p class="text-red-500 text-center py-8">‚ùå Database tidak tersedia. Pastikan koneksi database aktif.</p>';
                    return;
                }

                console.log('üåê Loading vote data from database API...');

                // Get vote results from API
                const apiVotes = await window.kpuDB.getVoteResults();
                console.log('üìä Database vote results:', apiVotes);

                if (apiVotes && apiVotes.length > 0) {
                    console.log(`‚úÖ Found ${apiVotes.length} vote entries from database`);
                    await displayVoteDataFromAPI(apiVotes, container);
                } else {
                    console.log('üìä No vote data found in database (database is empty)');
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada data suara yang masuk di database.</p>';
                }

            } catch (error) {
                console.error('‚ùå Error loading vote data from database:', error);
                container.innerHTML = '<p class="text-red-500 text-center py-8">‚ùå Error loading vote data from database. Check console for details.</p>';
            }
        }

        // DATABASE ONLY - NO LOCALSTORAGE PROCESSING

        // Update real-time results in the dashboard
        function updateRealTimeResults(voteTotals) {
            console.log('üîÑ updateRealTimeResults called with:', voteTotals);

            if (!voteTotals) {
                console.log('‚ö†Ô∏è No vote totals provided, skipping update');
                return;
            }

            // Add delay to ensure DOM is ready
            setTimeout(() => {
                try {
                    // Calculate total votes for percentages
                    const totalPresidenVotes = Object.values(voteTotals.presiden || {}).reduce((a, b) => a + b, 0);
                    const totalPmVotes = Object.values(voteTotals.pm || {}).reduce((a, b) => a + b, 0);
                    const totalParlemenVotes = Object.values(voteTotals.parlemen || {}).reduce((a, b) => a + b, 0);

                    console.log('üìä Calculated totals:', {
                        presiden: totalPresidenVotes,
                        pm: totalPmVotes,
                        parlemen: totalParlemenVotes
                    });

                    // Update Presiden results
                    updateCandidateResults('presiden', voteTotals.presiden || {}, totalPresidenVotes);

                    // Update PM results
                    updateCandidateResults('pm', voteTotals.pm || {}, totalPmVotes);

                    // Update Parlemen results
                    updateCandidateResults('parlemen', voteTotals.parlemen || {}, totalParlemenVotes);

                    console.log('‚úÖ Real-time results updated successfully');
                } catch (error) {
                    console.error('‚ùå Error updating real-time results:', error);
                }
            }, 100); // 100ms delay to ensure DOM is ready
        }

        // Update individual candidate results with specific selectors
        function updateCandidateResults(category, votes, totalVotes) {
            console.log(`üîÑ Updating ${category} results:`, votes, 'Total:', totalVotes);

            if (category === 'presiden') {
                updatePresidenResults(votes, totalVotes);
            } else if (category === 'pm') {
                updatePmResults(votes, totalVotes);
            } else if (category === 'parlemen') {
                updateParlemenResults(votes, totalVotes);
            }
        }

        // Update Presiden results specifically - FIXED WITH CORRECT NAMES
        function updatePresidenResults(votes, totalVotes) {
            console.log('üîÑ Updating Presiden results:', votes, 'Total votes:', totalVotes);

            // NENENG & INAYAH (CORRECT NAME)
            const nenengVotes = votes['NENENG & INAYAH'] || 0;
            const nenengPercentage = totalVotes > 0 ? Math.round((nenengVotes / totalVotes) * 100) : 0;

            // AISYAH & EVI (CORRECT NAME)
            const aisyahVotes = votes['AISYAH & EVI'] || 0;
            const aisyahPercentage = totalVotes > 0 ? Math.round((aisyahVotes / totalVotes) * 100) : 0;

            console.log(`NENENG: ${nenengVotes} votes (${nenengPercentage}%), AISYAH: ${aisyahVotes} votes (${aisyahPercentage}%)`);

            // Find Presiden section more specifically
            const presidenSection = Array.from(document.querySelectorAll('h3')).find(h => h.textContent.includes('Presiden & Wakil Presiden'));

            if (presidenSection) {
                const presidenContainer = presidenSection.parentElement;
                const candidateElements = presidenContainer.querySelectorAll('.flex.items-center.justify-between');

                console.log(`Found ${candidateElements.length} candidate elements in Presiden section`);

                // First candidate (NENENG & INAYAH)
                if (candidateElements[0]) {
                    // Try different selectors
                    let voteElement = candidateElements[0].querySelector('.text-right p.font-semibold') ||
                                     candidateElements[0].querySelector('.text-right .font-semibold') ||
                                     candidateElements[0].querySelector('p.font-semibold');

                    let percentageElement = candidateElements[0].querySelector('.text-right p.text-sm') ||
                                           candidateElements[0].querySelector('.text-right .text-sm') ||
                                           candidateElements[0].querySelector('p.text-sm');

                    let progressBar = candidateElements[0].querySelector('.bg-red-600');

                    console.log('NENENG elements found:', {
                        voteElement: !!voteElement,
                        percentageElement: !!percentageElement,
                        progressBar: !!progressBar
                    });

                    // If still not found, try more generic selectors
                    if (!voteElement) {
                        const allP = candidateElements[0].querySelectorAll('p');
                        voteElement = Array.from(allP).find(p => p.textContent.includes('suara'));
                        console.log('Found vote element with generic selector:', !!voteElement);
                    }

                    if (!percentageElement) {
                        const allP = candidateElements[0].querySelectorAll('p');
                        percentageElement = Array.from(allP).find(p => p.textContent.includes('%'));
                        console.log('Found percentage element with generic selector:', !!percentageElement);
                    }

                    if (voteElement) {
                        voteElement.textContent = `${nenengVotes} suara`;
                        console.log(`‚úÖ Updated NENENG votes: ${nenengVotes} suara`);
                    }
                    if (percentageElement) {
                        percentageElement.textContent = `${nenengPercentage}%`;
                        console.log(`‚úÖ Updated NENENG percentage: ${nenengPercentage}%`);
                    }
                    if (progressBar) {
                        progressBar.style.width = `${nenengPercentage}%`;
                        console.log(`‚úÖ Updated NENENG progress bar: ${nenengPercentage}%`);
                    }
                }

                // Second candidate (AISYAH & EVI)
                if (candidateElements[1]) {
                    // Try different selectors
                    let voteElement = candidateElements[1].querySelector('.text-right p.font-semibold') ||
                                     candidateElements[1].querySelector('.text-right .font-semibold') ||
                                     candidateElements[1].querySelector('p.font-semibold');

                    let percentageElement = candidateElements[1].querySelector('.text-right p.text-sm') ||
                                           candidateElements[1].querySelector('.text-right .text-sm') ||
                                           candidateElements[1].querySelector('p.text-sm');

                    let progressBar = candidateElements[1].querySelector('.bg-blue-600');

                    console.log('AISYAH elements found:', {
                        voteElement: !!voteElement,
                        percentageElement: !!percentageElement,
                        progressBar: !!progressBar
                    });

                    // If still not found, try more generic selectors
                    if (!voteElement) {
                        const allP = candidateElements[1].querySelectorAll('p');
                        voteElement = Array.from(allP).find(p => p.textContent.includes('suara'));
                        console.log('Found AISYAH vote element with generic selector:', !!voteElement);
                    }

                    if (!percentageElement) {
                        const allP = candidateElements[1].querySelectorAll('p');
                        percentageElement = Array.from(allP).find(p => p.textContent.includes('%'));
                        console.log('Found AISYAH percentage element with generic selector:', !!percentageElement);
                    }

                    if (voteElement) {
                        voteElement.textContent = `${aisyahVotes} suara`;
                        console.log(`‚úÖ Updated AISYAH votes: ${aisyahVotes} suara`);
                    }
                    if (percentageElement) {
                        percentageElement.textContent = `${aisyahPercentage}%`;
                        console.log(`‚úÖ Updated AISYAH percentage: ${aisyahPercentage}%`);
                    }
                    if (progressBar) {
                        progressBar.style.width = `${aisyahPercentage}%`;
                        console.log(`‚úÖ Updated AISYAH progress bar: ${aisyahPercentage}%`);
                    }
                }
            } else {
                console.error('‚ùå Presiden section not found!');
            }
        }

        // Update PM results specifically - FIXED WITH CORRECT NAMES
        function updatePmResults(votes, totalVotes) {
            // KUKUH (CORRECT NAME)
            const kukuhVotes = votes['KUKUH'] || 0;
            const kukuhPercentage = totalVotes > 0 ? Math.round((kukuhVotes / totalVotes) * 100) : 0;

            // SAYYIDAH (CORRECT NAME)
            const sayyidahVotes = votes['SAYYIDAH'] || 0;
            const sayyidahPercentage = totalVotes > 0 ? Math.round((sayyidahVotes / totalVotes) * 100) : 0;

            // Update PM section
            const pmSection = Array.from(document.querySelectorAll('h3')).find(h => h.textContent.includes('Perdana Menteri'));

            if (pmSection) {
                const pmContainer = pmSection.parentElement;
                const candidateElements = pmContainer.querySelectorAll('.flex.items-center.justify-between');

                // First candidate (KUKUH)
                if (candidateElements[0]) {
                    const voteElement = candidateElements[0].querySelector('.text-right .font-semibold');
                    const percentageElement = candidateElements[0].querySelector('.text-right .text-sm');
                    const progressBar = candidateElements[0].querySelector('.bg-green-600');

                    if (voteElement) voteElement.textContent = `${kukuhVotes} suara`;
                    if (percentageElement) percentageElement.textContent = `${kukuhPercentage}%`;
                    if (progressBar) progressBar.style.width = `${kukuhPercentage}%`;
                }

                // Second candidate (SAYYIDAH)
                if (candidateElements[1]) {
                    const voteElement = candidateElements[1].querySelector('.text-right .font-semibold');
                    const percentageElement = candidateElements[1].querySelector('.text-right .text-sm');
                    const progressBar = candidateElements[1].querySelector('.bg-teal-600');

                    if (voteElement) voteElement.textContent = `${sayyidahVotes} suara`;
                    if (percentageElement) percentageElement.textContent = `${sayyidahPercentage}%`;
                    if (progressBar) progressBar.style.width = `${sayyidahPercentage}%`;
                }
            }
        }

        // Update Parlemen results specifically - FIXED WITH CORRECT NAMES
        function updateParlemenResults(votes, totalVotes) {
            const candidates = [
                { name: 'ADINUR KHOLIFAH', votes: votes['ADINUR KHOLIFAH'] || 0 },
                { name: 'ENI FATMAWATI', votes: votes['ENI FATMAWATI'] || 0 },
                { name: 'FAIZAH MAULIDA', votes: votes['FAIZAH MAULIDA'] || 0 },
                { name: 'AHMAD NASHUKA', votes: votes['AHMAD NASHUKA'] || 0 }
            ];

            // Update Parlemen section
            const parlemenSection = Array.from(document.querySelectorAll('h3')).find(h => h.textContent.includes('Ketua Parlemen'));

            if (parlemenSection) {
                const parlemenContainer = parlemenSection.parentElement;
                const candidateElements = parlemenContainer.querySelectorAll('.flex.items-center.justify-between');

                candidates.forEach((candidate, index) => {
                    const percentage = totalVotes > 0 ? Math.round((candidate.votes / totalVotes) * 100) : 0;

                    if (candidateElements[index]) {
                        const voteElement = candidateElements[index].querySelector('.text-right .font-semibold');
                        const percentageElement = candidateElements[index].querySelector('.text-right .text-xs');

                        if (voteElement) voteElement.textContent = `${candidate.votes} suara`;
                        if (percentageElement) percentageElement.textContent = `${percentage}%`;
                    }
                });
            }
        }

        // Show vote detail (with format debugging)
        function showVoteDetail(voteIndex) {
            const votes = getVotes();
            const vote = votes[voteIndex];
            if (!vote) {
                alert('‚ùå Vote data not found!');
                return;
            }

            console.log('üîç DEBUG: Vote detail for index', voteIndex, ':', vote);

            let details = `Detail Suara - ${vote.name || 'Unknown'} (${vote.username || 'Unknown'})\n\n`;
            details += `Waktu: ${new Date(vote.timestamp).toLocaleString()}\n\n`;

            // Debug: Show raw vote structure
            details += `DEBUG - Vote Structure:\n`;
            details += `Format: ${vote.votes ? 'API Format' : 'Dashboard Format'}\n`;
            details += `Keys: ${Object.keys(vote).join(', ')}\n\n`;

            // Handle different vote formats
            if (vote.votes && Array.isArray(vote.votes)) {
                // API format: {user_id, category, votes: [{candidate_id, count}]}
                details += `CATEGORY: ${vote.category.toUpperCase()}\n`;
                vote.votes.forEach(voteEntry => {
                    const candidateName = getCandidateNameFromId(voteEntry.candidate_id, vote.category);
                    details += `‚Ä¢ ${candidateName}: ${voteEntry.count} suara\n`;
                });
            } else {
                // Dashboard format: {presidenVotes: {}, pmVotes: {}, parlemenVotes: {}}
                if (vote.presidenVotes) {
                    details += `PRESIDEN & WAKIL PRESIDEN:\n`;
                    Object.entries(vote.presidenVotes).forEach(([name, count]) => {
                        details += `‚Ä¢ ${name}: ${count} suara\n`;
                    });
                    details += `\n`;
                }

                if (vote.pmVotes) {
                    details += `PERDANA MENTERI:\n`;
                    Object.entries(vote.pmVotes).forEach(([name, count]) => {
                        details += `‚Ä¢ ${name}: ${count} suara\n`;
                    });
                    details += `\n`;
                }

                if (vote.parlemenVotes) {
                    details += `KETUA PARLEMEN:\n`;
                    Object.entries(vote.parlemenVotes).forEach(([name, count]) => {
                        details += `‚Ä¢ ${name}: ${count} suara\n`;
                    });
                }
            }

            // Show raw JSON for debugging
            details += `\n--- RAW DATA ---\n`;
            details += JSON.stringify(vote, null, 2);

            alert(details);
        }

        // Load recent activity
        function loadRecentActivity() {
            const users = getUsers();
            const votes = getVotes();
            const container = document.getElementById('recentActivityContainer');

            const activities = [];

            // Add voting activities
            votes.forEach(vote => {
                activities.push({
                    type: 'vote',
                    message: `Suara baru dari ${vote.name || vote.username}`,
                    time: new Date(vote.timestamp),
                    color: 'green'
                });
            });

            // Add user registration activities
            users.forEach(user => {
                if (user.registeredAt) {
                    activities.push({
                        type: 'register',
                        message: `Pengguna baru terdaftar: ${user.name}`,
                        time: new Date(user.registeredAt),
                        color: 'blue'
                    });
                }
            });

            // Sort by time (newest first)
            activities.sort((a, b) => b.time - a.time);

            // Take only the latest 10 activities
            const recentActivities = activities.slice(0, 10);

            if (recentActivities.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada aktivitas.</p>';
                return;
            }

            let html = '';
            recentActivities.forEach(activity => {
                const timeAgo = getTimeAgo(activity.time);
                html += `
                    <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-lg">
                        <div class="w-2 h-2 bg-${activity.color}-500 rounded-full"></div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900">${activity.message}</p>
                            <p class="text-xs text-gray-500">${timeAgo}</p>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Helper function to get time ago
        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);

            if (diffInSeconds < 60) return `${diffInSeconds} detik yang lalu`;
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} menit yang lalu`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} jam yang lalu`;
            return `${Math.floor(diffInSeconds / 86400)} hari yang lalu`;
        }

        // Refresh voting data
        function refreshVotingData() {
            loadVotingData();
            loadRecentActivity();
            updateStatistics();
            alert('Data berhasil direfresh!');
        }

        // Show sync data modal
        function showSyncDataModal() {
            console.log('üîÑ Opening sync data modal...');

            // Load current data info
            loadSyncDataInfo();

            // Show modal
            const modal = document.getElementById('syncDataModal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        // Close sync data modal
        function closeSyncDataModal() {
            const modal = document.getElementById('syncDataModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // Load sync data information
        async function loadSyncDataInfo() {
            try {
                // Get local data
                const localUsers = getUsers();
                const localVotes = getVotes();
                const localStatus = getElectionStatus();

                // Update local data display
                document.getElementById('localUsersCount').textContent = localUsers.length;
                document.getElementById('localVotesCount').textContent = localVotes.length;
                document.getElementById('localStatus').textContent = localStatus;

                // Get cloud data if available
                if (isAdminOnline && window.kpuDB) {
                    try {
                        const cloudUsers = await window.kpuDB.getUsers();
                        const cloudVotes = await window.kpuDB.getVoteResults();

                        document.getElementById('cloudUsersCount').textContent = cloudUsers ? cloudUsers.length : 0;
                        document.getElementById('cloudVotesCount').textContent = cloudVotes ? cloudVotes.length : 0;
                        document.getElementById('cloudStatus').textContent = 'Online';
                    } catch (error) {
                        console.error('‚ùå Error loading cloud data:', error);
                        document.getElementById('cloudUsersCount').textContent = 'Error';
                        document.getElementById('cloudVotesCount').textContent = 'Error';
                        document.getElementById('cloudStatus').textContent = 'Offline';
                    }
                } else {
                    document.getElementById('cloudUsersCount').textContent = 'Offline';
                    document.getElementById('cloudVotesCount').textContent = 'Offline';
                    document.getElementById('cloudStatus').textContent = 'Offline';
                }
            } catch (error) {
                console.error('‚ùå Error loading sync data info:', error);
            }
        }

        // Sync local to cloud (force overwrite)
        async function syncLocalToCloud() {
            if (!confirm('‚ö†Ô∏è PERINGATAN: Ini akan MENGHAPUS semua data di cloud dan menggantinya dengan data lokal. Lanjutkan?')) {
                return;
            }

            try {
                console.log('üì§ Syncing local data to cloud...');

                if (!isAdminOnline || !window.kpuDB) {
                    alert('‚ùå Database tidak tersedia. Pastikan koneksi internet dan database aktif.');
                    return;
                }

                // Get local data
                const localUsers = getUsers();
                const localVotes = getVotes();

                // Clear cloud data first
                console.log('üóëÔ∏è Clearing cloud data...');
                await window.kpuDB.resetAllVotes();

                // Upload users
                console.log('üë• Uploading users to cloud...');
                for (const user of localUsers) {
                    try {
                        await window.kpuDB.updateUser(user.id, {
                            name: user.name,
                            username: user.username,
                            password: user.password,
                            vote_count: user.voteCount || 20,
                            verified: user.verified || false,
                            status: user.status || 'Belum Voting'
                        });
                    } catch (error) {
                        console.error(`‚ùå Failed to upload user ${user.username}:`, error);
                    }
                }

                // Note: Votes will be uploaded when users vote again
                console.log('‚úÖ Local data synced to cloud successfully');
                alert('‚úÖ Data lokal berhasil di-sync ke cloud!');

                // Refresh data info
                loadSyncDataInfo();

            } catch (error) {
                console.error('‚ùå Error syncing local to cloud:', error);
                alert('‚ùå Error syncing data. Check console for details.');
            }
        }

        // Sync cloud to local (force overwrite)
        async function syncCloudToLocal() {
            if (!confirm('‚ö†Ô∏è PERINGATAN: Ini akan MENGHAPUS semua data lokal dan menggantinya dengan data cloud. Lanjutkan?')) {
                return;
            }

            try {
                console.log('üì• Syncing cloud data to local...');

                if (!isAdminOnline || !window.kpuDB) {
                    alert('‚ùå Database tidak tersedia. Pastikan koneksi internet dan database aktif.');
                    return;
                }

                // Get cloud data
                const cloudUsers = await window.kpuDB.getUsers();
                const cloudVotes = await window.kpuDB.getVoteResults();

                // Clear local data first
                console.log('üóëÔ∏è Clearing local data...');
                localStorage.removeItem(STORAGE_KEYS.USERS);
                localStorage.removeItem(STORAGE_KEYS.VOTES);

                // Download users
                console.log('üë• Downloading users from cloud...');
                if (cloudUsers && cloudUsers.length > 0) {
                    const formattedUsers = cloudUsers.map(user => ({
                        id: user.id,
                        name: user.name,
                        username: user.username,
                        password: user.password,
                        voteCount: user.vote_count || 20,
                        status: user.status || 'Belum Voting',
                        verified: user.verified || false,
                        registeredAt: user.created_at || new Date().toISOString(),
                        lastLogin: user.last_login
                    }));
                    localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(formattedUsers));
                }

                // Download votes (convert API format to localStorage format)
                console.log('üó≥Ô∏è Downloading votes from cloud...');
                if (cloudVotes && cloudVotes.length > 0) {
                    // Note: This is complex conversion, for now just clear votes
                    localStorage.setItem(STORAGE_KEYS.VOTES, JSON.stringify([]));
                }

                console.log('‚úÖ Cloud data synced to local successfully');
                alert('‚úÖ Data cloud berhasil di-sync ke lokal!');

                // Refresh UI
                loadUsersTable();
                loadVotingData();
                updateStatistics();
                loadSyncDataInfo();

            } catch (error) {
                console.error('‚ùå Error syncing cloud to local:', error);
                alert('‚ùå Error syncing data. Check console for details.');
            }
        }

        // DEPRECATED: Old initialization function - replaced by enhanced version below
        // This function is kept for compatibility but not used

        // Initialize real-time display with zero values - UPDATED WITH CORRECT NAMES
        function initializeRealTimeDisplay() {
            const emptyVoteTotals = {
                presiden: {
                    'NENENG & INAYAH': 0,
                    'AISYAH & EVI': 0
                },
                pm: {
                    'KUKUH': 0,
                    'SAYYIDAH': 0
                },
                parlemen: {
                    'ADINUR KHOLIFAH': 0,
                    'ENI FATMAWATI': 0,
                    'FAIZAH MAULIDA': 0,
                    'AHMAD NASHUKA': 0
                }
            };

            // Set initial display to 0 votes, 0%
            updateRealTimeResults(emptyVoteTotals);
            console.log('üìä Real-time display initialized with zero values - CORRECT NAMES');
        }

        // Tambahkan timestamp update
        function addUpdateTimestamp() {
            const adminTitle = document.querySelector('.text-xl.font-semibold.text-gray-900');
            if (adminTitle && adminTitle.parentElement) {
                const timestamp = document.createElement('p');
                timestamp.className = 'text-xs text-gray-500 mt-1';
                timestamp.textContent = `Terakhir update: ${new Date().toLocaleString()}`;
                adminTitle.parentElement.appendChild(timestamp);

                // Update timestamp setiap detik
                setInterval(() => {
                    timestamp.textContent = `Terakhir update: ${new Date().toLocaleString()}`;
                }, 1000);
            }
        }

        // ========================================
        // ELECTION MANAGEMENT FUNCTIONS
        // ========================================

        // Election status management
        const ELECTION_STATUS_KEY = 'election_status';

        function getElectionStatus() {
            return localStorage.getItem(ELECTION_STATUS_KEY) || 'stopped';
        }

        async function setElectionStatus(status) {
            console.log('üîÑ Setting election status to:', status);

            // Update localStorage first
            localStorage.setItem(ELECTION_STATUS_KEY, status);

            // Sync to MySQL database using correct API
            try {
                console.log('üåê Syncing election status to database...');
                const response = await fetch('database/kpu_api.php?action=update_election_status', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        status: status
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Election status synced to database:', result);
                } else {
                    console.error('‚ùå Failed to sync election status to database:', response.status);
                }
            } catch (error) {
                console.error('‚ùå Error syncing election status:', error);
            }

            updateElectionStatusDisplay();
        }

        function updateElectionStatusDisplay() {
            const status = getElectionStatus();
            const statusElement = document.querySelector('.election-status');

            if (statusElement) {
                statusElement.textContent = status === 'running' ? 'AKTIF' :
                                          status === 'ended' ? 'BERAKHIR' : 'BELUM DIMULAI';
                statusElement.className = `election-status px-2 py-1 rounded text-xs font-medium ${
                    status === 'running' ? 'bg-green-100 text-green-800' :
                    status === 'ended' ? 'bg-red-100 text-red-800' :
                    'bg-gray-100 text-gray-800'
                }`;
            }
        }

        // Start Election
        async function startElection() {
            if (confirm('Apakah Anda yakin ingin memulai pemilihan? Semua pemilih akan dapat melakukan voting.')) {
                await setElectionStatus('running');

                // Log activity
                logActivity('SYSTEM', 'Pemilihan dimulai oleh admin', 'election');

                alert('‚úÖ Pemilihan telah dimulai! Semua pemilih sekarang dapat melakukan voting.');
                console.log('üöÄ Election started at:', new Date().toLocaleString());
            }
        }

        // Stop Election (Reset to Not Started)
        async function stopElection() {
            if (confirm('Apakah Anda yakin ingin mereset pemilihan ke status "Belum Dimulai"? Pemilih tidak akan dapat voting.')) {
                await setElectionStatus('stopped');

                // Log activity
                logActivity('SYSTEM', 'Pemilihan direset ke belum dimulai oleh admin', 'election');

                alert('‚èπÔ∏è Pemilihan telah direset ke status "Belum Dimulai"! Voting dihentikan.');
                console.log('‚èπÔ∏è Election reset to stopped at:', new Date().toLocaleString());
            }
        }

        // End Election
        async function endElection() {
            if (confirm('Apakah Anda yakin ingin mengakhiri pemilihan? Ini akan menghentikan semua voting secara permanen!')) {
                if (confirm('PERINGATAN: Tindakan ini tidak dapat dibatalkan! Lanjutkan?')) {
                    await setElectionStatus('ended');

                    // Log activity
                    logActivity('SYSTEM', 'Pemilihan diakhiri oleh admin', 'election');

                    alert('üî¥ Pemilihan telah diakhiri! Tidak ada voting yang dapat dilakukan lagi.');
                    console.log('üî¥ Election ended at:', new Date().toLocaleString());
                }
            }
        }

        // Export Results
        function exportResults() {
            try {
                const votes = getVotes();
                const users = getUsers();
                const stats = getStats();

                if (votes.length === 0) {
                    alert('‚ö†Ô∏è Belum ada data voting untuk diekspor!');
                    return;
                }

                // Calculate results
                const results = calculateDetailedResults();

                // Create export data
                const exportData = {
                    metadata: {
                        exportDate: new Date().toISOString(),
                        totalVoters: users.length,
                        totalVotes: votes.length,
                        participation: stats.participation + '%',
                        electionStatus: getElectionStatus()
                    },
                    summary: results.summary,
                    detailedVotes: votes,
                    votersList: users.map(user => ({
                        id: user.id,
                        name: user.name,
                        username: user.username,
                        status: user.status,
                        voteCount: user.voteCount
                    }))
                };

                // Download as JSON
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `hasil-pemilihan-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                // Log activity
                logActivity('ADMIN', 'Hasil pemilihan diekspor', 'export');

                alert('‚úÖ Hasil pemilihan berhasil diekspor!');
                console.log('üìä Results exported successfully');

            } catch (error) {
                console.error('Error exporting results:', error);
                alert('‚ùå Gagal mengekspor hasil pemilihan!');
            }
        }

        function calculateDetailedResults() {
            const votes = getVotes();

            const results = {
                presiden: {},
                pm: {},
                parlemen: {}
            };

            votes.forEach(vote => {
                // Count presiden votes
                Object.entries(vote.presidenVotes || {}).forEach(([name, count]) => {
                    results.presiden[name] = (results.presiden[name] || 0) + count;
                });

                // Count PM votes
                Object.entries(vote.pmVotes || {}).forEach(([name, count]) => {
                    results.pm[name] = (results.pm[name] || 0) + count;
                });

                // Count parlemen votes
                Object.entries(vote.parlemenVotes || {}).forEach(([name, count]) => {
                    results.parlemen[name] = (results.parlemen[name] || 0) + count;
                });
            });

            // Calculate percentages
            const summary = {};
            ['presiden', 'pm', 'parlemen'].forEach(category => {
                const totalVotes = Object.values(results[category]).reduce((a, b) => a + b, 0);
                summary[category] = {};

                Object.entries(results[category]).forEach(([name, votes]) => {
                    const percentage = totalVotes > 0 ? ((votes / totalVotes) * 100).toFixed(2) : 0;
                    summary[category][name] = {
                        votes: votes,
                        percentage: percentage + '%'
                    };
                });
            });

            return { summary, raw: results };
        }

        // ========================================
        // USER MANAGEMENT FUNCTIONS
        // ========================================

        // Show Voters List
        async function showVotersList() {
            try {
                console.log('üë• Loading voters list...');
                let users = [];

                if (isAdminOnline && window.kpuDB) {
                    console.log('üåê Loading voters from database...');
                    users = await window.kpuDB.getUsers();
                    console.log('‚úÖ Voters loaded from database:', users.length, 'users');
                } else {
                    console.log('üíæ Loading voters from localStorage...');
                    users = getUsers();
                    console.log('üì± Voters loaded from localStorage:', users.length, 'users');
                }

                let message = `üìä DAFTAR PEMILIH (${users.length} orang)\n\n`;

                users.forEach((user, index) => {
                    message += `${index + 1}. ${user.name}\n`;
                    message += `   Username: ${user.username}\n`;
                    message += `   Status: ${user.status || 'Belum Voting'}\n`;
                    message += `   Jatah Suara: ${user.vote_count || user.voteCount || 20}\n`;
                    message += `   Verified: ${user.verified ? 'Ya' : 'Tidak'}\n`;
                    const regDate = user.registeredAt || user.created_at || new Date().toISOString();
                    message += `   Terdaftar: ${new Date(regDate).toLocaleDateString()}\n\n`;
                });

                // Create modal or use alert for now
                alert(message);

                // Log activity
                logActivity('ADMIN', 'Melihat daftar pemilih', 'view');
            } catch (error) {
                console.error('‚ùå Error loading voters list:', error);
                alert('‚ùå Error loading voters list. Check console for details.');
            }
        }

        // Verify Users
        async function verifyUsers() {
            try {
                console.log('üîç Loading users for verification...');
                let users = [];

                if (isAdminOnline && window.kpuDB) {
                    console.log('üåê Loading users from database...');
                    users = await window.kpuDB.getUsers();
                    console.log('‚úÖ Users loaded from database for verification');
                } else {
                    console.log('üíæ Loading users from localStorage...');
                    users = getUsers();
                    console.log('üì± Users loaded from localStorage for verification');
                }

                const unverifiedUsers = users.filter(user => !user.verified);

                if (unverifiedUsers.length === 0) {
                    alert('‚úÖ Semua pengguna sudah terverifikasi!');
                    return;
                }

                let message = `üîç PENGGUNA BELUM TERVERIFIKASI (${unverifiedUsers.length} orang)\n\n`;

                unverifiedUsers.forEach((user, index) => {
                    message += `${index + 1}. ${user.name} (${user.username})\n`;
                });

                message += '\nApakah Anda ingin memverifikasi semua pengguna?';

                if (confirm(message)) {
                    console.log('üîÑ Verifying users...');

                    if (isAdminOnline && window.kpuDB) {
                        // Update in database with complete user data
                        for (const user of unverifiedUsers) {
                            try {
                                // Ensure all required fields are present and properly typed
                                const updateData = {
                                    name: user.name || '',
                                    username: user.username || '',
                                    password: user.password || 'password123',
                                    vote_count: parseInt(user.vote_count || user.voteCount || 20),
                                    verified: true
                                };

                                console.log(`üîÑ Verifying user ${user.username} with data:`, updateData);
                                await window.kpuDB.updateUser(user.id, updateData);
                                console.log(`‚úÖ User ${user.username} verified in database with complete data`);
                            } catch (error) {
                                console.error(`‚ùå Failed to verify user ${user.username}:`, error);
                                console.error('User data:', user);
                                console.error('Update data:', updateData);
                            }
                        }
                    } else {
                        // Update in localStorage
                        users.forEach(user => {
                            if (!user.verified) {
                                user.verified = true;
                                user.verifiedAt = new Date().toISOString();
                            }
                        });
                        saveUsers(users);
                    }

                    // Refresh table
                    await loadUsersTable();

                    // Log activity
                    logActivity('ADMIN', `Memverifikasi ${unverifiedUsers.length} pengguna`, 'verify');

                    alert(`‚úÖ ${unverifiedUsers.length} pengguna berhasil diverifikasi!`);
                }
            } catch (error) {
                console.error('‚ùå Error verifying users:', error);
                alert('‚ùå Error verifying users. Check console for details.');
            }
        }

        // Reset Passwords
        async function resetPasswords() {
            if (confirm('‚ö†Ô∏è Apakah Anda yakin ingin mereset password semua pengguna ke "password123"?')) {
                try {
                    console.log('üîÑ Resetting passwords...');
                    let users = [];

                    if (isAdminOnline && window.kpuDB) {
                        console.log('üåê Loading users from database...');
                        users = await window.kpuDB.getUsers();
                        console.log('‚úÖ Users loaded from database for password reset');

                        // Update in database with complete user data
                        for (const user of users) {
                            try {
                                // Ensure all required fields are present and properly typed
                                const updateData = {
                                    name: user.name || '',
                                    username: user.username || '',
                                    password: 'password123',
                                    vote_count: parseInt(user.vote_count || user.voteCount || 20),
                                    verified: Boolean(user.verified)
                                };

                                console.log(`üîÑ Resetting password for user ${user.username} with data:`, updateData);
                                await window.kpuDB.updateUser(user.id, updateData);
                                console.log(`‚úÖ Password reset for user ${user.username} in database with complete data`);
                            } catch (error) {
                                console.error(`‚ùå Failed to reset password for user ${user.username}:`, error);
                                console.error('User data:', user);
                                console.error('Update data:', updateData);
                            }
                        }
                    } else {
                        console.log('üíæ Loading users from localStorage...');
                        users = getUsers();
                        console.log('üì± Users loaded from localStorage for password reset');

                        // Update in localStorage
                        users.forEach(user => {
                            user.password = 'password123';
                            user.passwordResetAt = new Date().toISOString();
                        });
                        saveUsers(users);
                    }

                    // Refresh table
                    await loadUsersTable();

                    // Log activity
                    logActivity('ADMIN', `Reset password ${users.length} pengguna`, 'reset');

                    alert(`‚úÖ Password ${users.length} pengguna berhasil direset ke "password123"!`);
                } catch (error) {
                    console.error('‚ùå Error resetting passwords:', error);
                    alert('‚ùå Error resetting passwords. Check console for details.');
                }
            }
        }

        // üî• ENHANCED: Show Audit Log with proper data handling
        async function showAuditLog() {
            try {
                console.log('üìù Loading audit log...');
                let activities = [];

                if (isAdminOnline && window.kpuDB) {
                    console.log('üåê Loading audit log from database...');
                    try {
                        activities = await window.kpuDB.getActivityLog();
                        console.log('‚úÖ Audit log loaded from database:', activities.length, 'activities');
                        console.log('üîç Sample database activity:', activities[0]);
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Failed to load from database, using localStorage:', error);
                        activities = JSON.parse(localStorage.getItem('audit_log') || '[]');
                    }
                } else {
                    console.log('üíæ Loading audit log from localStorage...');
                    activities = JSON.parse(localStorage.getItem('audit_log') || '[]');
                    console.log('üì± Audit log loaded from localStorage:', activities.length, 'activities');
                    console.log('üîç Sample localStorage activity:', activities[0]);
                }

                if (activities.length === 0) {
                    alert('üìù Belum ada aktivitas yang tercatat.');
                    return;
                }

                let message = `üìù AUDIT LOG (${activities.length} aktivitas terakhir)\n\n`;

                // üî• ENHANCED: Show last 20 activities with proper data handling
                activities.slice(-20).reverse().forEach((activity, index) => {
                    // Handle different timestamp formats
                    let date = 'Unknown time';
                    if (activity.timestamp) {
                        date = new Date(activity.timestamp).toLocaleString();
                    } else if (activity.created_at) {
                        date = new Date(activity.created_at).toLocaleString();
                    }

                    // Handle different user field formats
                    let user = 'Unknown User';
                    if (activity.user && activity.user !== 'undefined') {
                        user = activity.user;
                    } else if (activity.user_id && activity.user_id !== 'undefined') {
                        user = activity.user_id;
                    } else if (activity.user_type) {
                        user = activity.user_type;
                    }

                    // Handle different action field formats
                    let action = 'Unknown action';
                    if (activity.action && activity.action !== 'undefined') {
                        action = activity.action;
                    } else if (activity.details && activity.details !== 'undefined') {
                        action = activity.details;
                    } else if (activity.type) {
                        action = activity.type;
                    }

                    // üîç Debug logging for undefined values
                    if (user === 'Unknown User' || action === 'Unknown action') {
                        console.warn(`‚ö†Ô∏è Activity ${index + 1} has undefined values:`, {
                            original: activity,
                            parsed: { user, action, date }
                        });
                    }

                    message += `${index + 1}. [${date}] ${user}: ${action}\n`;
                });

                alert(message);

                // Log activity
                logActivity('ADMIN', 'Melihat audit log', 'view');
            } catch (error) {
                console.error('‚ùå Error loading audit log:', error);
                alert('‚ùå Error loading audit log. Check console for details.');
            }
        }

        // üî• ENHANCED: Log Activity Function with proper data validation
        async function logActivity(user, action, type = 'general') {
            // üî• ENHANCED: Validate and sanitize input data
            const sanitizedUser = user && user !== 'undefined' && user !== null ? String(user) : 'ADMIN';
            const sanitizedAction = action && action !== 'undefined' && action !== null ? String(action) : 'Unknown action';
            const sanitizedType = type && type !== 'undefined' && type !== null ? String(type) : 'general';

            const activity = {
                timestamp: new Date().toISOString(),
                user: sanitizedUser,
                action: sanitizedAction,
                type: sanitizedType,
                ip: 'localhost', // In real app, get actual IP
                userAgent: navigator.userAgent
            };

            console.log('üìù Logging activity:', activity);

            // Save to localStorage
            const activities = JSON.parse(localStorage.getItem('audit_log') || '[]');
            activities.push(activity);

            // Keep only last 1000 activities
            if (activities.length > 1000) {
                activities.splice(0, activities.length - 1000);
            }

            localStorage.setItem('audit_log', JSON.stringify(activities));
            console.log('‚úÖ Activity logged to localStorage');

            // Also save to database if online
            if (isAdminOnline && window.kpuDB) {
                try {
                    // üî• ENHANCED: Create database-compatible activity object
                    const dbActivity = {
                        user_type: 'ADMIN',
                        user_id: sanitizedUser,
                        action: sanitizedAction,
                        details: `${sanitizedAction} (${sanitizedType})`,
                        timestamp: activity.timestamp
                    };

                    await window.kpuDB.logActivity(dbActivity);
                    console.log('‚úÖ Activity logged to database:', sanitizedAction);
                } catch (error) {
                    console.warn('‚ö†Ô∏è Failed to log activity to database:', error);
                    console.warn('‚ö†Ô∏è Activity data that failed:', activity);
                }
            }
        }

        // ========================================
        // BULK INPUT TABLE FUNCTIONS
        // ========================================

        function initializeBulkInputTable() {
            const tableBody = document.getElementById('bulkInputTableBody');
            if (!tableBody) return;

            tableBody.innerHTML = '';

            // Add 5 empty rows initially
            for (let i = 0; i < 5; i++) {
                addBulkInputRow();
            }

            // Add paste event listener to document
            document.addEventListener('paste', handleBulkPaste);

            // Add click event to table for focus
            const bulkTable = document.getElementById('bulkInputTable');
            if (bulkTable) {
                bulkTable.addEventListener('click', function() {
                    updateBulkInputStatus('Tabel aktif. Siap untuk paste data dengan Ctrl+V atau tombol "üìã Paste dari Excel".');
                });
            }
        }

        // Manual paste function triggered by button
        async function pasteFromClipboard() {
            try {
                // Check if clipboard API is available
                if (navigator.clipboard && navigator.clipboard.readText) {
                    const text = await navigator.clipboard.readText();
                    if (text.trim()) {
                        // Simulate paste event
                        const fakeEvent = {
                            preventDefault: () => {},
                            clipboardData: {
                                getData: () => text
                            }
                        };

                        // Set focus to table
                        const firstInput = document.querySelector('#bulkInputTable input');
                        if (firstInput) firstInput.focus();

                        handleBulkPaste(fakeEvent);
                    } else {
                        updateBulkInputStatus('‚ùå Clipboard kosong. Copy data dari Excel terlebih dahulu.');
                    }
                } else {
                    // Fallback for older browsers
                    updateBulkInputStatus('‚ö†Ô∏è Browser tidak support clipboard API. Gunakan Ctrl+V di tabel.');
                    alert('üìã Clipboard API tidak tersedia.\n\nCara manual:\n1. Klik cell pertama di tabel\n2. Tekan Ctrl+V untuk paste\n\nAtau gunakan "üé≤ Generate Sample Data" untuk test.');
                }
            } catch (error) {
                console.error('Error reading clipboard:', error);
                updateBulkInputStatus('‚ùå Error reading clipboard. Gunakan Ctrl+V di tabel.');
                alert('üìã Error reading clipboard.\n\nCara manual:\n1. Klik cell pertama di tabel\n2. Tekan Ctrl+V untuk paste');
            }
        }

        function addBulkInputRow() {
            const tableBody = document.getElementById('bulkInputTableBody');
            if (!tableBody) return;

            const rowCount = tableBody.children.length + 1;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="border border-gray-300 px-2 py-1 text-center text-sm text-gray-600">${rowCount}</td>
                <td class="border border-gray-300 px-1 py-1">
                    <input type="text" class="w-full px-2 py-1 border-0 focus:ring-1 focus:ring-blue-500 text-sm"
                           placeholder="Nama lengkap" data-field="name">
                </td>
                <td class="border border-gray-300 px-1 py-1">
                    <input type="text" class="w-full px-2 py-1 border-0 focus:ring-1 focus:ring-blue-500 text-sm"
                           placeholder="username" data-field="username">
                </td>
                <td class="border border-gray-300 px-1 py-1">
                    <input type="text" class="w-full px-2 py-1 border-0 focus:ring-1 focus:ring-blue-500 text-sm"
                           placeholder="password" data-field="password">
                </td>
                <td class="border border-gray-300 px-1 py-1">
                    <input type="number" class="w-full px-2 py-1 border-0 focus:ring-1 focus:ring-blue-500 text-sm"
                           placeholder="20" min="1" max="100" value="20" data-field="voteCount">
                </td>
                <td class="border border-gray-300 px-1 py-1">
                    <select class="w-full px-2 py-1 border-0 focus:ring-1 focus:ring-blue-500 text-sm" data-field="verified">
                        <option value="false">‚ùå Belum</option>
                        <option value="true">‚úÖ Sudah</option>
                    </select>
                </td>
                <td class="border border-gray-300 px-1 py-1 text-center">
                    <button onclick="removeBulkInputRow(this)" class="text-red-600 hover:text-red-800 text-sm">üóëÔ∏è</button>
                </td>
            `;

            tableBody.appendChild(row);
            updateBulkInputStatus();
        }

        function removeBulkInputRow(button) {
            const row = button.closest('tr');
            row.remove();

            // Update row numbers
            const tableBody = document.getElementById('bulkInputTableBody');
            Array.from(tableBody.children).forEach((row, index) => {
                row.children[0].textContent = index + 1;
            });

            updateBulkInputStatus();
        }

        function clearBulkInputTable() {
            if (confirm('üóëÔ∏è Clear semua data di tabel input?')) {
                const tableBody = document.getElementById('bulkInputTableBody');
                tableBody.innerHTML = '';

                // Add 5 empty rows
                for (let i = 0; i < 5; i++) {
                    addBulkInputRow();
                }

                updateBulkInputStatus('Tabel telah di-clear. Ready untuk input data baru.');
            }
        }

        function generateSampleBulkData() {
            const sampleData = [
                ['Andi Wijaya', 'andi.wijaya', 'pass123', '25', 'true'],
                ['Sari Dewi', 'sari.dewi', 'pass456', '20', 'false'],
                ['Budi Santoso', 'budi.santoso', 'pass789', '30', 'true'],
                ['Maya Sari', 'maya.sari', 'pass321', '15', 'false'],
                ['Rudi Hartono', 'rudi.hartono', 'pass654', '20', 'true']
            ];

            clearBulkInputTable();

            const tableBody = document.getElementById('bulkInputTableBody');
            tableBody.innerHTML = '';

            sampleData.forEach((data, index) => {
                addBulkInputRow();
                const row = tableBody.children[index];
                const inputs = row.querySelectorAll('input, select');

                inputs[0].value = data[0]; // name
                inputs[1].value = data[1]; // username
                inputs[2].value = data[2]; // password
                inputs[3].value = data[3]; // voteCount
                inputs[4].value = data[4]; // verified
            });

            updateBulkInputStatus('Sample data generated! Silakan edit sesuai kebutuhan.');
        }

        function handleBulkPaste(event) {
            // Only handle paste if focus is in bulk input table
            const activeElement = document.activeElement;
            const bulkTable = document.getElementById('bulkInputTable');

            if (!bulkTable || !bulkTable.contains(activeElement)) return;

            event.preventDefault();

            const clipboardData = event.clipboardData || window.clipboardData;
            const pastedData = clipboardData.getData('text');

            if (!pastedData.trim()) {
                updateBulkInputStatus('‚ùå Clipboard kosong atau tidak ada data untuk di-paste.');
                return;
            }

            console.log('üìã Raw pasted data:', pastedData);

            try {
                // Parse pasted data - handle different formats
                let rows = pastedData.trim().split('\n');

                // Remove empty rows
                rows = rows.filter(row => row.trim().length > 0);

                if (rows.length === 0) {
                    updateBulkInputStatus('‚ùå Tidak ada data valid untuk di-paste.');
                    return;
                }

                const tableBody = document.getElementById('bulkInputTableBody');

                // Clear existing rows
                tableBody.innerHTML = '';

                let successCount = 0;

                // Process each row
                rows.forEach((rowData, index) => {
                    // Handle different separators: tab, comma, semicolon
                    let cells = [];

                    if (rowData.includes('\t')) {
                        // Excel tab-separated
                        cells = rowData.split('\t');
                    } else if (rowData.includes(',')) {
                        // Comma-separated
                        cells = rowData.split(',');
                    } else if (rowData.includes(';')) {
                        // Semicolon-separated
                        cells = rowData.split(';');
                    } else {
                        // Space-separated (fallback)
                        cells = rowData.split(/\s+/);
                    }

                    // Clean cells
                    cells = cells.map(cell => cell.trim().replace(/"/g, ''));

                    console.log(`Row ${index + 1}:`, cells);

                    // Only process if we have at least name
                    if (cells[0] && cells[0].length > 0) {
                        addBulkInputRow();
                        const row = tableBody.children[successCount];
                        const inputs = row.querySelectorAll('input, select');

                        // Fill data with better error handling
                        try {
                            if (cells[0]) inputs[0].value = cells[0]; // name
                            if (cells[1]) inputs[1].value = cells[1]; // username
                            if (cells[2]) inputs[2].value = cells[2]; // password
                            if (cells[3] && !isNaN(cells[3])) {
                                inputs[3].value = parseInt(cells[3]) || 20; // voteCount
                            } else {
                                inputs[3].value = 20; // default
                            }
                            if (cells[4]) {
                                const verified = cells[4].toLowerCase();
                                inputs[4].value = (verified === 'true' || verified === 'ya' || verified === '1') ? 'true' : 'false';
                            }

                            successCount++;
                        } catch (error) {
                            console.error(`Error filling row ${index + 1}:`, error);
                        }
                    }
                });

                // Add extra empty rows if needed
                while (tableBody.children.length < 5) {
                    addBulkInputRow();
                }

                updateBulkInputStatus(`‚úÖ Data berhasil di-paste! ${successCount} baris data diimport dari clipboard.`);

                // Show preview of imported data
                setTimeout(() => {
                    const preview = Array.from(tableBody.children).slice(0, successCount).map((row, index) => {
                        const inputs = row.querySelectorAll('input, select');
                        return `${index + 1}. ${inputs[0].value} | ${inputs[1].value} | ${inputs[2].value}`;
                    }).join('\n');

                    console.log('üìä Imported data preview:\n', preview);
                }, 100);

            } catch (error) {
                console.error('‚ùå Error parsing pasted data:', error);
                updateBulkInputStatus('‚ùå Error parsing data. Pastikan format: Nama | Username | Password | Suara');
            }
        }

        async function saveBulkUsers() {
            const tableBody = document.getElementById('bulkInputTableBody');
            const rows = Array.from(tableBody.children);

            const usersToSave = [];
            const errors = [];

            // Validate and collect data
            rows.forEach((row, index) => {
                const inputs = row.querySelectorAll('input, select');
                const name = inputs[0].value.trim();
                const username = inputs[1].value.trim();
                const password = inputs[2].value.trim();
                const voteCount = parseInt(inputs[3].value) || 20;
                const verified = inputs[4].value === 'true';

                if (name && username && password) {
                    const existingUsers = getUsers();
                    const newId = String(existingUsers.length + usersToSave.length + 1).padStart(3, '0');

                    // Check for duplicates
                    if (existingUsers.some(u => u.username === username) ||
                        usersToSave.some(u => u.username === username)) {
                        errors.push(`Baris ${index + 1}: Username "${username}" sudah ada`);
                        return;
                    }

                    usersToSave.push({
                        id: newId,
                        name: name,
                        username: username,
                        password: password,
                        vote_count: voteCount,
                        voteCount: voteCount, // Keep both for compatibility
                        status: 'Belum Voting',
                        verified: verified,
                        registeredAt: new Date().toISOString(),
                        lastLogin: null
                    });
                } else if (name || username || password) {
                    errors.push(`Baris ${index + 1}: Data tidak lengkap (perlu Nama, Username, Password)`);
                }
            });

            // Show errors if any
            if (errors.length > 0) {
                alert(`‚ùå Error validasi:\n\n${errors.join('\n')}\n\nSilakan perbaiki data dan coba lagi.`);
                return;
            }

            if (usersToSave.length === 0) {
                alert('‚ö†Ô∏è Tidak ada data valid untuk disimpan!');
                return;
            }

            // Confirm save
            if (!confirm(`üíæ Simpan ${usersToSave.length} users ke database?\n\n${usersToSave.map(u => `‚Ä¢ ${u.name} (${u.username})`).join('\n')}`)) {
                return;
            }

            updateBulkInputStatus('‚è≥ Menyimpan users ke database...');

            let successCount = 0;
            let failCount = 0;

            // Save each user using proper database integration
            for (const user of usersToSave) {
                try {
                    if (isAdminOnline && window.kpuDB) {
                        // Check if user already exists
                        const existingUsers = await window.kpuDB.getUsers();
                        const userExists = existingUsers.some(existingUser =>
                            existingUser.username === user.username || existingUser.id === user.id
                        );

                        if (userExists) {
                            console.warn(`‚ö†Ô∏è User ${user.username} already exists, skipping...`);
                            failCount++;
                            continue;
                        }

                        // Create new user
                        await window.kpuDB.createUser(user);
                        console.log(`‚úÖ User ${user.username} created in database`);
                        successCount++;
                    } else {
                        // Fallback to localStorage
                        const existingUsers = getUsers();
                        const userExists = existingUsers.some(existingUser =>
                            existingUser.username === user.username || existingUser.id === user.id
                        );

                        if (userExists) {
                            console.warn(`‚ö†Ô∏è User ${user.username} already exists locally, skipping...`);
                            failCount++;
                            continue;
                        }

                        // Add to localStorage
                        existingUsers.push(user);
                        localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(existingUsers));
                        console.log(`‚úÖ User ${user.username} added to localStorage`);
                        successCount++;
                    }
                } catch (error) {
                    failCount++;
                    console.error(`‚ùå Error saving user ${user.username}:`, error);
                }
            }

            // Refresh users table and log activity
            if (successCount > 0) {
                // Refresh users table to show new users
                await loadUsersTable();

                // Log activity
                logActivity('ADMIN', `Bulk import ${successCount} users`, 'bulk_create');
            }

            // Show results
            let message = `‚úÖ Bulk import selesai!\n\n`;
            message += `‚Ä¢ Berhasil: ${successCount} users\n`;
            if (failCount > 0) {
                message += `‚Ä¢ Gagal: ${failCount} users\n`;
            }
            message += `\nData telah disimpan ke database dan tabel direfresh.`;

            alert(message);
            updateBulkInputStatus(`Bulk import selesai: ${successCount} berhasil, ${failCount} gagal.`);

            // Clear table after successful save
            if (successCount > 0) {
                clearBulkInputTable();
            }
        }

        function updateBulkInputStatus(message = null) {
            const statusDiv = document.getElementById('bulkInputStatus');
            if (!statusDiv) return;

            const tableBody = document.getElementById('bulkInputTableBody');
            const filledRows = Array.from(tableBody.children).filter(row => {
                const inputs = row.querySelectorAll('input');
                return inputs[0].value.trim() || inputs[1].value.trim() || inputs[2].value.trim();
            }).length;

            if (message) {
                statusDiv.textContent = message;
                statusDiv.className = 'text-sm text-blue-600 font-medium';
            } else {
                statusDiv.textContent = `Ready untuk input data. ${filledRows} baris terisi dari ${tableBody.children.length} baris total.`;
                statusDiv.className = 'text-sm text-gray-600';
            }
        }

        // ========================================
        // CANDIDATE PHOTO MANAGEMENT
        // ========================================

        function manageCandidatePhotos(category) {
            let candidates = [];

            // Get current photos and names from UI (which should be loaded from database)
            if (category === 'presiden') {
                candidates = [
                    {
                        id: 'presiden1-photo',
                        name: document.getElementById('presiden1-name')?.textContent || 'Ahmad Rizki & Sari Indah',
                        current: document.getElementById('presiden1-photo')?.src || 'kandidat/kpulogo.jpg'
                    },
                    {
                        id: 'presiden2-photo',
                        name: document.getElementById('presiden2-name')?.textContent || 'Budi Santoso & Maya Putri',
                        current: document.getElementById('presiden2-photo')?.src || 'kandidat/kpulogo.jpg'
                    }
                ];
            } else if (category === 'pm') {
                candidates = [
                    {
                        id: 'pm1-photo',
                        name: document.getElementById('pm1-name')?.textContent || 'Dr. Andi Wijaya',
                        current: document.getElementById('pm1-photo')?.src || 'kandidat/kpulogo.jpg'
                    },
                    {
                        id: 'pm2-photo',
                        name: document.getElementById('pm2-name')?.textContent || 'Prof. Lisa Sari',
                        current: document.getElementById('pm2-photo')?.src || 'kandidat/kpulogo.jpg'
                    }
                ];
            } else if (category === 'parlemen') {
                candidates = [
                    {
                        id: 'parlemen1-photo',
                        name: document.getElementById('parlemen1-name')?.textContent || 'Rudi Hartono',
                        current: document.getElementById('parlemen1-photo')?.src || 'kandidat/kpulogo.jpg'
                    },
                    {
                        id: 'parlemen2-photo',
                        name: document.getElementById('parlemen2-name')?.textContent || 'Nina Kusuma',
                        current: document.getElementById('parlemen2-photo')?.src || 'kandidat/kpulogo.jpg'
                    },
                    {
                        id: 'parlemen3-photo',
                        name: document.getElementById('parlemen3-name')?.textContent || 'Dedi Prasetyo',
                        current: document.getElementById('parlemen3-photo')?.src || 'kandidat/kpulogo.jpg'
                    },
                    {
                        id: 'parlemen4-photo',
                        name: document.getElementById('parlemen4-name')?.textContent || 'Sinta Dewi',
                        current: document.getElementById('parlemen4-photo')?.src || 'kandidat/kpulogo.jpg'
                    }
                ];
            }

            // Create modal for photo management
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-96 overflow-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">üì∑ Kelola Foto ${category === 'presiden' ? 'Presiden' : 'PM'}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                    </div>

                    <div class="space-y-4">
                        ${candidates.map(candidate => `
                            <div class="border rounded-lg p-4">
                                <div class="flex items-center space-x-4 mb-3">
                                    <img src="${candidate.current.startsWith('data:') ? 'kandidat/kpulogo.jpg' : candidate.current}" alt="${candidate.name}" class="w-16 h-16 rounded-full object-cover border-2 border-gray-200" data-actual-src="${candidate.current}">
                                    <div>
                                        <h4 class="font-medium">${candidate.name}</h4>
                                        <p class="text-sm text-gray-500">Current: ${candidate.current.startsWith('data:') ? 'data:image/... (Base64)' : candidate.current}</p>
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-700">Ganti Foto:</label>
                                    <input type="file" accept="image/*" onchange="previewPhoto(this, '${candidate.id}')" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">

                                    <div class="flex gap-2 mt-2">
                                        <input type="url" placeholder="Atau masukkan URL foto" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" id="url-${candidate.id}">
                                        <button onclick="setPhotoFromUrl('${candidate.id}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm">Set URL</button>
                                    </div>

                                    <button onclick="resetToDefault('${candidate.id}')" class="bg-gray-500 text-white px-3 py-1 rounded text-sm">Reset ke Default</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="mt-6 flex gap-3">
                        <button onclick="saveAllPhotos()" class="bg-green-600 text-white px-4 py-2 rounded-lg">üíæ Simpan Semua</button>
                        <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 text-white px-4 py-2 rounded-lg">Batal</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Set data URLs after modal is created (to avoid HTML injection issues)
            setTimeout(() => {
                candidates.forEach(candidate => {
                    if (candidate.current.startsWith('data:')) {
                        const modalImg = modal.querySelector(`img[data-actual-src="${candidate.current}"]`);
                        if (modalImg) {
                            modalImg.src = candidate.current;
                        }
                    }
                });
            }, 100);
        }

        function previewPhoto(input, candidateId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById(candidateId);
                    if (img) {
                        img.src = e.target.result;
                        img.style.display = 'block';
                        img.nextElementSibling.style.display = 'none';
                    }

                    // Update preview in modal
                    const modalImg = input.closest('.border').querySelector('img');
                    if (modalImg) {
                        modalImg.src = e.target.result;
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function setPhotoFromUrl(candidateId) {
            const urlInput = document.getElementById(`url-${candidateId}`);
            const url = urlInput.value.trim();

            if (!url) {
                alert('‚ùå Masukkan URL foto terlebih dahulu!');
                return;
            }

            // Handle data URLs directly (no need to test loading)
            if (url.startsWith('data:image/')) {
                const candidateImg = document.getElementById(candidateId);
                if (candidateImg) {
                    candidateImg.src = url;
                    candidateImg.style.display = 'block';
                    if (candidateImg.nextElementSibling) {
                        candidateImg.nextElementSibling.style.display = 'none';
                    }
                }

                // Update preview in modal
                const modalImg = urlInput.closest('.border').querySelector('img');
                if (modalImg) {
                    modalImg.src = url;
                }

                // Update current URL display
                const currentSpan = urlInput.closest('.border').querySelector('.text-sm.text-gray-500');
                if (currentSpan) {
                    currentSpan.textContent = `Current: ${url.length > 50 ? 'data:image/... (Base64)' : url}`;
                }

                urlInput.value = '';
                alert('‚úÖ Foto berhasil diset dari data URL!');
                return;
            }

            // Test if regular URL is valid image
            const img = new Image();
            img.onload = function() {
                const candidateImg = document.getElementById(candidateId);
                if (candidateImg) {
                    candidateImg.src = url;
                    candidateImg.style.display = 'block';
                    if (candidateImg.nextElementSibling) {
                        candidateImg.nextElementSibling.style.display = 'none';
                    }
                }

                // Update preview in modal
                const modalImg = urlInput.closest('.border').querySelector('img');
                if (modalImg) {
                    modalImg.src = url;
                }

                // Update current URL display
                const currentSpan = urlInput.closest('.border').querySelector('.text-sm.text-gray-500');
                if (currentSpan) {
                    currentSpan.textContent = `Current: ${url}`;
                }

                urlInput.value = '';
                alert('‚úÖ Foto berhasil diset dari URL!');
            };

            img.onerror = function() {
                alert('‚ùå URL foto tidak valid atau tidak dapat diakses!');
            };

            img.src = url;
        }

        function resetToDefault(candidateId) {
            const defaultPhoto = 'kandidat/kpulogo.jpg';
            const img = document.getElementById(candidateId);

            if (img) {
                img.src = defaultPhoto;
                img.style.display = 'block';
                img.nextElementSibling.style.display = 'none';
            }

            // Update preview in modal
            const modal = document.querySelector('.fixed');
            const modalImg = modal.querySelector(`input[onchange*="${candidateId}"]`).closest('.border').querySelector('img');
            if (modalImg) {
                modalImg.src = defaultPhoto;
            }

            alert('‚úÖ Foto direset ke default KPU logo!');
        }

        async function saveAllPhotos() {
            try {
                console.log('üì∑ Saving all candidate photos...');

                // Collect current photo URLs
                const photoData = {};
                const candidateUpdates = [];

                const photoMappings = {
                    'presiden1-photo': { id: 'presiden1', category: 'presiden' },
                    'presiden2-photo': { id: 'presiden2', category: 'presiden' },
                    'pm1-photo': { id: 'pm1', category: 'pm' },
                    'pm2-photo': { id: 'pm2', category: 'pm' },
                    'parlemen1-photo': { id: 'parlemen1', category: 'parlemen' },
                    'parlemen2-photo': { id: 'parlemen2', category: 'parlemen' },
                    'parlemen3-photo': { id: 'parlemen3', category: 'parlemen' },
                    'parlemen4-photo': { id: 'parlemen4', category: 'parlemen' }
                };

                Object.keys(photoMappings).forEach(elementId => {
                    const img = document.getElementById(elementId);
                    if (img) {
                        const candidateInfo = photoMappings[elementId];
                        photoData[elementId] = img.src;

                        candidateUpdates.push({
                            id: candidateInfo.id,
                            photo_url: img.src,
                            category: candidateInfo.category
                        });
                    }
                });

                // Save to localStorage first
                localStorage.setItem('candidate_photos', JSON.stringify(photoData));

                // Sync to database if online
                if (isAdminOnline && window.kpuDB) {
                    console.log('üåê Syncing photos to database...');

                    for (const update of candidateUpdates) {
                        try {
                            await window.kpuDB.apiCall('update_candidate', 'PUT', {
                                id: update.id,
                                photo_url: update.photo_url
                            });
                            console.log(`‚úÖ Photo updated for ${update.id}: ${update.photo_url}`);
                        } catch (error) {
                            console.error(`‚ùå Failed to update photo for ${update.id}:`, error);
                        }
                    }

                    console.log('‚úÖ All photos synced to database');
                } else {
                    console.log('üì± Photos saved to localStorage (database offline)');
                }

                // Log activity
                logActivity('ADMIN', 'Update foto kandidat', `Updated ${candidateUpdates.length} candidate photos`);

                alert('‚úÖ Semua foto kandidat berhasil disimpan!');

                // Close modal
                document.querySelector('.fixed').remove();

                // Trigger real-time sync
                if (window.dataSync) {
                    window.dataSync.syncCandidates();
                }

            } catch (error) {
                console.error('‚ùå Error saving photos:', error);
                alert('‚ùå Gagal menyimpan foto. Silakan coba lagi.');
            }
        }

        async function loadCandidatePhotos() {
            try {
                console.log('üì∑ Loading candidate photos...');

                // Try to load from database first if online
                if (isAdminOnline && window.kpuDB) {
                    try {
                        const candidates = await window.kpuDB.apiCall('get_candidates');
                        if (candidates && candidates.length > 0) {
                            console.log('üåê Loading photos from database...');

                            const photoMappings = {
                                'presiden1': 'presiden1-photo',
                                'presiden2': 'presiden2-photo',
                                'pm1': 'pm1-photo',
                                'pm2': 'pm2-photo',
                                'parlemen1': 'parlemen1-photo',
                                'parlemen2': 'parlemen2-photo',
                                'parlemen3': 'parlemen3-photo',
                                'parlemen4': 'parlemen4-photo'
                            };

                            candidates.forEach(candidate => {
                                const elementId = photoMappings[candidate.id];
                                const photoUrl = candidate.photo_url || candidate.photo || 'kandidat/kpulogo.jpg';

                                if (elementId) {
                                    const img = document.getElementById(elementId);
                                    if (img) {
                                        // Handle data URLs safely with enhanced error handling
                                        try {
                                            // Validate data URL before assignment
                                            if (photoUrl.startsWith('data:image/')) {
                                                // Check if data URL is complete (not truncated)
                                                if (photoUrl.length < 100) {
                                                    console.warn(`‚ö†Ô∏è Data URL seems truncated for ${candidate.id} (length: ${photoUrl.length})`);
                                                    throw new Error('Data URL appears to be truncated');
                                                }

                                                // Test data URL validity
                                                const testImg = new Image();
                                                testImg.onload = function() {
                                                    img.src = photoUrl;
                                                    img.style.display = 'block';
                                                    if (img.nextElementSibling) {
                                                        img.nextElementSibling.style.display = 'none';
                                                    }
                                                    console.log(`‚úÖ Data URL photo loaded for ${candidate.id} (length: ${photoUrl.length})`);
                                                };
                                                testImg.onerror = function() {
                                                    console.warn(`‚ö†Ô∏è Invalid data URL for ${candidate.id}, using fallback`);
                                                    img.src = 'kandidat/kpulogo.jpg';
                                                };
                                                testImg.src = photoUrl;
                                            } else {
                                                // Regular URL
                                                img.src = photoUrl;
                                                img.style.display = 'block';
                                                if (img.nextElementSibling) {
                                                    img.nextElementSibling.style.display = 'none';
                                                }
                                                console.log(`‚úÖ Photo loaded for ${candidate.id}: ${photoUrl}`);
                                            }
                                        } catch (error) {
                                            console.warn(`‚ö†Ô∏è Failed to load photo for ${candidate.id}:`, error);
                                            img.src = 'kandidat/kpulogo.jpg'; // Fallback to default
                                            img.style.display = 'block';
                                            if (img.nextElementSibling) {
                                                img.nextElementSibling.style.display = 'none';
                                            }
                                        }
                                    }
                                }
                            });

                            console.log('‚úÖ Candidate photos loaded from database');
                            return;
                        }
                    } catch (error) {
                        console.error('‚ùå Error loading photos from database:', error);
                    }
                }

                // Fallback to localStorage
                const savedPhotos = localStorage.getItem('candidate_photos');
                if (savedPhotos) {
                    try {
                        const photoData = JSON.parse(savedPhotos);

                        Object.keys(photoData).forEach(id => {
                            const img = document.getElementById(id);
                            if (img && photoData[id]) {
                                // Handle data URLs safely
                                try {
                                    img.src = photoData[id];
                                    img.style.display = 'block';
                                    if (img.nextElementSibling) {
                                        img.nextElementSibling.style.display = 'none';
                                    }
                                } catch (error) {
                                    console.warn(`‚ö†Ô∏è Failed to load photo from localStorage for ${id}:`, error);
                                    img.src = 'kandidat/kpulogo.jpg'; // Fallback to default
                                }
                            }
                        });

                        console.log('üì± Candidate photos loaded from localStorage');
                    } catch (error) {
                        console.error('‚ùå Error loading candidate photos:', error);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error in loadCandidatePhotos:', error);
            }
        }

        // ========================================
        // CANDIDATE NAME MANAGEMENT
        // ========================================

        async function manageCandidateNames(category) {
            let candidates = [];

            // Get current names from UI (which should be loaded from database)
            if (category === 'presiden') {
                candidates = [
                    {
                        id: 'presiden1-name',
                        name: document.getElementById('presiden1-name')?.textContent || 'Ahmad Rizki & Sari Indah',
                        label: 'Pasangan 01'
                    },
                    {
                        id: 'presiden2-name',
                        name: document.getElementById('presiden2-name')?.textContent || 'Budi Santoso & Maya Putri',
                        label: 'Pasangan 02'
                    }
                ];
            } else if (category === 'pm') {
                candidates = [
                    {
                        id: 'pm1-name',
                        name: document.getElementById('pm1-name')?.textContent || 'Dr. Andi Wijaya',
                        label: 'Kandidat PM 01'
                    },
                    {
                        id: 'pm2-name',
                        name: document.getElementById('pm2-name')?.textContent || 'Prof. Lisa Sari',
                        label: 'Kandidat PM 02'
                    }
                ];
            } else if (category === 'parlemen') {
                candidates = [
                    {
                        id: 'parlemen1-name',
                        name: document.getElementById('parlemen1-name')?.textContent || 'Rudi Hartono',
                        label: 'KP 01'
                    },
                    {
                        id: 'parlemen2-name',
                        name: document.getElementById('parlemen2-name')?.textContent || 'Nina Kusuma',
                        label: 'KP 02'
                    },
                    {
                        id: 'parlemen3-name',
                        name: document.getElementById('parlemen3-name')?.textContent || 'Dedi Prasetyo',
                        label: 'KP 03'
                    },
                    {
                        id: 'parlemen4-name',
                        name: document.getElementById('parlemen4-name')?.textContent || 'Sinta Dewi',
                        label: 'KP 04'
                    }
                ];
            }

            // Create modal for name management
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-96 overflow-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">‚úèÔ∏è Edit Nama ${category === 'presiden' ? 'Presiden' : category === 'pm' ? 'PM' : 'Ketua Parlemen'}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                    </div>

                    <div class="space-y-4">
                        ${candidates.map(candidate => `
                            <div class="border rounded-lg p-4">
                                <div class="mb-3">
                                    <h4 class="font-medium text-gray-900">${candidate.label}</h4>
                                    <p class="text-sm text-gray-500">Nama saat ini: ${candidate.name}</p>
                                </div>

                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-700">Nama Baru:</label>
                                    <input type="text" value="${candidate.name}" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" id="new-${candidate.id}" placeholder="Masukkan nama baru">

                                    <div class="flex gap-2 mt-2">
                                        <button onclick="updateCandidateName('${candidate.id}')" class="bg-green-500 text-white px-3 py-1 rounded text-sm">‚úÖ Update</button>
                                        <button onclick="resetCandidateName('${candidate.id}', '${candidate.name}')" class="bg-gray-500 text-white px-3 py-1 rounded text-sm">üîÑ Reset</button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="mt-6 flex gap-3">
                        <button onclick="saveAllNames()" class="bg-green-600 text-white px-4 py-2 rounded-lg">üíæ Simpan Semua</button>
                        <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 text-white px-4 py-2 rounded-lg">Batal</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        async function updateCandidateName(candidateId) {
            try {
                const newNameInput = document.getElementById(`new-${candidateId}`);
                const newName = newNameInput.value.trim();

                if (!newName) {
                    alert('‚ùå Nama tidak boleh kosong!');
                    return;
                }

                console.log(`‚úèÔ∏è Updating candidate name: ${candidateId} ‚Üí ${newName}`);

                // Update in UI first
                const nameElement = document.getElementById(candidateId);
                if (nameElement) {
                    nameElement.textContent = newName;
                }

                // Map element ID to candidate ID
                const candidateMapping = {
                    'presiden1-name': 'presiden1',
                    'presiden2-name': 'presiden2',
                    'pm1-name': 'pm1',
                    'pm2-name': 'pm2',
                    'parlemen1-name': 'parlemen1',
                    'parlemen2-name': 'parlemen2',
                    'parlemen3-name': 'parlemen3',
                    'parlemen4-name': 'parlemen4'
                };

                const actualCandidateId = candidateMapping[candidateId] || candidateId;

                // Sync to database if online
                if (isAdminOnline && window.kpuDB) {
                    try {
                        await window.kpuDB.apiCall('update_candidate', 'PUT', {
                            id: actualCandidateId,
                            name: newName
                        });
                        console.log(`‚úÖ Name synced to database for ${actualCandidateId}: ${newName}`);
                    } catch (error) {
                        console.error(`‚ùå Failed to sync name to database for ${actualCandidateId}:`, error);
                    }
                }

                // Update localStorage
                const savedNames = JSON.parse(localStorage.getItem('candidate_names') || '{}');
                savedNames[candidateId] = newName;
                localStorage.setItem('candidate_names', JSON.stringify(savedNames));

                // Log activity
                logActivity('ADMIN', 'Update nama kandidat', `Updated ${actualCandidateId}: ${newName}`);

                alert('‚úÖ Nama berhasil diupdate!');

                // Trigger real-time sync
                if (window.dataSync) {
                    window.dataSync.syncCandidates();
                }

            } catch (error) {
                console.error('‚ùå Error updating candidate name:', error);
                alert('‚ùå Gagal mengupdate nama. Silakan coba lagi.');
            }
        }

        function resetCandidateName(candidateId, originalName) {
            const newNameInput = document.getElementById(`new-${candidateId}`);
            newNameInput.value = originalName;

            // Update in UI
            const nameElement = document.getElementById(candidateId);
            if (nameElement) {
                nameElement.textContent = originalName;
            }

            alert('‚úÖ Nama direset ke default!');
        }

        async function saveAllNames() {
            try {
                console.log('‚úèÔ∏è Saving all candidate names...');

                // Collect current names
                const nameData = {};
                const candidateUpdates = [];

                const nameMappings = {
                    'presiden1-name': { id: 'presiden1', category: 'presiden' },
                    'presiden2-name': { id: 'presiden2', category: 'presiden' },
                    'pm1-name': { id: 'pm1', category: 'pm' },
                    'pm2-name': { id: 'pm2', category: 'pm' },
                    'parlemen1-name': { id: 'parlemen1', category: 'parlemen' },
                    'parlemen2-name': { id: 'parlemen2', category: 'parlemen' },
                    'parlemen3-name': { id: 'parlemen3', category: 'parlemen' },
                    'parlemen4-name': { id: 'parlemen4', category: 'parlemen' }
                };

                Object.keys(nameMappings).forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        const candidateInfo = nameMappings[elementId];
                        const newName = element.textContent.trim();
                        nameData[elementId] = newName;

                        candidateUpdates.push({
                            id: candidateInfo.id,
                            name: newName,
                            category: candidateInfo.category
                        });
                    }
                });

                // Save to localStorage first
                localStorage.setItem('candidate_names', JSON.stringify(nameData));

                // Sync to database if online
                if (isAdminOnline && window.kpuDB) {
                    console.log('üåê Syncing names to database...');

                    for (const update of candidateUpdates) {
                        try {
                            await window.kpuDB.apiCall('update_candidate', 'PUT', {
                                id: update.id,
                                name: update.name
                            });
                            console.log(`‚úÖ Name updated for ${update.id}: ${update.name}`);
                        } catch (error) {
                            console.error(`‚ùå Failed to update name for ${update.id}:`, error);
                        }
                    }

                    console.log('‚úÖ All names synced to database');
                } else {
                    console.log('üì± Names saved to localStorage (database offline)');
                }

                // Log activity
                logActivity('ADMIN', 'Update nama kandidat', `Updated ${candidateUpdates.length} candidate names`);

                alert('‚úÖ Semua nama kandidat berhasil disimpan!');

                // Close modal
                document.querySelector('.fixed').remove();

                // Trigger real-time sync
                if (window.dataSync) {
                    window.dataSync.syncCandidates();
                }

            } catch (error) {
                console.error('‚ùå Error saving names:', error);
                alert('‚ùå Gagal menyimpan nama. Silakan coba lagi.');
            }
        }

        async function loadCandidateNames() {
            try {
                console.log('‚úèÔ∏è Loading candidate names...');

                // Try to load from database first if online
                if (isAdminOnline && window.kpuDB) {
                    try {
                        const candidates = await window.kpuDB.apiCall('get_candidates');
                        if (candidates && candidates.length > 0) {
                            console.log('üåê Loading names from database...');

                            const nameMappings = {
                                'presiden1': 'presiden1-name',
                                'presiden2': 'presiden2-name',
                                'pm1': 'pm1-name',
                                'pm2': 'pm2-name',
                                'parlemen1': 'parlemen1-name',
                                'parlemen2': 'parlemen2-name',
                                'parlemen3': 'parlemen3-name',
                                'parlemen4': 'parlemen4-name'
                            };

                            candidates.forEach(candidate => {
                                const elementId = nameMappings[candidate.id];
                                if (elementId && candidate.name) {
                                    const element = document.getElementById(elementId);
                                    if (element) {
                                        element.textContent = candidate.name;
                                        console.log(`‚úÖ Name loaded for ${candidate.id}: ${candidate.name}`);
                                    }
                                }
                            });

                            console.log('‚úÖ Candidate names loaded from database');
                            return;
                        }
                    } catch (error) {
                        console.error('‚ùå Error loading names from database:', error);
                    }
                }

                // Fallback to localStorage
                const savedNames = localStorage.getItem('candidate_names');
                if (savedNames) {
                    try {
                        const nameData = JSON.parse(savedNames);

                        Object.keys(nameData).forEach(id => {
                            const element = document.getElementById(id);
                            if (element && nameData[id]) {
                                element.textContent = nameData[id];
                            }
                        });

                        console.log('üì± Candidate names loaded from localStorage');
                    } catch (error) {
                        console.error('‚ùå Error loading candidate names:', error);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error in loadCandidateNames:', error);
            }
        }

        // ========================================
        // REAL-TIME DATABASE INTEGRATION
        // ========================================

        let realTimeInterval;
        let isAdminOnline = false;

        async function initializeAdminPanel() {
            try {
                console.log('üöÄ Initializing admin panel...');

                // Update indicator to loading
                updateRealtimeIndicator('loading');

                // Check database connection
                if (window.kpuDB) {
                    console.log('üîç Checking database connection...');
                    isAdminOnline = await window.kpuDB.checkConnection();
                    console.log(isAdminOnline ? 'üåê Admin: Online mode' : 'üíæ Admin: Offline mode');
                } else {
                    console.log('‚ùå Database integration not loaded');
                    isAdminOnline = false;
                }

                // Update realtime indicator
                updateRealtimeIndicator();

                // Load real-time data
                console.log('üìä Loading real-time data...');
                await loadRealTimeResults();
                await loadDashboardStats();

                // Load candidate data after database connection is established
                console.log('üì∑ Loading candidate data...');
                await loadCandidatePhotos();
                await loadCandidateNames();
                console.log('‚úÖ Candidate data loaded');

                // Start real-time updates
                if (isAdminOnline) {
                    startRealTimeUpdates();
                } else {
                    console.log('üì± Using localStorage mode');
                }

                console.log('‚úÖ Admin panel initialized successfully');
            } catch (error) {
                console.error('‚ùå Admin panel initialization error:', error);
                // Fallback to localStorage
                isAdminOnline = false;
                updateRealtimeIndicator();
                loadLocalResults();
            }
        }

        function updateRealtimeIndicator(status = null) {
            const indicator = document.getElementById('realtimeIndicator');
            if (!indicator) return;

            const currentStatus = status || (isAdminOnline ? 'online' : 'offline');

            switch (currentStatus) {
                case 'loading':
                    indicator.innerHTML = `
                        <div class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></div>
                        <span class="text-xs text-yellow-600 font-medium">CHECKING...</span>
                    `;
                    break;
                case 'online':
                    indicator.innerHTML = `
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-xs text-green-600 font-medium">REALTIME</span>
                    `;
                    break;
                case 'offline':
                default:
                    indicator.innerHTML = `
                        <div class="w-2 h-2 bg-orange-500 rounded-full"></div>
                        <span class="text-xs text-orange-600 font-medium">OFFLINE</span>
                    `;
                    break;
            }

            console.log(`üö¶ Indicator updated: ${currentStatus.toUpperCase()}`);
        }

        async function loadRealTimeResults() {
            try {
                console.log('üìä Loading real-time results...');

                if (isAdminOnline && window.kpuDB) {
                    console.log('üåê Loading from database...');
                    const results = await window.kpuDB.getVoteResults();
                    console.log('üìä Database results:', results);

                    // Check if database has vote data
                    if (results && results.length > 0) {
                        console.log('‚úÖ Using database results');
                        updateResultsDisplay(results);
                        console.log('‚úÖ Real-time results loaded from database');
                    } else {
                        console.log('‚ö†Ô∏è Database empty, falling back to localStorage...');
                        loadLocalResults();
                    }
                } else {
                    console.log('üíæ Loading from localStorage...');
                    loadLocalResults();
                }
            } catch (error) {
                console.error('‚ùå Error loading real-time results:', error);
                console.log('üîÑ Falling back to localStorage...');
                loadLocalResults();
            }
        }

        function updateResultsDisplay(results) {
            console.log('üîÑ Updating results display with data:', results);

            // Initialize all candidates with 0 votes first
            const allCandidates = [
                'presiden1', 'presiden2', 'pm1', 'pm2',
                'parlemen1', 'parlemen2', 'parlemen3', 'parlemen4'
            ];

            allCandidates.forEach(candidateId => {
                const votesElement = document.getElementById(`${candidateId}-votes`);
                const percentageElement = document.getElementById(`${candidateId}-percentage`);
                const barElement = document.getElementById(`${candidateId}-bar`);

                if (votesElement) votesElement.textContent = '0 suara';
                if (percentageElement) percentageElement.textContent = '0%';
                if (barElement) barElement.style.width = '0%';
            });

            console.log('üîÑ Processing results array:', results);

            if (!results || results.length === 0) {
                console.log('üìä No results to display');
                return;
            }

            // Calculate totals for each category
            const categoryTotals = {
                presiden: 0,
                pm: 0,
                parlemen: 0
            };

            // Calculate totals
            results.forEach(result => {
                if (result.category && result.total_votes) {
                    categoryTotals[result.category] += parseInt(result.total_votes) || 0;
                }
            });

            console.log('üìä Category totals:', categoryTotals);

            // Update each candidate
            results.forEach(result => {
                const candidateId = result.candidate_id;
                const votes = parseInt(result.total_votes) || 0;
                const categoryTotal = categoryTotals[result.category] || 0;
                const percentage = categoryTotal > 0 ? Math.round((votes / categoryTotal) * 100) : 0;

                console.log(`üìä Updating ${candidateId}: ${votes} votes, ${percentage}%`);

                // Update votes
                const votesElement = document.getElementById(`${candidateId}-votes`);
                if (votesElement) {
                    votesElement.textContent = `${votes.toLocaleString()} suara`;
                }

                // Update percentage
                const percentageElement = document.getElementById(`${candidateId}-percentage`);
                if (percentageElement) {
                    percentageElement.textContent = `${percentage}%`;
                }

                // Update progress bar
                const barElement = document.getElementById(`${candidateId}-bar`);
                if (barElement) {
                    barElement.style.width = `${percentage}%`;
                }

                // Update candidate name if available
                const nameElement = document.getElementById(`${candidateId}-name`);
                if (nameElement && result.candidate_name) {
                    nameElement.textContent = result.candidate_name;
                }
            });

            console.log('‚úÖ Results display updated successfully');
        }

        function loadLocalResults() {
            // Fallback to localStorage data
            const votes = JSON.parse(localStorage.getItem('kpu_votes') || '[]');
            const localResults = calculateLocalResults(votes);
            updateResultsDisplay(localResults);
            console.log('üì± Using local results');
        }

        function calculateLocalResults(votes) {
            console.log('üîÑ Calculating local results from votes:', votes);

            const results = {};

            // Initialize all candidates - UPDATED WITH CORRECT NAMES
            const candidateMapping = {
                'presiden1': { category: 'presiden', name: 'NENENG & INAYAH' },
                'presiden2': { category: 'presiden', name: 'AISYAH & EVI' },
                'pm1': { category: 'pm', name: 'KUKUH' },
                'pm2': { category: 'pm', name: 'SAYYIDAH' },
                'parlemen1': { category: 'parlemen', name: 'ADINUR KHOLIFAH' },
                'parlemen2': { category: 'parlemen', name: 'ENI FATMAWATI' },
                'parlemen3': { category: 'parlemen', name: 'FAIZAH MAULIDA' },
                'parlemen4': { category: 'parlemen', name: 'AHMAD NASHUKA' }
            };

            // Initialize all candidates with 0 votes
            Object.keys(candidateMapping).forEach(candidateId => {
                results[candidateId] = {
                    candidate_id: candidateId,
                    candidate_name: candidateMapping[candidateId].name,
                    total_votes: 0,
                    category: candidateMapping[candidateId].category
                };
            });

            // Count votes from localStorage
            votes.forEach(vote => {
                if (vote.votes && Array.isArray(vote.votes)) {
                    vote.votes.forEach(v => {
                        if (v.candidate_id && results[v.candidate_id]) {
                            results[v.candidate_id].total_votes += parseInt(v.count) || 0;
                        }
                    });
                }
            });

            const resultArray = Object.values(results);
            console.log('üìä Local results calculated:', resultArray);
            return resultArray;
        }

        async function loadDashboardStats() {
            try {
                console.log('üìà Loading dashboard statistics...');

                if (isAdminOnline && window.kpuDB) {
                    console.log('üåê Loading stats from database...');
                    const stats = await window.kpuDB.getStatistics();
                    console.log('üìà Database stats:', stats);
                    updateDashboardStats(stats);
                    console.log('‚úÖ Dashboard stats loaded from database');
                } else {
                    console.log('üíæ Loading stats from localStorage...');
                    updateLocalStats();
                }
            } catch (error) {
                console.error('‚ùå Error loading dashboard stats:', error);
                console.log('üîÑ Falling back to localStorage stats...');
                updateLocalStats();
            }
        }

        function updateDashboardStats(stats) {
            // Update total voters
            const totalVotersElement = document.getElementById('total-voters');
            if (totalVotersElement && stats.total_users) {
                totalVotersElement.textContent = stats.total_users.toLocaleString();
            }

            // Update total votes
            const totalVotesElement = document.getElementById('total-votes');
            if (totalVotesElement && stats.total_votes) {
                totalVotesElement.textContent = stats.total_votes.toLocaleString();
            }

            // Update participation rate
            const participationElement = document.getElementById('participation-rate');
            if (participationElement && stats.participation_rate) {
                participationElement.textContent = `${stats.participation_rate}%`;
            }

            // Update total candidates (always 8)
            const candidatesElement = document.getElementById('total-candidates');
            if (candidatesElement) {
                candidatesElement.textContent = '8';
            }
        }

        function updateLocalStats() {
            // Calculate from localStorage
            const users = JSON.parse(localStorage.getItem('kpu_users') || '[]');
            const votes = JSON.parse(localStorage.getItem('kpu_votes') || '[]');

            const totalUsers = users.length;
            const votedUsers = votes.length;
            const totalVotes = votes.reduce((sum, vote) => {
                return sum + (vote.votes ? vote.votes.reduce((voteSum, v) => voteSum + v.count, 0) : 0);
            }, 0);
            const participationRate = totalUsers > 0 ? Math.round((votedUsers / totalUsers) * 100) : 0;

            updateDashboardStats({
                total_users: totalUsers,
                total_votes: totalVotes,
                participation_rate: participationRate
            });
        }

        function startRealTimeUpdates() {
            // Clear any existing interval first
            if (realTimeInterval) {
                clearInterval(realTimeInterval);
            }

            console.log('‚è∞ Starting real-time updates (every 5 seconds)...');

            // Update every 5 seconds
            realTimeInterval = setInterval(async () => {
                try {
                    console.log('üîÑ Real-time update cycle...');

                    if (window.kpuDB && window.kpuDB.isOnline) {
                        console.log('üåê Updating from database...');
                        await loadRealTimeResults();
                        await loadDashboardStats();

                        // Force refresh voting data section
                        await loadVotingData();

                        // Auto-sync disabled - use manual sync instead
                        // await window.kpuDB.syncPendingData();

                        // Refresh candidate data every 30 seconds (every 6th cycle)
                        if (Math.floor(Date.now() / 1000) % 30 === 0) {
                            console.log('üîÑ Refreshing candidate data...');
                            await loadCandidatePhotos();
                            await loadCandidateNames();
                        }
                    } else {
                        // Check if connection is restored
                        isAdminOnline = await window.kpuDB.checkConnection();
                        updateRealtimeIndicator();

                        // If connection restored, reload candidate data
                        if (isAdminOnline) {
                            console.log('üåê Connection restored - reloading candidate data...');
                            await loadCandidatePhotos();
                            await loadCandidateNames();
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Real-time update error:', error);
                }
            }, 5000);

            console.log('üîÑ Real-time updates started (5s interval)');
        }

        function stopRealTimeUpdates() {
            if (realTimeInterval) {
                clearInterval(realTimeInterval);
                realTimeInterval = null;
                console.log('‚èπÔ∏è Real-time updates stopped');
            }
        }

        // Remove duplicate functions - using the corrected ones above

        // Initialize election status on page load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Admin panel DOM loaded - starting initialization...');

            try {
                // üîí SECURITY: Check admin session first
                if (!checkAdminSession()) {
                    alert('Akses ditolak! Silakan login sebagai admin terlebih dahulu.');
                    window.location.href = 'admin-login.html';
                    return;
                }

                // Initialize admin panel with database integration
                await initializeAdminPanel();

                // Initialize existing functions
                updateElectionStatusDisplay();
                initializeBulkInputTable(); // Initialize bulk input table

                // üîÑ ENHANCED FORCE INITIAL DATA LOAD - This ensures all data shows immediately
                console.log('üîÑ Force loading initial data with voting data...');

                // üî• NEW: Pre-load voting data to ensure it's available for user status detection
                console.log('üó≥Ô∏è Pre-loading voting data...');
                if (isAdminOnline && window.kpuDB) {
                    try {
                        const allVoteResults = await window.kpuDB.getVoteResults();
                        console.log('‚úÖ Pre-loaded vote results from database:', allVoteResults.length, 'records');

                        // Cache vote results for faster user table loading
                        window.cachedVoteResults = allVoteResults;
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Could not pre-load vote results:', error.message);
                    }
                }

                await loadRealTimeResults(); // Force load vote results
                await loadDashboardStats(); // Force load statistics

                // Load candidate data from database/localStorage
                console.log('üì∑ Loading candidate photos and names...');
                await loadCandidatePhotos(); // Load saved candidate photos
                await loadCandidateNames(); // Load saved candidate names
                console.log('‚úÖ Candidate data loaded');

                // üî• ENHANCED: Load users table with pre-loaded voting data
                await loadUsersTable(); // Load users table with database integration and voting data

                // üîÑ MANUAL REFRESH TO ENSURE DATA VISIBILITY
                console.log('üîÑ Performing manual refresh to ensure data visibility...');
                refreshData(); // This is the same function as "Refresh Data" button

                // Add test buttons for development (disabled by default)
                // setTimeout(() => {
                //     addTestButtons();
                // }, 1000);

                console.log('‚úÖ Admin panel initialization complete with forced data load');

            } catch (error) {
                console.error('‚ùå Error during admin panel initialization:', error);
            }

            // Handle page visibility change for sync
            document.addEventListener('visibilitychange', async function() {
                if (!document.hidden && isAdminOnline) {
                    console.log('üëÅÔ∏è Admin panel visible again - refreshing data...');
                    // Refresh data when admin returns to tab
                    await loadRealTimeResults();
                    await loadDashboardStats();
                    await loadCandidatePhotos(); // Refresh candidate photos
                    await loadCandidateNames(); // Refresh candidate names
                }
            });
        });

        // ========================================
        // MANUAL SYNC CONTROL FUNCTIONS
        // ========================================

        // Show sync data modal
        async function showSyncDataModal() {
            try {
                console.log('üîÑ Opening manual sync modal...');

                // Load data info
                await loadSyncDataInfo();

                // Show modal
                document.getElementById('syncDataModal').classList.remove('hidden');
            } catch (error) {
                console.error('‚ùå Error opening sync modal:', error);
                alert('‚ùå Error opening sync modal. Check console for details.');
            }
        }

        // Close sync data modal
        function closeSyncDataModal() {
            document.getElementById('syncDataModal').classList.add('hidden');
        }

        // Load sync data info
        async function loadSyncDataInfo() {
            try {
                console.log('üìä Loading sync data info...');

                // Get local data
                const localUsers = getUsers();
                const localVotes = JSON.parse(localStorage.getItem('kpu_votes') || '[]');
                const localElectionStatus = localStorage.getItem('election_status') || 'stopped';

                // Get cloud data
                let cloudUsers = [];
                let cloudVotes = [];
                let cloudElectionStatus = 'stopped';

                if (isAdminOnline && window.kpuDB) {
                    try {
                        cloudUsers = await window.kpuDB.getUsers();
                        cloudVotes = await window.kpuDB.getVoteResults();
                        const electionStatus = await window.kpuDB.getElectionStatus();
                        cloudElectionStatus = electionStatus.status || 'stopped';
                    } catch (error) {
                        console.error('‚ùå Failed to get cloud data:', error);
                    }
                }

                // Update UI
                document.getElementById('localUsersCount').textContent = localUsers.length;
                document.getElementById('localVotesCount').textContent = localVotes.length;
                document.getElementById('localStatus').textContent = localElectionStatus;

                document.getElementById('cloudUsersCount').textContent = cloudUsers.length;
                document.getElementById('cloudVotesCount').textContent = cloudVotes.length;
                document.getElementById('cloudStatus').textContent = cloudElectionStatus;

                console.log('üìä Sync data info loaded:');
                console.log(`üì± Local: ${localUsers.length} users, ${localVotes.length} votes, status: ${localElectionStatus}`);
                console.log(`üåê Cloud: ${cloudUsers.length} users, ${cloudVotes.length} votes, status: ${cloudElectionStatus}`);

            } catch (error) {
                console.error('‚ùå Error loading sync data info:', error);
            }
        }

        // Sync Local ‚Üí Cloud (Upload localStorage to Database)
        async function syncLocalToCloud() {
            if (!confirm('üì§ SYNC LOCAL ‚Üí CLOUD (FORCE OVERWRITE)\n\nIni akan:\n‚Ä¢ HAPUS PAKSA semua data di database\n‚Ä¢ Upload semua data localStorage ke database\n‚Ä¢ Data cloud akan DIGANTI TOTAL dengan data lokal\n‚Ä¢ Jika lokal kosong, cloud akan dikosongkan\n\nLanjutkan?')) {
                return;
            }

            try {
                console.log('üì§ Starting Local ‚Üí Cloud FORCE OVERWRITE sync...');

                if (!isAdminOnline || !window.kpuDB) {
                    alert('‚ùå Database tidak tersedia. Pastikan koneksi database aktif.');
                    return;
                }

                // Get local data
                const localUsers = getUsers();
                const localVotes = JSON.parse(localStorage.getItem('kpu_votes') || '[]');
                const localElectionStatus = localStorage.getItem('election_status') || 'stopped';

                console.log(`üì± Local data to upload: ${localUsers.length} users, ${localVotes.length} votes`);

                // STEP 1: FORCE DELETE ALL CLOUD DATA
                console.log('üóëÔ∏è STEP 1: Force deleting ALL cloud data...');

                try {
                    // Get all cloud users first
                    const cloudUsers = await window.kpuDB.getUsers();
                    console.log(`üåê Found ${cloudUsers.length} users in cloud to delete`);

                    // Delete all cloud users (this will cascade delete votes and logs)
                    let deletedCount = 0;
                    for (const cloudUser of cloudUsers) {
                        try {
                            const deleteResult = await window.kpuDB.deleteUser(cloudUser.id);
                            if (deleteResult.success) {
                                deletedCount++;
                                console.log(`üóëÔ∏è Deleted cloud user: ${cloudUser.username}`);
                            }
                        } catch (error) {
                            console.error(`‚ùå Failed to delete cloud user ${cloudUser.username}:`, error);
                        }
                    }

                    // Reset all votes (additional cleanup)
                    try {
                        await window.kpuDB.resetAllVotes();
                        console.log('üó≥Ô∏è All cloud votes reset');
                    } catch (error) {
                        console.error('‚ùå Failed to reset cloud votes:', error);
                    }

                    console.log(`‚úÖ STEP 1 Complete: ${deletedCount} cloud users deleted`);
                } catch (error) {
                    console.error('‚ùå Failed to delete cloud data:', error);
                    if (!confirm('‚ö†Ô∏è Gagal menghapus data cloud. Lanjutkan upload data lokal?')) {
                        return;
                    }
                }

                // STEP 2: UPLOAD ALL LOCAL DATA
                console.log('üì§ STEP 2: Uploading ALL local data...');

                let successCount = 0;
                let failCount = 0;

                // 2.1. Upload users
                if (localUsers.length > 0) {
                    console.log(`üë• Uploading ${localUsers.length} users to cloud...`);
                    for (const user of localUsers) {
                        try {
                            await window.kpuDB.apiCall('add_user', 'POST', {
                                id: user.id,
                                name: user.name,
                                username: user.username,
                                password: user.password,
                                vote_count: user.vote_count || user.voteCount || 20,
                                verified: user.verified || false
                            });
                            successCount++;
                            console.log(`‚úÖ User ${user.username} uploaded to cloud`);
                        } catch (error) {
                            console.error(`‚ùå Failed to upload user ${user.username}:`, error);
                            failCount++;
                        }
                    }
                } else {
                    console.log('üì± No local users to upload - cloud will remain empty');
                }

                // 2.2. Upload votes
                if (localVotes.length > 0) {
                    console.log(`üó≥Ô∏è Uploading ${localVotes.length} votes to cloud...`);
                    for (const vote of localVotes) {
                        try {
                            await window.kpuDB.castVote(vote);
                            console.log(`‚úÖ Vote for ${vote.user_id} uploaded to cloud`);
                        } catch (error) {
                            console.error(`‚ùå Failed to upload vote for ${vote.user_id}:`, error);
                        }
                    }
                } else {
                    console.log('üì± No local votes to upload - cloud votes will remain empty');
                }

                // 2.3. Upload election status
                console.log(`‚öñÔ∏è Uploading election status: ${localElectionStatus}`);
                try {
                    await window.kpuDB.updateElectionStatus(localElectionStatus);
                    console.log(`‚úÖ Election status uploaded to cloud`);
                } catch (error) {
                    console.error(`‚ùå Failed to upload election status:`, error);
                }

                console.log('‚úÖ STEP 2 Complete: All local data uploaded');

                // Refresh data info
                await loadSyncDataInfo();
                await loadUsersTable();

                alert(`‚úÖ Local ‚Üí Cloud FORCE OVERWRITE completed!\n\nüóëÔ∏è Cloud data deleted\nüì§ ${successCount} users uploaded\n‚ùå ${failCount} users failed\nüó≥Ô∏è ${localVotes.length} votes uploaded\n‚öñÔ∏è Election status uploaded\n\nüéØ Cloud now matches Local exactly!`);
                console.log('‚úÖ Local ‚Üí Cloud FORCE OVERWRITE sync completed');

            } catch (error) {
                console.error('‚ùå Error during Local ‚Üí Cloud sync:', error);
                alert(`‚ùå Error during sync: ${error.message}`);
            }
        }

        // Sync Cloud ‚Üí Local (Download Database to localStorage)
        async function syncCloudToLocal() {
            if (!confirm('üì• SYNC CLOUD ‚Üí LOCAL (FORCE OVERWRITE)\n\nIni akan:\n‚Ä¢ HAPUS PAKSA semua data di localStorage\n‚Ä¢ Download semua data dari database\n‚Ä¢ Data lokal akan DIGANTI TOTAL dengan data cloud\n‚Ä¢ Jika cloud kosong, lokal akan dikosongkan\n\nLanjutkan?')) {
                return;
            }

            try {
                console.log('üì• Starting Cloud ‚Üí Local FORCE OVERWRITE sync...');

                if (!isAdminOnline || !window.kpuDB) {
                    alert('‚ùå Database tidak tersedia. Pastikan koneksi database aktif.');
                    return;
                }

                // STEP 1: FORCE DELETE ALL LOCAL DATA
                console.log('üóëÔ∏è STEP 1: Force deleting ALL local data...');

                const localUsers = getUsers();
                const localVotes = JSON.parse(localStorage.getItem('kpu_votes') || '[]');
                console.log(`üì± Found ${localUsers.length} local users and ${localVotes.length} local votes to delete`);

                // Clear all localStorage data
                localStorage.removeItem('kpu_users');
                localStorage.removeItem('kpu_votes');
                localStorage.removeItem('election_status');
                localStorage.removeItem('audit_log');

                console.log('‚úÖ STEP 1 Complete: All local data deleted');

                // STEP 2: DOWNLOAD ALL CLOUD DATA
                console.log('üì• STEP 2: Downloading ALL cloud data...');

                // Get cloud data
                const cloudUsers = await window.kpuDB.getUsers();
                const cloudVotes = await window.kpuDB.getVoteResults();
                const electionStatus = await window.kpuDB.getElectionStatus();

                console.log(`üåê Cloud data to download: ${cloudUsers.length} users, ${cloudVotes.length} votes`);

                // 2.1. Download users
                if (cloudUsers.length > 0) {
                    localStorage.setItem('kpu_users', JSON.stringify(cloudUsers));
                    console.log(`‚úÖ ${cloudUsers.length} users downloaded to localStorage`);
                } else {
                    localStorage.setItem('kpu_users', JSON.stringify([]));
                    console.log('üåê No cloud users to download - localStorage will remain empty');
                }

                // 2.2. Download votes (convert vote results back to vote format)
                if (cloudVotes.length > 0) {
                    const convertedVotes = cloudVotes.map(result => ({
                        user_id: result.user_id || 'unknown',
                        category: result.category,
                        votes: [{
                            candidate_id: result.candidate_id,
                            count: result.total_votes
                        }],
                        timestamp: new Date().toISOString(),
                        synced: true
                    }));
                    localStorage.setItem('kpu_votes', JSON.stringify(convertedVotes));
                    console.log(`‚úÖ ${convertedVotes.length} votes downloaded to localStorage`);
                } else {
                    localStorage.setItem('kpu_votes', JSON.stringify([]));
                    console.log('üåê No cloud votes to download - localStorage votes will remain empty');
                }

                // 2.3. Download election status
                const downloadedStatus = electionStatus.status || 'stopped';
                localStorage.setItem('election_status', downloadedStatus);
                console.log(`‚úÖ Election status downloaded: ${downloadedStatus}`);

                console.log('‚úÖ STEP 2 Complete: All cloud data downloaded');

                // Refresh data info
                await loadSyncDataInfo();
                await loadUsersTable();

                const finalUsers = JSON.parse(localStorage.getItem('kpu_users') || '[]');
                const finalVotes = JSON.parse(localStorage.getItem('kpu_votes') || '[]');

                alert(`‚úÖ Cloud ‚Üí Local FORCE OVERWRITE completed!\n\nüóëÔ∏è Local data deleted\nüì• ${finalUsers.length} users downloaded\nüó≥Ô∏è ${finalVotes.length} votes downloaded\n‚öñÔ∏è Election status: ${downloadedStatus}\n\nüéØ Local now matches Cloud exactly!`);
                console.log('‚úÖ Cloud ‚Üí Local FORCE OVERWRITE sync completed');

            } catch (error) {
                console.error('‚ùå Error during Cloud ‚Üí Local sync:', error);
                alert(`‚ùå Error during sync: ${error.message}`);
            }
        }

        // ========================================
        // TEST FUNCTIONS FOR REAL-TIME
        // ========================================

        // Clean up test users from localStorage
        function cleanupTestUsers() {
            try {
                console.log('üßπ Cleaning up test users...');

                const users = JSON.parse(localStorage.getItem('kpu_users') || '[]');
                const beforeCount = users.length;

                // Remove test users
                const cleanedUsers = users.filter(user => {
                    const isTestUser = user.id.startsWith('test') || user.username.startsWith('test_user');
                    if (isTestUser) {
                        console.log(`üóëÔ∏è Removing test user: ${user.id} (${user.username})`);
                    }
                    return !isTestUser;
                });

                localStorage.setItem('kpu_users', JSON.stringify(cleanedUsers));

                const afterCount = cleanedUsers.length;
                const removedCount = beforeCount - afterCount;

                console.log(`‚úÖ Cleanup complete: ${removedCount} test users removed`);

                if (removedCount > 0) {
                    loadUsersTable(); // Refresh table
                    alert(`‚úÖ ${removedCount} test users removed from localStorage`);
                } else {
                    alert('‚úÖ No test users found to remove');
                }
            } catch (error) {
                console.error('‚ùå Error cleaning up test users:', error);
                alert('‚ùå Error cleaning up test users');
            }
        }

        async function ensureTestUsersExist() {
            try {
                console.log('üë• Ensuring test users exist...');

                if (isAdminOnline && window.kpuDB) {
                    // Check database for test users
                    const dbUsers = await window.kpuDB.getUsers();
                    const testUsersInDB = dbUsers.filter(user => user.username.startsWith('test_user'));

                    if (testUsersInDB.length < 2) {
                        console.log('‚ö†Ô∏è Test users not found in database (auto-creation disabled)');
                        console.log('üí° Use "Add Test Users" button if needed');
                    } else {
                        console.log('‚úÖ Test users already exist in database');
                    }
                } else {
                    // Check localStorage for test users
                    const localUsers = getUsers();
                    const testUsersLocal = localUsers.filter(user => user.username.startsWith('test_user'));

                    if (testUsersLocal.length < 2) {
                        console.log('‚ö†Ô∏è Test users not found in localStorage (auto-creation disabled)');
                        console.log('üí° Use "Add Test Users" button if needed');
                    } else {
                        console.log('‚úÖ Test users already exist in localStorage');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error ensuring test users exist:', error);
            }
        }

        async function createTestUsers() {
            try {
                console.log('üë§ Creating test users...');

                const testUsers = [
                    {
                        id: 'test001',
                        name: 'Test User 1',
                        username: 'test_user_1',
                        password: 'test123',
                        vote_count: 20,
                        voteCount: 20,
                        status: 'Belum Voting',
                        verified: true,
                        registeredAt: new Date().toISOString(),
                        lastLogin: null
                    },
                    {
                        id: 'test002',
                        name: 'Test User 2',
                        username: 'test_user_2',
                        password: 'test123',
                        vote_count: 20,
                        voteCount: 20,
                        status: 'Belum Voting',
                        verified: true,
                        registeredAt: new Date().toISOString(),
                        lastLogin: null
                    }
                ];

                if (isAdminOnline && window.kpuDB) {
                    // Add to database
                    for (const user of testUsers) {
                        try {
                            await window.kpuDB.apiCall('add_user', 'POST', {
                                id: user.id,
                                name: user.name,
                                username: user.username,
                                password: user.password,
                                vote_count: user.vote_count,
                                verified: user.verified
                            });
                            console.log(`‚úÖ Test user ${user.username} added to database`);
                        } catch (error) {
                            console.error(`‚ùå Failed to add test user ${user.username} to database:`, error);
                        }
                    }
                }

                // Also add to localStorage
                const existingUsers = getUsers();
                const usersToAdd = testUsers.filter(testUser =>
                    !existingUsers.some(existing => existing.id === testUser.id)
                );

                if (usersToAdd.length > 0) {
                    existingUsers.push(...usersToAdd);
                    saveUsers(existingUsers);
                    console.log(`‚úÖ ${usersToAdd.length} test users added to localStorage`);
                }

                // Refresh users table
                await loadUsersTable();

            } catch (error) {
                console.error('‚ùå Error creating test users:', error);
            }
        }

        async function addTestVote() {
            try {
                console.log('üß™ Adding test votes...');

                // First, ensure we have test users in the system
                await ensureTestUsersExist();

                // Get existing users to use their IDs
                const users = getUsers();
                const testUsers = users.filter(user => user.username.startsWith('test_user') || user.id.startsWith('test'));

                if (testUsers.length === 0) {
                    console.log('‚ö†Ô∏è No test users found, creating some...');
                    await createTestUsers();
                    // Reload users after creating
                    const updatedUsers = getUsers();
                    testUsers.push(...updatedUsers.filter(user => user.username.startsWith('test_user')));
                }

                // Use existing test user IDs for votes
                const testVotes = [
                    {
                        user_id: testUsers[0]?.id || 'test001',
                        category: 'presiden',
                        votes: [
                            { candidate_id: 'presiden1', count: Math.floor(Math.random() * 10) + 1 },
                            { candidate_id: 'presiden2', count: Math.floor(Math.random() * 10) + 1 }
                        ],
                        timestamp: new Date().toISOString(),
                        synced: false
                    },
                    {
                        user_id: testUsers[1]?.id || 'test002',
                        category: 'pm',
                        votes: [
                            { candidate_id: 'pm1', count: Math.floor(Math.random() * 8) + 1 },
                            { candidate_id: 'pm2', count: Math.floor(Math.random() * 8) + 1 }
                        ],
                        timestamp: new Date().toISOString(),
                        synced: false
                    }
                ];

                if (isAdminOnline && window.kpuDB) {
                    console.log('üåê Adding test votes to database...');
                    // Add to database
                    for (const vote of testVotes) {
                        try {
                            await window.kpuDB.castVote(vote);
                            console.log(`‚úÖ Test vote added to database for ${vote.user_id}`);
                        } catch (error) {
                            console.error(`‚ùå Failed to add test vote to database:`, error);
                        }
                    }
                } else {
                    console.log('üíæ Adding test votes to localStorage...');
                    // Add to localStorage
                    const existingVotes = JSON.parse(localStorage.getItem('kpu_votes') || '[]');
                    existingVotes.push(...testVotes);
                    localStorage.setItem('kpu_votes', JSON.stringify(existingVotes));
                }

                // Immediately update display
                await loadRealTimeResults();
                await loadDashboardStats();

                console.log('üß™ Test votes added:', testVotes);
                alert('‚úÖ Test votes added! Check the real-time results.');

                // Log activity
                await logActivity('ADMIN', `Added ${testVotes.length} test votes`, 'test');
            } catch (error) {
                console.error('‚ùå Error adding test votes:', error);
                alert('‚ùå Error adding test votes. Check console for details.');
            }
        }

        // Clear all test votes (same API as clearAllVotes for consistency)
        async function clearAllTestVotes() {
            if (confirm('‚ö†Ô∏è Clear all votes? This will reset all voting data.')) {
                try {
                    console.log('üóëÔ∏è Clearing all test votes...');

                    if (isAdminOnline && window.kpuDB) {
                        console.log('üåê Clearing votes from database using reset_all_votes API...');
                        try {
                            const result = await window.kpuDB.resetAllVotes();
                            console.log('‚úÖ All votes cleared from database:', result);

                            // Sync localStorage with API reset
                            localStorage.removeItem('kpu_votes');
                            localStorage.setItem(STORAGE_KEYS.VOTES, JSON.stringify([]));

                            // Reset users status in localStorage
                            const users = JSON.parse(localStorage.getItem('kpu_users') || '[]');
                            users.forEach(user => {
                                user.status = 'Belum Voting';
                                user.lastLogin = null;
                            });
                            localStorage.setItem('kpu_users', JSON.stringify(users));

                            console.log('‚úÖ Local data synced with API reset');
                        } catch (error) {
                            console.error('‚ùå Failed to clear votes from database:', error);
                            console.log('üì± Falling back to localStorage only...');

                            // Fallback to localStorage only
                            localStorage.removeItem('kpu_votes');
                            localStorage.setItem(STORAGE_KEYS.VOTES, JSON.stringify([]));

                            // Reset users status
                            const users = JSON.parse(localStorage.getItem('kpu_users') || '[]');
                            users.forEach(user => {
                                user.status = 'Belum Voting';
                                user.lastLogin = null;
                            });
                            localStorage.setItem('kpu_users', JSON.stringify(users));
                        }
                    } else {
                        console.log('üì± API offline, clearing votes from localStorage only...');
                        localStorage.removeItem('kpu_votes');
                        localStorage.setItem(STORAGE_KEYS.VOTES, JSON.stringify([]));

                        // Reset users status
                        const users = JSON.parse(localStorage.getItem('kpu_users') || '[]');
                        users.forEach(user => {
                            user.status = 'Belum Voting';
                            user.lastLogin = null;
                        });
                        localStorage.setItem('kpu_users', JSON.stringify(users));
                    }

                    // Update display
                    await loadRealTimeResults();
                    await loadDashboardStats();
                    await loadUsersTable();
                    loadVotingData();
                    updateStatistics();

                    console.log('üóëÔ∏è All test votes cleared successfully');
                    alert('‚úÖ All votes cleared! Results reset to 0.');

                    // Log activity
                    await logActivity('ADMIN', 'Cleared all test votes', 'reset');
                } catch (error) {
                    console.error('‚ùå Error clearing test votes:', error);
                    alert('‚ùå Error clearing votes. Check console for details.');
                }
            }
        }

        // Add test buttons to admin panel (for development)
        function addTestButtons() {
            const testButtonsHtml = `
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                    <h3 class="text-sm font-medium text-yellow-800 mb-2">üß™ Test Functions (Development)</h3>
                    <div class="flex gap-2">
                        <button onclick="addTestVote()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                            Add Test Votes
                        </button>
                        <button onclick="clearAllTestVotes()" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                            Clear All Votes
                        </button>
                        <button onclick="loadRealTimeResults()" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                            Refresh Results
                        </button>
                    </div>
                </div>
            `;

            const resultsSection = document.querySelector('.bg-white.rounded-lg.shadow-sm.border.border-gray-200.mb-8');
            if (resultsSection) {
                resultsSection.insertAdjacentHTML('beforebegin', testButtonsHtml);
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            stopRealTimeUpdates();
        });
    </script>
</body>
</html>
